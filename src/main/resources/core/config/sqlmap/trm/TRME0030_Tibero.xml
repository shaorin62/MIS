<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"                  
		"http://ibatis.apache.org/dtd/sql-map-2.dtd">
		
<sqlMap namespace="TRME0030">
<!--
/* ******************************************************************************
     작  성  자 : 김준수
     작  성  일 : 2016.06.27
     내      용 : 조회[카드청구내역관리]
******************************************************************************* */
 -->
    <select id="TRME0030.SEARCH00" parameterClass="hashmap" resultClass="hashmap">
        <![CDATA[
        WITH W_BASE AS /* TRME0030.SEARCH00 카드청구내역관리 조회 */
        (
        	/* 법인카드 청구내역 정보 */
            SELECT            
                     A.CARD_NUMB    /* 카드번호 */
                    ,A.BILL_DATE    /* 청구일자 */
                    ,A.CARD_APPR    /* 승인번호 */
                    ,A.APPR_GUBN    /* 승인구분 */
                    ,A.CHIN_NAME    /* 가맹점명 */
                    ,A.CHIN_NUMB    /* 가맹점사업자번호 */
                    ,A.CHIN_IDXX    /* 가맹점번호 */
                    ,A.DMND_AMOT    /* 청구금액 */
                    ,A.USEX_FEEX    /* 이용수수료 */
                    ,A.HALB_AMON    /* 할부개월수 */
                    ,A.HALB_RMON    /* 잔여할부 */
                    ,A.ACCT_INTL    /* 계정코드 */
                    ,NVL(A.REMK_NOTE, D.REMK_NAME)    AS     REMK_NOTE    /* 적요 */
                    ,A.APPR_DATE    			/* 사용일자 */
                    ,A.CSPS_CODE    			/* 처리상태 */
                    ,C.ACNT_NUMB                                         AS ACNT_NUMB      /* 계좌번호 */
                    ,SF_GET_COMMNAME('BANK_CODE',E.BANK_CODE)            AS BANK_NAME      /* 계좌은행명 */
                    ,E.BANK_CODE                                         AS BANK_GUBN      /* 계좌은행코드 */
                    ,E.BABR_CODE                                         AS BABR_CODE      /* 계좌은행지점 */
                    ,A.SLIP_NUMB AS SLIP_NUMB	/* 청구자동전표번호 */
                    ,A.SLIP_LINE AS SLIP_LINE  	/* 청구자동전표라인번호 */
                    ,L.SLIP_NUMB AS BSLI_NUMB	/* 청구일반전표번호 */
                    ,L.SLIP_LINE AS BSLI_LINE	/* 청구일반전표라인번호 */
                    ,NVL(D.SLIP_AMNT,0) + NVL(L.SLIP_AMNT,0)             AS BILL_SLIP_AMNT /* 청구전표금액 */
                    ,NVL(A.REMK_NOTE, NVL(D.REMK_NAME, L.REMK_NAME))     AS BILL_REMK_NOTE /* 승인적요 */
                    ,SUBSTR(A.CARD_NUMB,11)                              AS CARD_NUM2      /* 카드번호 */
                    ,C.USER_EMPL                                         AS EMPL_NUMB      /* 사용자 */
                    ,F.EMPL_NAME                                         AS EMPL_NAME      /* 사용자명 */
                    ,C.CARD_KIND                                         AS CARD_KIND      /* 카드구분 */
            FROM    TA_CARDBM A     	/* [법인카드 청구내역] */
                    LEFT JOIN TA_CARDXM C
                    	   ON C.CARD_NUMB = A.CARD_NUMB
                    LEFT JOIN TA_ACNTXM E
                    	   ON E.ACNT_NUMB = C.ACNT_NUMB
                    LEFT JOIN VI_MASTEM F
                    	   ON F.EMPL_NUMB = C.USER_EMPL
                    LEFT JOIN TA_SLIPNT D
	                       ON D.SLIP_NUMB = A.SLIP_NUMB
	                      AND D.SLIP_LINE = A.SLIP_LINE
                    LEFT JOIN TA_VATXXM M
	                       ON M.CARD_NUMB = A.CARD_NUMB
	                      AND M.CARD_APPR = A.CARD_APPR
	                      AND M.TRNS_DATE = A.APPR_DATE
                    LEFT JOIN TA_SLIPNT L         /* 일반전표 */
	                       ON L.ACCT_INTL = SF_GET_JUNLACCT('TR011-0001')     /* 미지급비용-카드사용비 */
	                      AND L.DRCR_GUBN = 'D'            /* 차변 발생내역 */
	                      AND L.SLIP_NUMB = M.SLIP_NUMB
	                      AND L.SLIP_LINE = M.SLIP_LINE
	                      AND SIGN(L.SLIP_AMNT) = SIGN(A.DMND_AMOT)
	                      AND L.SLIP_NUMB <> NVL(A.SLIP_NUMB, ' ')
	                      AND L.SLIP_LINE <> NVL(A.SLIP_LINE, ' ')
            WHERE   A.BILL_DATE    LIKE #BILL_MONT# || '%'    /* 청구일자 */
		]]>
		<isNotEmpty prepend="AND" property="ACNT_NUMB">
            		C.ACNT_NUMB = #ACNT_NUMB#  	/* 계좌번호 */
        </isNotEmpty>        
		<isNotEmpty prepend="AND" property="CARD_NUMB">
            		A.CARD_NUMB = #CARD_NUMB#  	/* 카드번호 */
        </isNotEmpty>
		<isNotEmpty prepend="AND" property="EMPL_NUMB">
            		( C.USER_EMPL = #EMPL_NUMB#
	               OR C.SLIP_EMP1 = #EMPL_NUMB#
	               OR C.SLIP_EMP2 = #EMPL_NUMB#
	               OR C.SLIP_EMP3 = #EMPL_NUMB# )	/* 사용자 */
        </isNotEmpty>
		<isNotEmpty prepend="AND" property="DEPT_CODE">
            		C.USEX_DEPT = #DEPT_CODE# /* 관리부서 */
        </isNotEmpty>
        <isNotEmpty prepend="AND" property="CARD_KIND">
            		C.CARD_KIND = #CARD_KIND#	/* 카드구분 */
        </isNotEmpty>    
        <isNotEmpty prepend="AND" property="CHIN_NUMB">
              		A.CHIN_NUMB LIKE '%' || #CHIN_NUMB# || '%'
        </isNotEmpty>
        <isNotEmpty prepend="AND" property="CHIN_NAME">
              		A.CHIN_NAME LIKE '%' || #CHIN_NAME# || '%'
        </isNotEmpty>
        <![CDATA[
            )
            ,W_CARDAM AS
            (
            /* 법인카드 사용내역 정보 */
            SELECT   A.CARD_NUMB
                    ,B.APPR_DATE
                    ,A.CARD_APPR
                    ,A.APPR_GUBN
                    ,B.APPR_AMNT
                    ,B.SLIP_NUMB AS CREA_NUMB 	/* 승인자동전표번호 */
                    ,B.SLIP_LINE AS CREA_LINE 	/* 승인자동전표라인번호 */
                    ,SF_GET_COMMNAME('APPS_CODE', DM.APPS_CODE) AS CREA_APPS
                    ,D.SLIP_AMNT        AS SLIP_AMNT
                    ,D.REMK_NAME        AS REMK_NOTE     /* 적요 */
                    ,NVL(D.ACCT_INTL, L.ACCT_INTL)        AS ACCT_INTL    /* 계정코드 */
                    ,L.SLIP_NUMB AS LSLI_NUMB	/* 승인일반전표번호 */ 
					,L.SLIP_LINE AS LSLI_LINE	/* 승인일반전표라인번호 */
                    ,NVL(D.SLIP_AMNT,0) + NVL(L.SLIP_AMNT,0)             AS APPR_SLIP_AMNT    /* 승인전표금액 */
                    ,NVL(B.REMK_NOTE, NVL(D.REMK_NAME, L.REMK_NAME))    AS APPR_REMK_NOTE    /* 승인적요 */
                    ,CASE WHEN L.SLIP_NUMB IS NOT NULL THEN L.SLIP_NUMB ELSE B.SLIP_NUMB END        AS OSLI_NUMB    /* 발생전표번호 */
                    ,CASE WHEN L.SLIP_NUMB IS NOT NULL THEN L.SLIP_LINE ELSE B.SLIP_LINE END        AS OSLI_LINE    /* 발생전표행번호 */
                    ,CASE WHEN DM.SLIP_NUMB IS NOT NULL THEN DM.APPS_CODE
                          WHEN LM.SLIP_NUMB IS NOT NULL THEN LM.APPS_CODE
                          ELSE TO_NCHAR('') END                                    AS APPS_CODE    /* 결재상태 */
            FROM    W_BASE A
                    LEFT JOIN TA_CARDAM B	/* [법인카드 사용내역] */
	                       ON B.CARD_NUMB = A.CARD_NUMB
	                      AND B.APPR_DATE = A.APPR_DATE
	                      AND B.CARD_APPR = A.CARD_APPR
	                      AND B.APPR_GUBN = A.APPR_GUBN
                    LEFT JOIN TA_SLIPNT D
	                       ON D.SLIP_NUMB = B.SLIP_NUMB
	                      AND D.SLIP_LINE = B.SLIP_LINE
                    LEFT JOIN TA_SLIPXM DM
                    	   ON DM.SLIP_NUMB = D.SLIP_NUMB
                    LEFT JOIN TA_VATXXM M
	                       ON M.CARD_NUMB = B.CARD_NUMB
	                      AND M.CARD_APPR = B.CARD_APPR
	                      AND M.TRNS_DATE = B.APPR_DATE
                    LEFT JOIN TA_SLIPNT L        /* 일반전표 */
	                       ON L.ACCT_INTL = SF_GET_JUNLACCT('TR011-0001')         /* 미지급비용-카드사용비 */
	                      AND L.DRCR_GUBN = 'C'              /* 대변 발생내역 */
	                      AND L.SLIP_NUMB = M.SLIP_NUMB
	                      AND L.SLIP_LINE = M.SLIP_LINE
	                      AND SIGN(L.SLIP_AMNT) = SIGN(B.APPR_AMNT)
	                      AND L.SLIP_NUMB <> NVL(B.SLIP_NUMB, ' ')
	                      AND L.SLIP_LINE <> NVL(B.SLIP_LINE, ' ')
                    LEFT JOIN TA_SLIPXM LM
                    	   ON LM.SLIP_NUMB = L.SLIP_NUMB
            WHERE   B.CARD_NUMB    IS NOT NULL
            )
            SELECT
                    '' AS CHK
                    ,CASE WHEN B.CREA_NUMB IS NULL THEN 1
                    	  WHEN A.SLIP_NUMB IS NOT NULL THEN 1
                          WHEN A.CSPS_CODE = '0' THEN 0
                          ELSE 1 END     AS CHK_GUBN
                    ,A.CSPS_CODE 	/* 처리상태 */
                    ,A.CARD_NUMB    /* 카드번호 */
                    ,A.BILL_DATE    /* 청구일자 */
                    ,A.CARD_APPR    /* 승인번호 */
                    ,A.APPR_GUBN    /* 승인구분 */
                    ,A.CHIN_NAME    /* 가맹점명 */
                    ,A.CHIN_NUMB    /* 가맹점사업자번호 */
                    ,A.CHIN_IDXX    /* 가맹점번호 */
                    ,A.DMND_AMOT    /* 청구금액 */
                    ,A.USEX_FEEX    /* 이용수수료 */
                    ,A.HALB_AMON    /* 할부개월수 */
                    ,A.HALB_RMON    /* 잔여할부 */
                    ,NVL(A.DMND_AMOT,0) - NVL(B.APPR_AMNT,0)        AS DIFF_AMNT    /* 차액 */
                    ,B.ACCT_INTL    /* 계정코드 */
                    ,SF_GET_ACCTBFNM(B.ACCT_INTL)     AS ACCT_NAME
                    ,A.APPR_DATE    /* 사용일자 */
                    ,B.APPR_AMNT    /* 승인금액 */
                    ,B.SLIP_AMNT    /* 전표금액 */
                    ,B.CREA_NUMB    /* 발생자동전표번호 */
                    ,B.CREA_LINE    /* 발생자동전표라인번호 */
                    ,B.CREA_APPS	/* 발생자동전표 결재상태 */
                    ,B.LSLI_NUMB    /* 발생일반전표번호 */
                    ,B.LSLI_LINE    /* 발생일반전표라인번호 */
                    ,B.OSLI_NUMB    /* 발생전표번호 */
                    ,B.OSLI_LINE    /* 발생전표행번호 */
                    ,A.SLIP_NUMB    /* 청구자동전표번호 */
                    ,A.SLIP_LINE	/* 청구자동전표라인번호 */
                    ,A.BSLI_NUMB  	/* 청구일반전표번호 */
                    ,A.BSLI_LINE 	/* 청구일반전표라인번호 */
                    ,NVL(A.BILL_REMK_NOTE, B.APPR_REMK_NOTE)        AS REMK_NOTE     /* 적요 */
                    ,A.ACNT_NUMB 					AS ACNT_NUMB	/* 계좌번호 */
                    ,A.BANK_NAME 					AS BANK_NAME
                    ,A.BANK_GUBN 					AS BANK_GUBN 	/* 계좌은행코드 */
                    ,A.BABR_CODE 					AS BABR_CODE 	/* 계좌은행지점 */
                    ,B.APPR_SLIP_AMNT 				AS APPR_SLIP_AMNT    /* 승인전표금액 */
                    ,A.BILL_SLIP_AMNT 				AS BILL_SLIP_AMNT    /* 청구전표금액 */
                    ,NVL(A.BILL_SLIP_AMNT,0) - NVL(B.APPR_SLIP_AMNT,0)    AS SLIP_DIFF_AMNT    /* 전표차이금액 */
                    ,NVL(B.APPR_AMNT,0) - NVL(B.APPR_SLIP_AMNT,0)    AS APPR_SLIP_DIFF_AMNT    /* 승인전표금액차이 */
                    ,A.CARD_NUM2    /* 카드번호 */
                    ,A.EMPL_NUMB    /* 사용자 */
                    ,A.EMPL_NAME    /* 사용자명 */
                    ,A.CARD_KIND    /* 카드구분 */
                    ,B.APPS_CODE    /* 결재상태 */
            FROM    W_BASE A     /* 카드청구내역관리 */
                    LEFT JOIN W_CARDAM B
		                   ON B.CARD_NUMB = A.CARD_NUMB
		                  AND B.APPR_DATE = A.APPR_DATE
		                  AND B.CARD_APPR = A.CARD_APPR
		                  AND B.APPR_GUBN = A.APPR_GUBN
            WHERE    NVL(A.CSPS_CODE, TO_NCHAR(' ')) = NVL(#CSPS_CODE#, NVL(A.CSPS_CODE, TO_NCHAR(' ')))
            ORDER    BY
                     A.CARD_NUMB
                    ,A.APPR_DATE
                    ,A.CARD_APPR
                    ,A.APPR_GUBN
        ]]>
    </select>
    
<!--
/* ******************************************************************************
     작  성  자 : 권미영
     작  성  일 : 2016.09.26
     내      용 : 전표처리된 전표번호 조회
******************************************************************************* */
 -->
    <select id="TRME0030.SEARCHSLIPNUM" parameterClass="hashmap" resultClass="String">
        <![CDATA[
            SELECT   /* TRME0030.SEARCHSLIPNUM 전표처리된 전표번호 조회 */
                     SLIP_NUMB
             FROM    TA_CARDBM A
            WHERE    BILL_DATE    = #BILL_DATE#    /* 청구일자 */
              AND    CARD_NUMB    = #CARD_NUMB#    /* 카드번호 */
              AND    APPR_DATE    = #APPR_DATE#    /* 승인일자 */
              AND    CARD_APPR    = #CARD_APPR#    /* 승인번호 */
              AND    APPR_GUBN    = #APPR_GUBN#    /* 승인구분 */
        ]]>
    </select>
    
<!--
/* ******************************************************************************
     작  성  자 : 김준수
     작  성  일 : 2016.07.13
     내      용 : 수정[카드청구내역관리]
******************************************************************************* */
 -->
    <update id="TRME0030.UPDATE00" parameterClass="hashmap">
        <![CDATA[
            UPDATE    TA_CARDBM    /* TRME0030.UPDATE00.카드청구내역관리 수정 */
               SET
                     REMK_NOTE    = #REMK_NOTE#       /* 적요 */
                    ,UPDT_DATE    = SYSDATE       	  /* 수정일자 */
                    ,UPDT_USID    = #UPDT_USID#       /* 수정자 */
            WHERE   CARD_NUMB    = #CARD_NUMB#        /* 카드번호 */
              AND   BILL_DATE    = #BILL_DATE#        /* 청구일자 */
              AND   CARD_APPR    = #CARD_APPR#        /* 승인번호 */
              AND   APPR_GUBN    = #APPR_GUBN#        /* 승인구분 */
              AND   APPR_DATE    = #APPR_DATE#        /* 사용일자 */
        ]]>
    </update>

<!--
/* ******************************************************************************
     작  성  자 : 권미영
     작  성  일 : 2016.09.27
     내      용 : 전표대상데이터 체크 초기화
******************************************************************************* */
 -->
    <update id="TRME0030.UPDATE02" parameterClass="hashmap" >
        <![CDATA[
        	UPDATE   TA_CARDBM    /* TRME0030.UPDATE02 전표대상데이터 체크 초기화 */
               SET   SLIP_NUMB    = ''
             WHERE   SLIP_NUMB	  = #FORM_IDXX# || #UPDT_USID#
        ]]>
	</update>
	
<!--
/* ******************************************************************************
     작  성  자 : 권미영
     작  성  일 : 2016.09.27
     내      용 : 전표대상데이터 체크 UPDATE
******************************************************************************* */
 -->
    <update id="TRME0030.UPDATE03" parameterClass="hashmap" >
        <![CDATA[
        	DECLARE
			/* TRME0030.UPDATE03 전표대상데이터 체크 UPDATE */
			
        	sSLIP_NUMB VARCHAR2(20);
        	
		BEGIN
			/* ==================================================================
				1. 전표 기처리여부 체크 
			================================================================== */
	        BEGIN
	            SELECT 	SLIP_NUMB
	              INTO 	sSLIP_NUMB
	              FROM 	TA_CARDBM
	             WHERE   BILL_DATE    = #BILL_DATE#    /* 청구일자 */
	               AND   CARD_NUMB    = #CARD_NUMB#    /* 카드번호 */
	               AND   APPR_DATE    = #APPR_DATE#    /* 승인일자 */
	               AND   CARD_APPR    = #CARD_APPR#    /* 승인번호 */
	               AND   APPR_GUBN    = #APPR_GUBN#    /* 승인구분 */
	             ;
	             
	             IF sSLIP_NUMB <> '' OR LENGTH(sSLIP_NUMB) <> 0 THEN
	                RAISE_APPLICATION_ERROR(-20000, '이미 전표발행된 건 입니다. 카드번호 [' || #CARD_NUMB# || ']');
	             END IF; 
	             
	        EXCEPTION
	            WHEN NO_DATA_FOUND THEN
	                RETURN;
	                RAISE_APPLICATION_ERROR(-20000,'데이터가 존재하지 않습니다. [' || #CARD_NUMB# || ']');
	        END;
        
			/* ==================================================================
				2. 전표대상데이터 체크 UPDATE
			================================================================== */
			UPDATE   TA_CARDBM    /* TRME0020.UPDATE03 전표대상데이터 체크 UPDATE */
               SET   SLIP_NUMB	  = #FORM_IDXX# || #UPDT_USID#
             WHERE   BILL_DATE    = #BILL_DATE#    /* 청구일자 */
               AND   CARD_NUMB    = #CARD_NUMB#    /* 카드번호 */
               AND   APPR_DATE    = #APPR_DATE#    /* 승인일자 */
               AND   CARD_APPR    = #CARD_APPR#    /* 승인번호 */
               AND   APPR_GUBN    = #APPR_GUBN#    /* 승인구분 */
               ;
             
    	END;
        ]]>
	</update>
	
	
<!-- 
/* ******************************************************************************
	    작  성  자 : 권미영
	    작  성  일 : 2016.09.27
	    내      용 : 법인카드 청구 전표생성
 ******************************************************************************* */
-->
	<insert id="TRME0030.PROC00" parameterClass="hashmap" >
	<![CDATA[
		DECLARE
    		/* TRME0030.PROC00 법인카드 청구 전표생성 */
    	
			sTITL_NAME      TA_SLIPXM.TITL_NAME%TYPE;   /* 대표적요 */
			sSLIP_NUMB      TA_SLIPXM.SLIP_NUMB%TYPE;   /* 전표번호 */
			sSLIP_LINE      TA_SLIPNT.SLIP_LINE%TYPE;   /* 전표행번호 */
			sOSLI_NUMB      TA_SLIPNT.OSLI_NUMB%TYPE;   /* 상대전표번호 */
			sOSLI_LINE      TA_SLIPNT.OSLI_LINE%TYPE;   /* 상대전표순번 */
			sCOND_VACD		TA_SLIPRF.COND_VACD%TYPE;   /* 관리항목 관리항목값 */
			
	    BEGIN
	    
			sTITL_NAME := '[법인카드청구 정산] - ' || #SLIP_DATE#;
			
			/* ==================================================================
				1. 전표마스터 저장 
			================================================================== */
			PKG_FAMIFSLIP.SP_MASTER_SAVE(
				 #SYST_LNCD#   	/* ●시스템언어코드 */
				,#UPDT_USID#    /* ●수정작업자 */
				,#ACCT_UNIT#    /* ●회계단위 */
				,#ACCT_GUBN#	/* ●회계구분_사업장 */
				,#SLIP_DATE#    /* ●전표일자(회계일자) */ 
				,#SLIP_GUBN#    /* ●전표유형구분 */
				,sTITL_NAME     /* ●제목 */
				,#EMPL_NUMB#    /* ●사원번호 */
				,#DEPT_CODE#	/* ●부서코드 */ 						 
				,#SOUS_LNKY#    /* ●출처연결키 */
				,NULL
				,NULL
				,NULL
				,NULL
				,NULL
				,sSLIP_NUMB);      /* ●전표번호(생성된 전표번호 반환) */
		
			/* ==================================================================
				2-1. 전표라인데이터 
			================================================================== */
			FOR RS IN (
				SELECT LPAD(ROWNUM, 4, '0') AS SLIP_LINE	/* 전표라인번호 */
					  ,ROWNUM AS SORT_ORDR					/* 정렬순서 */
					  ,A.* 
				 FROM (
				  	/* 1. 카드사용경비 (법인카드미지급비용) 반제 - 차변 */                     
					SELECT  
				            C.ACCT_INTL                 	/* 계정과목코드 */
				           ,B.DEPT_CODE AS USEX_DEPT    	/* 사용부서 */
				           ,TO_NCHAR('') AS CSTC_CODE     	/* 코스트센터코드 */
				           ,TO_NCHAR('D') AS DRCR_GUBN    	/* 차대구분 - 차변 */
				           ,'KRW' AS CURR_GUBN          	/* 통화구분 */
				           ,1 AS EXCH_RATE              	/* 환율 */
				           ,B.APPR_AMNT AS FORI_AMNT    	/* 외화금액 */
				           ,B.APPR_AMNT AS SLIP_AMNT    	/* 전표금액 */ 
				           ,B.SLIP_NUMB AS OSLI_NUMB    	/* 상대전표번호 */
				           ,B.SLIP_LINE AS OSLI_LINE    	/* 상대전표순번 */
				           ,TO_NCHAR('') AS BUDG_GUBN     	/* 예산구분 */
				           ,TO_NCHAR('') AS PROJ_CODE     	/* 프로젝트코드 */
				           ,TO_NCHAR('') AS BGRQ_NUMB     	/* 예산품의번호 */
				           ,TO_NCHAR('') AS BUDG_DEPT     	/* 예산부서코드 */
				           ,TO_NCHAR('') AS BUDG_YYMM     	/* 예산년월 */
				           ,TO_NCHAR('') AS BDSB_CODE     	/* 예산과목코드 */
				           ,TO_NCHAR('') AS BDSP_CODE     	/* 예산세목코드 */
				           ,'[' || SUBSTR(A.BILL_DATE, 1, 6) || ' 청구] - ' || NVL(A.REMK_NOTE, B.REMK_NOTE) AS REMK_NAME      /* 적요 */
				           ,TO_NCHAR('') AS EVID_DOCU     	/* 증빙종류 */
				           ,TO_NCHAR('') AS PAYX_YSNO     	/* 출납처리여부 */
				           ,TO_NCHAR('') AS PAYX_DATE     	/* 지급일 */
				           ,TO_NCHAR('') AS LEDG_GUBN     	/* 출납방법 */
				           ,TO_NCHAR('') AS BANK_INOU     	/* 입출구분 */
				           ,TO_NCHAR('') AS PRIN_ORDR     	/* 출력순서 */ 
				           ,A.BILL_DATE                 	/* 청구일자 */
				           ,A.APPR_DATE                 	/* 승인일자 */
				           ,A.CARD_NUMB                 	/* 카드번호 */
				           ,A.CARD_APPR                 	/* 카드승인번호 */
				           ,A.APPR_GUBN                 	/* 승인구분 */ 
						   ,B.CUST_CODE						/* 거래처코드 */
						   ,B.CHIN_NUMB						/* 사업자번호 */
                           ,B.EMPL_NUMB						/* 사원번호 */
                           ,TO_NCHAR('') AS ACNT_NUMB         /* 계좌번호 */ 
                           ,TO_NCHAR('') AS BABR_CODE         /* 금융기관 */
				           ,1 AS CHKK_BANJ					/* 반제계정여부 (업무테이블에 업데이트될 전표) */
					  FROM TA_CARDBM A						/* [카드청구내역] */
					       LEFT  JOIN TA_CARDAM B 			/* [카드승인내역] */
							       ON A.CARD_NUMB = B.CARD_NUMB 	/* 카드번호 */
							      AND A.APPR_DATE = B.APPR_DATE 	/* 승인일자 */
							      AND A.CARD_APPR = B.CARD_APPR 	/* 승인번호 */
							      AND A.APPR_GUBN = B.APPR_GUBN		/* 승인구분 */
				     	   INNER JOIN TA_JUNLXM C 					/* [분개코드] */
				     	   		   ON C.JUNL_CODE = 'TR011-0001' 	/* 카드사용경비 (법인카드미지급비용) */
					 WHERE A.SLIP_NUMB	  = #FORM_IDXX# || #UPDT_USID#		/* 타겟이 되는 데이터 */
				     UNION ALL
				    /* 2. 보통예금, 잡손실, 잡이익 */
				    SELECT  
				            C.ACCT_INTL                 		/* 계정과목코드 */
				           ,TO_NCHAR(#DEPT_CODE#) AS USEX_DEPT    /* 사용부서 */
				           ,TO_NCHAR('') AS CSTC_CODE     		/* 코스트센터코드 */
				           ,C.DRCR_GUBN    						/* 차대구분 */
				           ,'KRW' AS CURR_GUBN          		/* 통화구분 */
				           ,1 AS EXCH_RATE              		/* 환율 */
				           ,CASE WHEN C.JUNL_CODE = 'TR012-0001' THEN SUM(A.DMND_AMOT)
				            	 ELSE ABS(SUM(NVL(A.DMND_AMOT,0) - NVL(B.APPR_AMNT,0))) END AS FORI_AMNT    	/* 외화금액 */
				           ,CASE WHEN C.JUNL_CODE = 'TR012-0001' THEN SUM(A.DMND_AMOT)
				            	 ELSE ABS(SUM(NVL(A.DMND_AMOT,0) - NVL(B.APPR_AMNT,0))) END AS SLIP_AMNT    	/* 전표금액 */ 
				           ,TO_NCHAR('') AS OSLI_NUMB             /* 상대전표번호 */
				           ,TO_NCHAR('') AS OSLI_LINE             /* 상대전표순번 */
				           ,TO_NCHAR('') AS BUDG_GUBN             /* 예산구분 */
				           ,TO_NCHAR('') AS PROJ_CODE             /* 프로젝트코드 */
				           ,TO_NCHAR('') AS BGRQ_NUMB             /* 예산품의번호 */
				           ,TO_NCHAR('') AS BUDG_DEPT             /* 예산부서코드 */
				           ,TO_NCHAR('') AS BUDG_YYMM             /* 예산년월 */
				           ,TO_NCHAR('') AS BDSB_CODE             /* 예산과목코드 */
				           ,TO_NCHAR('') AS BDSP_CODE             /* 예산세목코드 */
				           ,'[' || SUBSTR(A.BILL_DATE, 1, 6) || ' 청구] - 법인카드 결제' AS REMK_NAME      /* 적요 */
				           ,TO_NCHAR('') AS EVID_DOCU             /* 증빙종류 */
				           ,TO_NCHAR('') AS PAYX_YSNO             /* 출납처리여부 */
				           ,TO_NCHAR('') AS PAYX_DATE             /* 지급일 */
				           ,TO_NCHAR('') AS LEDG_GUBN             /* 출납방법 */
				           ,TO_NCHAR('') AS BANK_INOU             /* 입출구분 */
				           ,TO_NCHAR('') AS PRIN_ORDR             /* 출력순서 */ 
				           ,TO_NCHAR('') AS BILL_DATE             /* 청구일자 */
				           ,TO_NCHAR('') AS APPR_DATE             /* 승인일자 */
				           ,TO_NCHAR('') AS CARD_NUMB             /* 카드번호 */
				           ,TO_NCHAR('') AS CARD_APPR             /* 카드승인번호 */
				           ,TO_NCHAR('') AS APPR_GUBN             /* 승인구분 */ 
						   ,TO_NCHAR('') AS CUST_CODE				/* 거래처코드 */
						   ,TO_NCHAR('') AS CHIN_NUMB				/* 사업자번호 */
                           ,TO_NCHAR('') AS EMPL_NUMB				/* 사원번호 */
                           ,D.ACNT_NUMB                         /* 계좌번호 */
                           ,E.BABR_CODE							/* 금융기관 */
				           ,0 AS CHKK_BANJ						/* 반제계정여부 (업무테이블에 업데이트될 전표) */
				      FROM TA_JUNLXM C					        /* [분개코드] */
				      	   LEFT JOIN TA_CARDBM A ON 1 = 1	    /* [카드청구내역] */
				      	   LEFT JOIN TA_CARDAM B 		        /* [카드승인내역] */
					      	      ON A.CARD_NUMB = B.CARD_NUMB 	/* 카드번호 */
					      	     AND A.APPR_DATE = B.APPR_DATE 	/* 승인일자 */
					      	     AND A.CARD_APPR = B.CARD_APPR 	/* 승인번호 */
					      	     AND A.APPR_GUBN = B.APPR_GUBN	/* 승인구분 */
				      	   LEFT JOIN TA_CARDXM D 				/* [법인카드정보] */
				      	   		  ON A.CARD_NUMB = D.CARD_NUMB	/* 카드번호 */
				      	   LEFT JOIN TA_ACNTXM E				/* [금융계좌정보] */
                                   ON D.ACNT_NUMB = E.ACNT_NUMB	/* 계좌번호 */
					 WHERE A.SLIP_NUMB	  = #FORM_IDXX# || #UPDT_USID#		/* 타겟이 되는 데이터 */
				       AND (     (C.JUNL_CODE = 'TR012-0001')   			/* 보통예금 : 법인카드정산비용 */
				              OR (C.JUNL_CODE = 'TR012-0002' AND NVL(A.DMND_AMOT,0) - NVL(B.APPR_AMNT,0) > 0) 	/* 잡손실 : 청구금액이 많은 경우 */
				              OR (C.JUNL_CODE = 'TR012-0003' AND NVL(A.DMND_AMOT,0) - NVL(B.APPR_AMNT,0) < 0)  	/* 잡이익 : 청구금액이 적은 경우 */
				          )
				     GROUP BY C.ACCT_INTL               /* 계정과목코드 */
				     	   ,C.DRCR_GUBN					/* 차대구분 */
				     	   ,C.JUNL_CODE					/* 분개코드 */
				     	   ,SUBSTR(A.BILL_DATE, 1, 6)	/* 청구월 */
				     	   ,D.ACNT_NUMB					/* 계좌번호 */
				     	   ,E.BABR_CODE					/* 금융지점코드 */
				     ORDER BY APPR_DATE DESC        	/* 승인일자 */
				          ,CARD_NUMB            		/* 카드번호 */
				          ,CARD_APPR            		/* 카드승인번호 */
				          ,APPR_GUBN            		/* 승인구분 */
				          ,DRCR_GUBN DESC       		
				) A
			)
			LOOP
				
				sSLIP_LINE := RS.SLIP_LINE;		/* 전표라인번호 */
				sOSLI_NUMB := RS.OSLI_NUMB;		/* 상대전표번호 */
				sOSLI_LINE := RS.OSLI_LINE;		/* 상대전표라인번호 */
				
				/* ==================================================================
					2-2. 전표라인 저장 
				================================================================== */
				PKG_FAMIFSLIP.SP_LINE_SAVE(
					 #SYST_LNCD#  	 /* ●시스템언어코드 */
					,#UPDT_USID#     /* ●수정작업자 */
					,sSLIP_NUMB    	 /* ●전표번호 */
					,sSLIP_LINE    	 /* ●전표라인번호 */
					,#ACCT_UNIT#     /* ●회계단위 */
					,#ACCT_GUBN#     /* ●회계구분_사업장 */
					,RS.ACCT_INTL    /* ●계정과목코드 OR 분개코드 */
					,RS.USEX_DEPT    /* ●사용부서 */
					,RS.CSTC_CODE    /* ◎코스트센터코드 */
					,RS.DRCR_GUBN    /* ●차대구분 */
					,RS.CURR_GUBN    /* ●통화구분 */
					,RS.EXCH_RATE    /* ●환율 */
					,RS.FORI_AMNT    /* ●외화금액 */
					,RS.SLIP_AMNT    /* ●전표금액 */
					,RS.OSLI_NUMB    /* ◎상대전표번호 */
					,RS.OSLI_LINE    /* ◎상대전표순번 */
					,RS.BUDG_GUBN    /* ◎예산구분 */
					,RS.PROJ_CODE    /* ◎프로젝트코드 */
					,RS.BGRQ_NUMB    /* ◎예산품의번호 */
					,RS.BUDG_DEPT    /* ◎예산부서코드 */
					,RS.BUDG_YYMM    /* ◎예산년월 */
					,RS.BDSB_CODE    /* ◎예산과목코드 */
					,RS.BDSP_CODE    /* ◎예산세목코드 */
					,RS.REMK_NAME    /* ●적요 */
					,RS.EVID_DOCU    /* ◎증빙종류 */
					,RS.PAYX_YSNO    /* ◎출납처리여부 */
					,RS.PAYX_DATE    /* ◎지급일 */
					,RS.LEDG_GUBN    /* ◎출납방법 */
					,RS.BANK_INOU    /* ◎입출구분 */
					,RS.PRIN_ORDR    /* ◎출력순서 */
					,RS.SORT_ORDR    /* ◎정렬순서 */
					,NULL     /* ◎미사용여분인수1 */
					,NULL     /* ◎미사용여분인수2 */
					,NULL     /* ◎미사용여분인수3 */
					,NULL     /* ◎미사용여분인수4 */
					,NULL     /* ◎미사용여분인수5 */
				);
				
				
				/* ==================================================================
					3-1. 카드사용경비 반제 : 상대전표번호로 발생된 전표관리항목 COPY
				================================================================== */
	        	FOR RS_RF_COPY IN (					
					SELECT MAX(CASE WHEN SEQ = 1 THEN COND_CODE ELSE NULL END) COND_COD1
					      ,MAX(CASE WHEN SEQ = 1 THEN COND_VACD ELSE NULL END) COND_VAC1
					      ,MAX(CASE WHEN SEQ = 2 THEN COND_CODE ELSE NULL END) COND_COD2
					      ,MAX(CASE WHEN SEQ = 2 THEN COND_VACD ELSE NULL END) COND_VAC2
					      ,MAX(CASE WHEN SEQ = 3 THEN COND_CODE ELSE NULL END) COND_COD3
					      ,MAX(CASE WHEN SEQ = 3 THEN COND_VACD ELSE NULL END) COND_VAC3
					      ,MAX(CASE WHEN SEQ = 4 THEN COND_CODE ELSE NULL END) COND_COD4
					      ,MAX(CASE WHEN SEQ = 4 THEN COND_VACD ELSE NULL END) COND_VAC4
					      ,MAX(CASE WHEN SEQ = 5 THEN COND_CODE ELSE NULL END) COND_COD5
					      ,MAX(CASE WHEN SEQ = 5 THEN COND_VACD ELSE NULL END) COND_VAC5
					      ,MAX(CASE WHEN SEQ = 6 THEN COND_CODE ELSE NULL END) COND_COD6
					      ,MAX(CASE WHEN SEQ = 6 THEN COND_VACD ELSE NULL END) COND_VAC6
					      ,MAX(CASE WHEN SEQ = 7 THEN COND_CODE ELSE NULL END) COND_COD7
					      ,MAX(CASE WHEN SEQ = 7 THEN COND_VACD ELSE NULL END) COND_VAC7
					      ,MAX(CASE WHEN SEQ = 8 THEN COND_CODE ELSE NULL END) COND_COD8
					      ,MAX(CASE WHEN SEQ = 8 THEN COND_VACD ELSE NULL END) COND_VAC8
					      ,MAX(CASE WHEN SEQ = 9 THEN COND_CODE ELSE NULL END) COND_COD9
					      ,MAX(CASE WHEN SEQ = 9 THEN COND_VACD ELSE NULL END) COND_VAC9
					  FROM (                       
					        SELECT  RANK() OVER (PARTITION BY A.SLIP_NUMB, A.SLIP_LINE ORDER BY A.SLIP_NUMB, A.SLIP_LINE, A.COND_CODE DESC) AS SEQ 
					              ,A.*
					          FROM TA_SLIPRF A	/* [전표관리항목] */
					         WHERE A.SLIP_NUMB = sOSLI_NUMB		/* 전표번호 - 상대전표번호 */
					           AND A.SLIP_LINE = sOSLI_LINE		/* 전표라인 - 상대전표라인 */
					     ) A
					 WHERE RS.CHKK_BANJ = 1 /* 반제계정 */
					HAVING MAX(CASE WHEN SEQ = 1 THEN COND_CODE ELSE NULL END)
							|| MAX(CASE WHEN SEQ = 2 THEN COND_CODE ELSE NULL END)
							|| MAX(CASE WHEN SEQ = 3 THEN COND_CODE ELSE NULL END)
							|| MAX(CASE WHEN SEQ = 4 THEN COND_CODE ELSE NULL END)
							|| MAX(CASE WHEN SEQ = 5 THEN COND_CODE ELSE NULL END)
							|| MAX(CASE WHEN SEQ = 6 THEN COND_CODE ELSE NULL END)
							|| MAX(CASE WHEN SEQ = 7 THEN COND_CODE ELSE NULL END)
							|| MAX(CASE WHEN SEQ = 8 THEN COND_CODE ELSE NULL END)
							|| MAX(CASE WHEN SEQ = 9 THEN COND_CODE ELSE NULL END)
							IS NOT NULL
		     	)
				LOOP
		     	        	
					/* ==================================================================
						3-2. 관리항목 저장 
					================================================================== */ 
					PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드 */
						  ,#UPDT_USID#   		/* ●수정작업자 */
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,sSLIP_LINE     		/* ●전표라인번호 */
					      ,RS_RF_COPY.COND_COD1      /* ◎관리항목코드1 */
					      ,RS_RF_COPY.COND_VAC1      /* ◎관리항목값1 */
					      ,RS_RF_COPY.COND_COD2      /* ◎관리항목코드2 */
					      ,RS_RF_COPY.COND_VAC2      /* ◎관리항목값2 */
					      ,RS_RF_COPY.COND_COD3      /* ◎관리항목코드3 */
					      ,RS_RF_COPY.COND_VAC3      /* ◎관리항목값3 */
					      ,RS_RF_COPY.COND_COD4      /* ◎관리항목코드4 */
					      ,RS_RF_COPY.COND_VAC4      /* ◎관리항목값4 */
					      ,RS_RF_COPY.COND_COD5      /* ◎관리항목코드5 */
					      ,RS_RF_COPY.COND_VAC5      /* ◎관리항목값5 */
					      ,RS_RF_COPY.COND_COD6      /* ◎관리항목코드6 */
					      ,RS_RF_COPY.COND_VAC6      /* ◎관리항목값6 */
					      ,RS_RF_COPY.COND_COD7      /* ◎관리항목코드7 */
					      ,RS_RF_COPY.COND_VAC7      /* ◎관리항목값7 */
					      ,RS_RF_COPY.COND_COD8      /* ◎관리항목코드8 */
					      ,RS_RF_COPY.COND_VAC8      /* ◎관리항목값8 */
					      ,RS_RF_COPY.COND_COD9      /* ◎관리항목코드9 */
					      ,RS_RF_COPY.COND_VAC9      /* ◎관리항목값9 */
		      		);
		      		
      			END LOOP;	/* END RS_RF_COPY 전표관리항목COPY */
	      			
	      		
				/* ==================================================================
					3-3. 계정별 관리항목 관리코드 조회 
						- 반제계정은 (3-1)에서 COPY된 전표관리항목 제외
				================================================================== */ 
				FOR RS_RF IN (	
					SELECT A.COND_CODE	/* 관리항목 관리코드 */ 
					  FROM TA_ACCTXD A	/* [계정관리항목코드] */
					 WHERE A.ACCT_INTL = RS.ACCT_INTL		/* 계정코드 */
					   AND (A.DRCR_YSNO IN (0, 1)								/* 0:차대변선택, 1:차대변필수 */
						      OR A.DRCR_YSNO = DECODE(RS.DRCR_GUBN, 'D', 2, 3)	/* 2:차변필수, 3:대변필수 */ 
						      OR A.DRCR_YSNO = DECODE(RS.DRCR_GUBN, 'D', 4, 5)	/* 4:차변선택, 5:대변선택 */
						   )
					   AND NOT EXISTS (
                                SELECT * 
                                  FROM TA_SLIPRF Z
                                 WHERE Z.SLIP_NUMB = sOSLI_NUMB		/* 전표번호 - 상대전표번호 */
					               AND Z.SLIP_LINE = sOSLI_LINE		/* 전표라인 - 상대전표라인 */
                                   AND A.COND_CODE = Z.COND_CODE	/* 관리항목코드 */
                                   AND RS.CHKK_BANJ = 1 			/* 반제계정은 (3-1)에서 COPY된 전표관리항목 제외 */
						   )
					 ORDER BY A.COND_CODE
				)
				LOOP
				
					sCOND_VACD := '';	/* 초기화 */
					
					IF RS_RF.COND_CODE = '0001' THEN /* 금융기관 */
						sCOND_VACD := RS.BABR_CODE;
						
					ELSIF RS_RF.COND_CODE = '0002' THEN /* 거래처코드 */
						sCOND_VACD := RS.CUST_CODE;
					
					ELSIF RS_RF.COND_CODE = '0003' THEN /* 사번 */
						sCOND_VACD := #EMPL_NUMB#;
						
					ELSIF RS_RF.COND_CODE = '0004' THEN /* 부서코드 */
						sCOND_VACD := #DEPT_CODE#;
						
					ELSIF RS_RF.COND_CODE = '0005' THEN /* 카드번호 */
						sCOND_VACD := RS.CARD_NUMB;
						
					ELSIF RS_RF.COND_CODE = '0011' THEN /* 사업자번호 */
						sCOND_VACD := RS.CHIN_NUMB;
						
					ELSIF RS_RF.COND_CODE = '0015' THEN /* 귀속부서 */
						sCOND_VACD := #DEPT_CODE#;

					ELSIF RS_RF.COND_CODE = '0018' THEN /* 승인번호 */
						sCOND_VACD := RS.CARD_APPR;
						
					ELSIF RS_RF.COND_CODE = '0042' THEN /* 승인일자 */
						sCOND_VACD := RS.APPR_DATE;
						
					ELSIF RS_RF.COND_CODE = '0064' THEN /* 계좌번호 */
						sCOND_VACD := RS.ACNT_NUMB;
						
					END IF;
					
					/* ==================================================================
						3-4. 관리항목 저장 
					================================================================== */ 
					PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드 */
						  ,#UPDT_USID#   		/* ●수정작업자 */
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,sSLIP_LINE     		/* ●전표라인번호 */
					      ,RS_RF.COND_CODE      /* ◎관리항목코드1 */
					      ,sCOND_VACD      		/* ◎관리항목값1 */
					      ,NULL      /* ◎관리항목코드2 */
					      ,NULL      /* ◎관리항목값2 */
					      ,NULL      /* ◎관리항목코드3 */
					      ,NULL      /* ◎관리항목값3 */
					      ,NULL      /* ◎관리항목코드4 */
					      ,NULL      /* ◎관리항목값4 */
					      ,NULL      /* ◎관리항목코드5 */
					      ,NULL      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);
      			END LOOP;	/* END RS_RF 관리항목 */
		
		
				/* ==================================================================
					4. 전표번호 UPDATE
				================================================================== */
	      		IF RS.CHKK_BANJ = 1 THEN	
		            UPDATE   TA_CARDBM
		               SET   SLIP_NUMB    = sSLIP_NUMB		/* 전표번호 */
		                    ,SLIP_LINE    = sSLIP_LINE		/* 전표라인번호 */
		                    ,CSPS_CODE	  = '1'				/* 처리상태 */
		                    ,UPDT_DATE    = SYSDATE    	   	/* 수정일자 */
		                    ,UPDT_USID    = #UPDT_USID#   	/* 수정자 */
		             WHERE   BILL_DATE	  = RS.BILL_DATE	/* 청구일자 */
		               AND 	 CARD_NUMB    = RS.CARD_NUMB    /* 카드번호 */
		               AND   APPR_DATE    = RS.APPR_DATE    /* 승인일자 */
		               AND   CARD_APPR    = RS.CARD_APPR    /* 승인번호 */
		               AND   APPR_GUBN    = RS.APPR_GUBN    /* 승인구분 */
		               ;
	      		END IF;
		     	
           	END LOOP;	/* END RS 전표라인 */
		     		      
			/* ==================================================================
				4. 전표작성종료 
			================================================================== */            
			PKG_FAMIFSLIP.SP_FINISH (
			       #SYST_LNCD# 		/* ●시스템언어코드 */
			      ,#UPDT_USID#      /* ●수정작업자 */
			      ,sSLIP_NUMB      	/* ●전표번호 */
	   		);		
	   		
	    END;	
	]]>
	</insert>	
	
<!-- 
/* ******************************************************************************
	    작  성  자 : 권미영
	    작  성  일 : 2016.09.27
	    내      용 : 법인카드 청구 전표삭제
 ******************************************************************************* */
-->
	<insert id="TRME0030.PROC01" parameterClass="hashmap" >
	<![CDATA[
	BEGIN
		/* TRME0030.PROC01 법인카드 청구 전표삭제 */
		/* ==================================================================
			1. 전표삭제 
		================================================================== */
		PKG_FAMIFSLIP.SP_DELETE (
		 	   #SYST_LNCD#      /* ●시스템언어코드 */
		      ,#UPDT_USID#      /* ●수정작업자 */
		      ,#SLIP_NUMB#      /* ●전표번호 */
		      ,#DELE_OPTN#      /* ◎삭제옵션 */
		      
	   	);
	   	
	   	/* ==================================================================
			2. 전표번호 UPDATE 
		================================================================== */
        UPDATE   TA_CARDBM
           SET   SLIP_NUMB    = ''				/* 전표번호 */
                ,SLIP_LINE    = ''				/* 전표라인번호 */
                ,CSPS_CODE	  = '0'				/* 처리상태 */
                ,UPDT_DATE    = SYSDATE    	   	/* 수정일자 */
                ,UPDT_USID    = #UPDT_USID#    	/* 수정자 */
         WHERE   SLIP_NUMB    = #SLIP_NUMB#    	/* 전표번호 */
           ;
	END;
	]]>
	</insert>

<!-- 
/* ******************************************************************************
	    작  성  자 : 권미영
	    작  성  일 : 2016.11.17
	    내      용 : 법인카드 청구내역 가져오기
 ******************************************************************************* */
-->
	<insert id="TRME0030.PROC02" parameterClass="hashmap" >
	<![CDATA[
	BEGIN
		/* TRME0030.PROC02 법인카드 청구내역 가져오기 */
		PKG_IFBATCHPROC.SP_BATCH_PROC (
		 	   #UPDT_USID#      /* 작업자 */
		      ,#ITFC_TYPE#      /* 인터페이스유형[ITFC_TYPE] */
		      ,NULL             /* 보조1필드(처리조건1) */
		      ,NULL             /* 보조2필드(처리조건2) */
		      ,NULL             /* 보조3필드(처리조건3) */
		      
	   	);
	END;
	]]>
	</insert>
	
<!--
/* ******************************************************************************
     작  성  자 : 김준수
     작  성  일 : 2016.06.27
     내      용 : 법인카드 청구내역 신규카드번호 이전카드번호로 정리
******************************************************************************* */
 -->
    <insert id="TRME0030.PROC10" parameterClass="hashmap">
        <![CDATA[
        DECLARE
            
            /* TRME0030.PROC10.법인카드 청구내역 신규카드번호 이전카드번호로 정리 */
            TA_CARDAM_TMP    TA_CARDAM%ROWTYPE;        /* 승인내역 */
            TA_CARDBM_REC    TA_CARDBM%ROWTYPE;        /* 청구내역 */

        BEGIN

            FOR RS IN (
                SELECT
                         B.BILL_DATE        /* 청구일자 */
                        ,B.CARD_NUMB        /* 카드번호 */
                        ,B.CARD_APPR        /* 승인번호 */
                        ,B.APPR_GUBN        /* 승인구분 */
                        ,B.APPR_DATE        /* 이용일자 */
                        ,REPLACE(M.BEFO_CARD,'-','')    AS BEFO_CARD        /* 이전카드번호 */
                FROM    TA_CARDBM B
                        LEFT JOIN TA_CARDXM M
                        ON        1 = 1
                        AND        M.CARD_NUMB = B.CARD_NUMB
                WHERE    1 = 1
                  AND   M.BEFO_CARD    IS NOT NULL
                  AND   B.BILL_DATE LIKE #BILL_MONT# || '%'
                  AND   NOT EXISTS (
                        SELECT    *
                          FROM    TA_CARDAM A
                         WHERE    1 = 1
                           AND        A.CARD_NUMB = B.CARD_NUMB
                           AND        A.CARD_APPR = B.CARD_APPR
                           AND        A.APPR_DATE = B.APPR_DATE
                         )
                  AND   B.CARD_NUMB = REPLACE(#CARD_NUMB#,'-','')
            )
            LOOP

                TA_CARDBM_REC    := NULL;

                BEGIN

                    SELECT   *
                      INTO   TA_CARDAM_TMP
                      FROM   TA_CARDAM S
                     WHERE   1 = 1
                       AND   S.CARD_NUMB    = RS.BEFO_CARD           /* 이전카드번호 */
                       AND   S.APPR_DATE = RS.APPR_DATE
                       AND   S.CARD_APPR    = RS.CARD_APPR
                       AND   S.APPR_GUBN = RS.APPR_GUBN
                    ;

                    TA_CARDBM_REC.BILL_DATE := RS.BILL_DATE;   /* 청구일자 */
                    TA_CARDBM_REC.CARD_NUMB := RS.BEFO_CARD;   /* 이전카드번호 */
                    TA_CARDBM_REC.APPR_DATE := RS.APPR_DATE;   /* 이용일자 */
                    TA_CARDBM_REC.CARD_APPR := RS.CARD_APPR;   /* 승인번호 */
                    TA_CARDBM_REC.APPR_GUBN := RS.APPR_GUBN;   /* 승인구분 */

                    GOTO  TA_CARDBM_UPDATE;

                       EXCEPTION
                        WHEN NO_DATA_FOUND THEN
                            NULL;
                END;

                /* 승인번호로 한번 더 찾는다.. */
                   IF SUBSTR(RS.CARD_APPR,1,1) <> '0' THEN
                    BEGIN

                        SELECT    *
                          INTO    TA_CARDAM_TMP
                          FROM    TA_CARDAM S
                         WHERE    1 = 1
                           AND    S.CARD_NUMB = RS.BEFO_CARD
                           AND    S.APPR_DATE = RS.APPR_DATE
                           AND    S.CARD_APPR = '0' || RS.CARD_APPR
                           AND    S.APPR_GUBN = RS.APPR_GUBN
                        ;

                        TA_CARDBM_REC.BILL_DATE := RS.BILL_DATE;          /* 청구일자 */
                        TA_CARDBM_REC.CARD_NUMB := RS.BEFO_CARD;          /* 이전카드번호 */
                        TA_CARDBM_REC.APPR_DATE := RS.APPR_DATE;          /* 이용일자 */
                        TA_CARDBM_REC.CARD_APPR := '0' || RS.CARD_APPR;   /* 승인번호 */
                        TA_CARDBM_REC.APPR_GUBN := RS.APPR_GUBN;          /* 승인구분 */

                        GOTO  TA_CARDBM_UPDATE;

                    EXCEPTION
                        WHEN NO_DATA_FOUND THEN
                            NULL;
                    END;

                END IF;

                GOTO UPDATE_END;

                <<TA_CARDBM_UPDATE>>
                /* 카드청구내역관리 */
                UPDATE  TA_CARDBM SET
                         BILL_DATE   = TA_CARDBM_REC.BILL_DATE               /* 청구일자 */
                        ,CARD_NUMB   = TA_CARDBM_REC.CARD_NUMB               /* 카드번호 */
                        ,CARD_APPR   = TA_CARDBM_REC.CARD_APPR               /* 승인번호 */
                        ,APPR_GUBN   = TA_CARDBM_REC.APPR_GUBN               /* 승인구분 */
                        ,APPR_DATE   = TA_CARDBM_REC.APPR_DATE               /* 이용일자 */
                        ,UPDT_USID   = #UPDT_USID#                           /* 수정자 */
                        ,UPDT_DATE   = SYSDATE                           /* 수정일시 */
                WHERE   1 = 1
                  AND  BILL_DATE    = RS.BILL_DATE                           /* 청구일자 */
                  AND  CARD_NUMB    = RS.CARD_NUMB                           /* 카드번호 */
                  AND  CARD_APPR    = RS.CARD_APPR                           /* 승인번호 */
                  AND  APPR_GUBN    = RS.APPR_GUBN                           /* 승인구분 */
                  AND  APPR_DATE    = RS.APPR_DATE                           /* 이용일자 */
                ;

                <<UPDATE_END>>
                NULL;

            END LOOP;
        END;
        ]]>
    </insert>

</sqlMap>
