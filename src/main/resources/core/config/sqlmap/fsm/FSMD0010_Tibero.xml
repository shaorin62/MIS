<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"                  
		"http://www.ibatis.com/dtd/sql-map-2.dtd">                              
                                                                                                                      
<sqlMap namespace="FSMD0010">
<!-- 
/*******************************************************************************
     작  성  자 : 신민규
     작  성  일 : 2011. 06. 29
     내      용 : 감가상각 명세서 조회 처리
********************************************************************************/
 -->
	<select id="FSMD0010.SEARCH00" parameterClass="hashmap" resultClass = "hashmap">
		<![CDATA[
	             SELECT  /* FSMD0010.SEARCH00 감가상각 명세서 조회 처리 */
	             		 A.STDS_YMTH                                 /*기준년월*/
	                    ,A.ASCL_CODE                                 /*자산분류코드*/
	                    ,C.ASCL_NAME                                 /*자산분류명*/
	                    ,A.DEPT_CODE                                 /*부서코드*/
	                    ,SF_GET_DEPTNAME(A.DEPT_CODE) AS DEPT_NAME   /*부서명*/
	                    ,C.LARG_CODE                                 /*대분류코드*/
	                    ,C.LARG_NAME                                 /*대분류명*/
	                    ,C.MIDL_CODE                                 /*중분류코드*/
	                    ,C.MIDL_NAME                                 /*중분류명*/
	                    ,A.CLSF_CODE                                 /*품목분류코드(소분류코드)*/
	                    ,C.SMAL_NAME                                 /*소분류명*/
	                    ,A.ASST_NUMB                                 /*자산번호*/
	                    ,B.ASST_NAME                                 /*자산명*/
	                    ,B.ACQS_DATE                                 /*취득일*/
	                    ,A.DPCT_METH                                 /*상각방법[DPCT_METH]코드*/
	                    ,C.DPCT_MTNM                                 /*상각방법명*/
	                    ,A.PRID_DPCT                                 /*내용년수*/
	                    ,B.DPCT_RATE                                 /*감가상각율*/
	                    ,A.ACQU_BEGN                                 /*취득가_전기이월*/
	                    ,A.ACQU_GROW                                 /*취득가_당기증가*/
	                    ,A.ACQU_DCRS                                 /*취득가_당기감소*/
	                    ,A.ACQU_ENDX                                 /*취득가_기말잔액*/
	                    ,A.MONT_DPCT                                 /*당월상각액*/
	                    ,A.CRNT_DPCT                                 /*당기상각누적액*/
	                    ,A.DPTC_BEGN                                 /*충당금_전기이월*/
	                    ,A.DPCT_GROW                                 /*충당금_당기증가*/
	                    ,A.DPCT_DCRS                                 /*충당금_당기감소*/
	                    ,A.DPCT_ENDX                                 /*충당금_기말잔액*/
	                    ,A.UNDP_BALE                                 /*미상각잔액*/
	                    ,A.DESC_REMK                                 /*비고(100)*/
	                    ,A.PRID_LEGL                                 /*세무년수*/
	                    ,A.DPAJ_LMIT                                 /*상각범위액*/
	                    ,A.DPAJ_AMOT                                 /*시부인*/
	                    ,A.DPAJ_BEGN                                 /*시부인_전기이월*/
	                    ,A.DPAJ_GROW                                 /*시부인_당기증가(부인)*/
	                    ,A.DPAJ_DCRS                                 /*시부인_당기감소(추인)*/
	                    ,A.DPAJ_ENDX                                 /*시부인_기말잔액*/
	                    ,( SELECT D.COMD_CDNM
						 FROM VI_COMMCODE D
						WHERE D.COMM_CODE = 'ASST_CSCD'
							AND D.COMD_CODE = B.ASST_CSCD ) ASST_CSCD
	               FROM FS_DPCTXM A INNER JOIN FS_ASSTXM B
	                                        ON A.ASST_NUMB = B.ASST_NUMB
	                                INNER JOIN VI_ASSETCLASS C
	                                        ON B.CLSF_CODE = C.SMAL_CODE
	              WHERE 1=1
	              AND A.STDS_YMTH = #STDS_YMTH#                     /*기준년월*/
        ]]>
        <isNotEmpty property = "ASCL_CODE" prepend = "AND">
                   A.ASCL_CODE = NVL(#ASCL_CODE#, C.ASCL_CODE)   /*자산분류*/
        </isNotEmpty>  
        <isNotEmpty property = "CLSF_CODE" prepend = "AND">
                   A.CLSF_CODE = NVL(#CLSF_CODE#, B.CLSF_CODE)   /*품목분류*/
        </isNotEmpty>
        <isNotEmpty property = "ACQS_DATE" prepend = "AND">
                   B.ACQS_DATE = NVL(#ACQS_DATE#, B.ACQS_DATE)   /*취득일자*/
        </isNotEmpty>                          
        <![CDATA[       	              
	              ORDER BY A.ASCL_CODE, A.DEPT_CODE, ASST_CSCD
		]]>
	</select>
<!-- 
/*******************************************************************************
     작  성  자 : 신민규
     작  성  일 : 2016. 07. 26
     내      용 : 감가상각 처리
********************************************************************************/
 -->
	<insert id="FSMD0010.PROC00" parameterClass="hashmap" >
		<![CDATA[
		DECLARE
            /* FSMD0010.PROC00.감가상각 처리  */ 
			CNT            DECIMAL(15,0);              /*상각여부*/
		    nMValue          DECIMAL(15,0);            /*비망가액*/
		    tDPCT_YEAR       DECIMAL(15,0);            /*정액법 년 상각액*/
		    tDPCT_DIFF       DECIMAL(15,0);            /*보정액Tmp*/
		    nBalance         DECIMAL(15,0);            /*미상각잔액Tmp*/
		    sBEFORE_MONTH    FS_DPCTXM.STDS_YMTH%TYPE; /*전달*/
		    tACQU_GROW       FS_DPCTXM.ACQU_GROW%TYPE; /*취득가_당기증가*/
		    tACQU_DCRS       FS_DPCTXM.ACQU_DCRS%TYPE; /*취득가_당기감소*/
		    tDPCT_GROW       FS_DPCTXM.DPCT_GROW%TYPE; /*충당금_당기증가*/
		    tDPCT_DCRS       FS_DPCTXM.DPCT_DCRS%TYPE; /*충당금_당기감소*/
		    tACQU_ENDX       FS_DPCTXM.ACQU_ENDX%TYPE; /*취득가 기말잔액*/
		    tMONT_DPCT       FS_DPCTXM.MONT_DPCT%TYPE; /*당월상각액*/
		    tCRNT_DPCT       FS_DPCTXM.CRNT_DPCT%TYPE; /*당기상각누적액*/
		    tDPCT_ENDX       FS_DPCTXM.DPCT_ENDX%TYPE; /*충당금_기말잔액*/
		    tUNDP_BALE       FS_DPCTXM.UNDP_BALE%TYPE; /*미상각잔액*/
		
	    BEGIN
	
	
	        /****************+
	        |  1.전달구하기  |
	        +****************/
	        SELECT TO_CHAR(TO_DATE(#STDS_YMTH#, 'YYYYMM') - 1, 'YYYYMM') INTO sBEFORE_MONTH FROM DUAL;
	
	        /******************************+
	        |  2.전달의 상각처리 완료여부  |
	        +******************************/
	        SELECT COUNT(STDS_YMTH)
              INTO CNT
              FROM FS_DPCTXM
             WHERE STDS_YMTH = sBEFORE_MONTH;
             
	        IF (CNT = 0) THEN
	           RAISE_APPLICATION_ERROR(-20000, SUBSTR(sBEFORE_MONTH, 1, 4) || '년 ' || SUBSTR(sBEFORE_MONTH, 5, 2) || '월의 상각데이터가 없습니다!.\n\n상각처리가 불가 합니다!');
	        END IF;
	
	        /********************************+
	        |  3.현재달의 상각처리 완료여부  |
	        +********************************/
	        SELECT COUNT(STDS_YMTH)
              INTO CNT
              FROM FS_DPCTXM
             WHERE STDS_YMTH = #STDS_YMTH#;
             
	        IF (CNT > 0) THEN
	           RAISE_APPLICATION_ERROR(-20000, SUBSTR(#STDS_YMTH#, 1, 4) || '년 ' || SUBSTR(#STDS_YMTH#, 5, 2) || '월은 이미 상각이 완료되었습니다!\n\n상각처리 취소 후 실행가능 합니다!');
	        END IF;
	
	        /****************************************************************+
	        |  4.감가상각 하려는 년월의 자산변동관리에서 미승인 데이터 체크  |
	        +****************************************************************/
	        SELECT
	         COUNT(ASST_NUMB) INTO CNT
	          FROM FS_ASCHXM
	         WHERE RCGN_YSNO = '0'                        /*미승인이고*/
	           AND CHNG_DATE LIKE #STDS_YMTH#||'%'        /*변동년월이 감가상각 하려는 년월이고*/
	           AND ASCH_GUBN                              /*변동구분이 신규취득, 자산대체, 자본적지출, 매각, 매각, 부분매각, 폐기, 부분폐기, 기증, 불용 인것*/
	            IN (SELECT COMD_CODE FROM TM_CODEXD WHERE COMD_CODE = 'ASCH_GUBN' AND (REF1_FILD = 'AUTO' OR REF1_FILD = 'ASCH'));
	
	        IF (CNT > 0) THEN
	           RAISE_APPLICATION_ERROR(-20000, SUBSTR(#STDS_YMTH#, 1, 4) || '년 ' || SUBSTR(#STDS_YMTH#, 5, 2) || '월에 미승인된 변동이력이 있습니다!.\n\n상각처리가 불가 합니다!');
	        END IF;
	
	        /****************************************************************+
	        |  5.감가상각 하려는 년월의 자산이동관리에서 미승인 데이터 체크  |
	        +****************************************************************/
	        SELECT
	         COUNT(ASST_NUMB) INTO CNT
	          FROM FS_ASCHXM
	         WHERE RCGN_YSNO = '0'                        /* 미승인이고*/
	           AND CHNG_DATE LIKE #STDS_YMTH#||'%'        /* 변동년월이 감가상각 하려는 년월이고*/
	           AND ASCH_GUBN                             /* 변동구분이 부서이동, 사원변경인 것*/
	            IN (SELECT COMD_CODE FROM TM_CODEXD WHERE COMD_CODE = 'ASCH_GUBN' AND REF1_FILD = 'MOVE');
	
	        IF (CNT > 0) THEN
	           RAISE_APPLICATION_ERROR(-20000, SUBSTR(#STDS_YMTH#, 1, 4) || '년 ' || SUBSTR(#STDS_YMTH#, 5, 2) || '월에 미승인된 이동이력이 있습니다!.\n\n상각처리가 불가 합니다!');
	        END IF;
	
	        /************************************************************+
	        |  6.감가상각 하려는 년월의 자산분할이력 미승인 데이터 체크  |
	        +************************************************************/
	        SELECT
	         COUNT(ASST_NUMB) INTO CNT
	          FROM FS_ASSPXM
	         WHERE RCGN_YSNO = '0'                       /*미승인이고*/
	           AND SUBSTR(SPLT_DATE, 1, 6) = #STDS_YMTH#; /*분할년월이 감가상각 하려는 년월인것*/
	
	        IF (CNT > 0) THEN
	           RAISE_APPLICATION_ERROR(-20000, SUBSTR(#STDS_YMTH#, 1, 4) || '년 ' || SUBSTR(#STDS_YMTH#, 5, 2) || '월에 미승인된 분할이력이 있습니다!.\n\n상각처리가 불가 합니다!');
	        END IF;
	
	
	        /************************************************************+
	        |                                                           |
	        |*******************| 감가상각 처리 시작| *******************|
	        |                   
	        1) 정액,정률,내용년수,미상각액기준으로 4가지 방식 구현. 유휴구분 추가, NSE에서는  정액법만 사용(2014.11)
	           - 정액법추가조건:: 월기준 감가상각처리때문에 년기준 상각액과 차이금액 발생. 그래서 12월이면 차이금액 보정함(당해 1월자산도 보정)
	        2) 시부인도 정액법 기준 차이금액 보정, 정률법은 기존처럼 진행됨.
	        3) 작업 순서::
	           - 해당월 감가상각 기준데이터 생성.
	           - 변동관리TB(취득가,충당금 당기증가 OR 당기감소) 확인후 계산
	           - 해당월 감가상각진행(유휴 구분, 정액법에 따른)
	             a. 유휴가 아닌것, 미상각잔액(비망가액) 1000원 이상, 감가시작월인 자산 포함
	             b. 유휴를 적용해도 내용년수가 지난것은 감가완료처리 됨.
	                -유휴일경우 정액법>>미상각잔액 으로 처리하면 금액기준으로 되니까 내용년수와는 상관없이 처리됨. 유휴조건 자산 얼마 안됨
	           -정액법: (취득원가-잔존가치(NSE사용안함) / 내용년수
	           -정률법: (취득원가-감가상각누계액) * 정률법, 비망가액 5%
	        4) 미상각잔액 업데이트는 전표처리시 실행됨 [월별 전표처리 요망]
	        5) 무형자산일경우 비망가액 없음
	        |
	        +************************************************************/
	
	        /*****************************************+
	        |  7.감가상각하려는 년월이 1월인지 체크.  |
	        +*****************************************/
	        /*이유 : 1월이면 전기이월액 및 당기감소, 증가분을 0으로 해줘야 하기 때문에, 시부인 추가*/
	        SELECT TO_NUMBER(SUBSTR(#STDS_YMTH#, 5, 2)) INTO CNT FROM DUAL;
	
	        /********************************************************+
	        |  8.전달의 데이터로 감가상각, 시부인 기초 데이터를 생성해준다.  |
	        +********************************************************/
	        INSERT INTO FS_DPCTXM ( /*[감가상각]*/
	               STDS_YMTH        /*기준년월*/
	              ,ASST_NUMB        /*자산번호*/
	              ,ASCL_CODE        /*자산분류코드*/
	              ,CLSF_CODE        /*품목분류코드*/
	              ,DEPT_CODE        /*부서코드*/
	              ,DPCT_METH        /*상각방법[DPCT_METH]*/
	              ,PRID_DPCT        /*내용년수*/
	              ,ACQU_BEGN        /*취득가_전기이월*/
	              ,ACQU_GROW        /*취득가_당기증가*/
	              ,ACQU_DCRS        /*취득가_당기감소*/
	              ,ACQU_ENDX        /*취득가_기말잔액*/
	              ,MONT_DPCT        /*당월상각액*/
	              ,CRNT_DPCT        /*당기상각누적액*/
	              ,DPTC_BEGN        /*충당금_전기이월*/
	              ,DPCT_GROW        /*충당금_당기증가*/
	              ,DPCT_DCRS        /*충당금_당기감소*/
	              ,DPCT_ENDX        /*충당금_기말잔액*/
	              ,UNDP_BALE        /*미상각잔액*/
	              ,DESC_REMK        /*비고(100)*/
	              ,PRID_LEGL        /*세무(법인)년수*/
	              ,DPAJ_LMIT        /*상각범위액*/
	              ,DPAJ_AMOT        /*시부인*/
	              ,DPAJ_BEGN        /*시부인_전기이월*/
	              ,DPAJ_GROW        /*시부인_당기증가(부인)*/
	              ,DPAJ_DCRS        /*시부인_당기감소(추인)*/
	              ,DPAJ_ENDX        /*시부인_기말잔액*/
	              ,INST_DATE        /*등록일시*/
	              ,INST_USID        /*등록자*/
	              ,UPDT_DATE        /*수정일시*/
	              ,UPDT_USID        /*수정자*/
	              )
	
	        SELECT   #STDS_YMTH#                                          /*기준년월*/
	               ,A.ASST_NUMB                                          /*자산번호*/
	               ,B.ASCL_CODE                                          /*자산분류코드*/
	               ,A.CLSF_CODE                                          /*자산품목코드*/
	               ,A.DEPT_CODE                                          /*부서코드*/
	               ,A.DPCT_METH                                          /*상각방법[DPCT_METH]*/
	               ,A.PRID_DPCT                                          /*내용년수*/
	               ,NVL(DECODE(CNT, 1, C.ACQU_ENDX, C.ACQU_BEGN), 0)    /*취득가_전기이월(1월이면 전년도12월의 취득가 기말잔액을 가져와야 함)*/
	               ,NVL(DECODE(CNT, 1, 0, C.ACQU_GROW), 0)              /*취득가_당기증가(년도가 바뀔때까지 계속 SUM)*/
	               ,NVL(DECODE(CNT, 1, 0, C.ACQU_DCRS), 0)              /*취득가_당기감소(년도가 바뀔때까지 계속 SUM)*/
	               ,0                                                    /*취득가_기말잔액계산(전기이월 + 당기증가 - 당기감소)*/
	               ,0                                                    /*당월상각액 계산(구해주기)*/
	               ,NVL(DECODE(CNT, 1, 0, C.CRNT_DPCT), 0)              /*당기상각누적액(년도가 바뀔때까지 SUM)*/
	               ,NVL(DECODE(CNT, 1, C.DPCT_ENDX, C.DPTC_BEGN), 0)    /*충당금_전기이월(1월이면 전년도 12월의 충당금 기말잔액을 가져와야 함)*/
	               ,NVL(DECODE(CNT, 1, 0, C.DPCT_GROW), 0)              /*충당금_당기증가(년도가 바뀔때까지 계속 SUM)*/
	               ,NVL(DECODE(CNT, 1, 0, C.DPCT_DCRS), 0)              /*충당금_당기감소(년도가 바뀔때까지 계속 SUM)*/
	               ,NVL(C.DPCT_ENDX, 0)                                  /*충당금_기말잔액계산(전기이월 + 당기증가 - 당기감소)이지만당월감가상각액계산시필요해서전월치를 가져감*/
	               ,NVL(C.UNDP_BALE, 0)                                  /*미상각잔액계산*/
	               ,''                                                   /*비고(100)*/
	               ,A.PRID_LEGL                                                     /*세무년수*/
	               ,0                                                               /*상각범위액*/
	               ,0                                                               /*시부인*/
	               ,NVL(DECODE(C.BASE_MNTH, '12', C.DPAJ_ENDX, C.DPAJ_BEGN), 0)     /*시부인_전기이월*/
	               ,NVL(DECODE(CNT, 1, 0, C.DPAJ_GROW), 0)                         /*시부인_당기증가(부인) 년도가 바뀔때까지 계속 SUM*/
	               ,NVL(DECODE(CNT, 1, 0, C.DPAJ_DCRS), 0)                         /*시부인_당기감소(추인) 년도가 바뀔때까지 계속 SUM*/
	               ,0                                                               /*시부인_기말잔액*/
	               ,SYSDATE                                           /*등록일시*/
	               ,#UPDT_USID#                                           /*등록자*/
	               ,SYSDATE                                           /*수정일시*/
	               ,#UPDT_USID#                                           /*수정자*/
	          FROM FS_ASSTXM A
	               INNER JOIN FS_CLSFXM B   /*[품목분류]*/
	                       ON A.CLSF_CODE = B.CLSF_CODE
	                LEFT JOIN ( SELECT A.*
	                                 , COUNT(*) OVER (PARTITION BY ASST_NUMB ORDER BY STDS_YMTH DESC)  AS DEPR_SEQN    /*최근 상각자료 순서*/
	                                 , CASE WHEN SUBSTR(#STDS_YMTH#, 1, 4) <> SUBSTR(A.STDS_YMTH, 1, 4) THEN UNISTR('12')
                                       ELSE SUBSTR(A.STDS_YMTH, 5, 2)
                                       END  AS BASE_MNTH
	                             FROM FS_DPCTXM A
	                             WHERE A.STDS_YMTH <  #STDS_YMTH#
	                          ) C   /*[감가상각]*/
	                       ON A.ASST_NUMB = C.ASST_NUMB
	                       AND C.DEPR_SEQN = 1   /*가장 최근 자료를 사용.*/
	         WHERE A.ACQS_DATE <= #STDS_YMTH#||'31'      /*취득일자*/
	           /*AND A.DPCT_STAT IN ('INPR', 'CMPT')  */    /*상각상태: INPR.사용중, CMPT.상각완료 << 당기 상각 완료 자산도 포함시키기 위하여 제외 함.*/
	           AND (   A.ASST_STAT IN ('USIG', 'USLS')  /*자산상태: USIG.사용중, USLS.불용*/
	                OR A.ASST_NUMB IN (SELECT ASST_NUMB
	                                   FROM FS_ASCHXM /*[자산변동이력]*/
	                                   WHERE CHNG_DATE LIKE SUBSTR(#STDS_YMTH#, 1, 4)||'%'
	                                     AND ASCH_GUBN IN ('SAAL', 'DSAL', 'DONA') /*매각,폐기,기증*/
	                              ) /*당기 매각/폐기/기증 자산은 상각처리에 포함 시킴.*/
	               )
	        ;
	
	        /******************************************************************************************+
	        |  9.감가상각에 필요한 변동테이블데이터를 계산해준다.(취득가,충당금 당기증가 OR 당기감소)  |
	        +******************************************************************************************/
	
	        FOR CUR_ASCHXM IN (
	
	            SELECT  A.ASST_NUMB    /*자산번호*/
	                   ,SUM(DECODE(TO_NUMBER(B.REF4_FILD),  1, A.CHNG_AMOT, 0)) AS ACQU_GROW /* 취득가 당기증가*/
	                   ,SUM(DECODE(TO_NUMBER(B.REF4_FILD), -1, A.CHNG_AMOT, 0)) AS ACQU_DCRS /* 취득가 당기감소*/
	                   ,SUM(DECODE(TO_NUMBER(B.REF4_FILD),  1, A.DPCT_GRDC, 0)) AS DPCT_GROW /* 충당금 당기증가*/
	                   ,SUM(DECODE(TO_NUMBER(B.REF4_FILD), -1, A.DPCT_GRDC, 0)) AS DPCT_DCRS /* 충당금 당기감소*/
	              FROM FS_ASCHXM A INNER JOIN TM_CODEXD B
	                                       ON A.ASCH_GUBN = B.COMD_CODE
	                                      AND B.COMM_CODE = 'ASCH_GUBN'
	                                      AND (B.REF1_FILD = 'AUTO' OR B.REF1_FILD = 'ASCH' OR B.REF1_FILD = 'SPLT') /* 이동인것은 빼준다.*/
	             WHERE A.CHNG_DATE LIKE #STDS_YMTH# || '%'
	          GROUP BY A.ASST_NUMB
	
	                          )
	
	        LOOP
	
	             tACQU_GROW := CUR_ASCHXM.ACQU_GROW; /* 취득가 당기증가*/
	             tACQU_DCRS := CUR_ASCHXM.ACQU_DCRS; /* 취득가 당기감소*/
	             tDPCT_GROW := CUR_ASCHXM.DPCT_GROW; /* 충당금 당기증가*/
	             tDPCT_DCRS := CUR_ASCHXM.DPCT_DCRS; /* 충당금 당기감소*/
	
	            UPDATE FS_DPCTXM A                /*[감가강각]*/
	               SET  ACQU_GROW = A.ACQU_GROW + tACQU_GROW  /*취득가_당기증가*/
	                   ,ACQU_DCRS = A.ACQU_DCRS + tACQU_DCRS  /*취득가_당기감소*/
	                   ,DPCT_GROW = A.DPCT_GROW + tDPCT_GROW  /*충당금_당기증가*/
	                   ,DPCT_DCRS = A.DPCT_DCRS + tDPCT_DCRS  /*충당금_당기감소*/
	             WHERE STDS_YMTH  = #STDS_YMTH#  /*기준년월*/
	               AND ASST_NUMB  = CUR_ASCHXM.ASST_NUMB  /*자산번호*/
	               ;
	
	        END LOOP;
	
	        /*********************************************************************************************************************+
	        |  10.모든데이터의 취득가기말잔액,당월상각액, 당기상각누적액, 충당금당기증가, 충당금기말잔액,미상각잔액을 구해준다.   |
	        +*********************************************************************************************************************/
	        nMValue := 1000;   /*비망액 설정*/
	
	       FOR CUR_DPCTXM IN (
	
	            SELECT
	                    A.ASCL_CODE    /*자산분류코드*/
	                   ,A.ASST_NUMB    /*자산번호*/
	                   ,A.ACQU_BEGN    /*취득가_전기이월*/
	                   ,A.ACQU_GROW    /*취득가_당기증가*/
	                   ,A.ACQU_DCRS    /*취득가_당기감소*/
	                   ,A.CRNT_DPCT    /*당기상각누적액*/
	                   ,A.DPTC_BEGN    /*충당금_전기이월*/
	                   ,A.DPCT_GROW    /*충당금_당기증가*/
	                   ,A.DPCT_DCRS    /*충당금_당기감소*/
	                   ,A.DPCT_ENDX    /*충당금_기말잔액*/
	                   ,A.UNDP_BALE    /*미상각잔액*/
	                   ,B.SAVG_VALU    /*잔존가액*/
	                   ,MONTHS_BETWEEN(ADD_MONTHS(TO_DATE(SUBSTR(B.ACQS_DATE, 1, 6) || '01', 'YYYYMMDD') , A.PRID_DPCT * 12), TO_DATE(#STDS_YMTH# || '01', 'YYYYMMDD')) AS RMAN_MONT /* 잔여상각월수*/
	                   ,B.DPCT_CYCL    /*상각주기*/
	                   ,B.DPCT_STAT    /*상각상태*/
	                   ,B.ASST_STAT    /*자산상태*/
	                   /*,C.DPCT_CMPT */   /*상각완료기준*/
	                   ,B.DPCT_CMPT     /*상각완료기준 201412. 자산등록TB에개별 상각완료기준추가함*/
	                   ,B.DPCT_METH    /*상각방법*/
	                   ,B.IDLE_YSNO    /*유휴관리*/
	                   ,A.PRID_DPCT    /*내용년수*/
	                   ,D.AMOT_RT01    /*정액상각*/
	                   ,D.AMOT_RT02    /*정률상각*/
	                   ,B.ACQS_DATE    /*자산취득일자*/
	              FROM FS_DPCTXM A INNER JOIN FS_ASSTXM B
	                                       ON A.ASST_NUMB = B.ASST_NUMB
	                               INNER JOIN VI_ASSETCLASS C
	                                        ON B.CLSF_CODE = C.SMAL_CODE
	                               /*LEFT OUTER JOIN FS_AMRATE D ON SUBSTR(A.STDS_YMTH,1,4) = D.STDS_YEAR AND A.PRID_DPCT=D.PRID_DPCT*/
	                                /*상각율 data 없으면 조회년도 기준 으로 최근꺼 가져오기*/
	                                LEFT OUTER JOIN(
	                                        SELECT
	                                           STDS_YEAR, PRID_DPCT, AMOT_RT01, AMOT_RT02
	                                        FROM FS_AMRATE
	                                        WHERE STDS_YEAR = (SELECT MAX(STDS_YEAR) FROM FS_AMRATE
	                                                            WHERE STDS_YEAR <= SUBSTR(#STDS_YMTH#,1,4))
	                                    ) D ON A.PRID_DPCT=D.PRID_DPCT
	
	             WHERE A.STDS_YMTH = #STDS_YMTH#
	
	        )
	
	        LOOP
	
	            /*취득가기말잔액 = 전기이월             + 당기증가             - 당기감소*/
	             tACQU_ENDX      := CUR_DPCTXM.ACQU_BEGN + CUR_DPCTXM.ACQU_GROW - CUR_DPCTXM.ACQU_DCRS;
	
	            /*정액법 년 상각액 구하기 (취득가-잔존가치(사용안함))/내용년수*/
	            tDPCT_YEAR       :=  TRUNC(tACQU_ENDX * CUR_DPCTXM.AMOT_RT01);
	
	            /*무형자산 비망가액=0*/
	            IF CUR_DPCTXM.ASCL_CODE = '80' THEN
	                nMValue := 0;
	            END IF;
	
	            /* 유휴구분으로 감가상각 대상 구분 */
	            IF  CUR_DPCTXM.IDLE_YSNO = '1' THEN
	              tMONT_DPCT   := 0;                        /*당월상각액*/
	            ELSE
	
	                /* 감가상각 시작월인경우 미상각잔액이 0임.이경우도 조건 타야됨,  OR  미상각 잔액이 있는지 확인*/
	                IF SUBSTR(CUR_DPCTXM.ACQS_DATE,1,6) = #STDS_YMTH#  OR CUR_DPCTXM.UNDP_BALE > 1000 THEN
	
	                    IF CUR_DPCTXM.DPCT_CYCL = 'NONE'                             /*상각주기[DPCT_CYCL]: NONE.미상각*/
	                        OR CUR_DPCTXM.DPCT_STAT = 'NOTG'                         /*상각상태[DPCT_STAT]: NOTG.미대상*/
	                        OR CUR_DPCTXM.ASST_STAT IN ('SALE', 'DSUS', 'DONA') THEN /*자산상태[ASST_STAT]: 매각,폐기,기증*/
	                        tMONT_DPCT   := 0;
	                    ELSE
	
	                        /*상각완료기준에 따른 구분 PRID:내용년수, DPCT:미상각잔액*/
	                        IF CUR_DPCTXM.DPCT_CMPT = 'PRID' THEN     /*내용년수*/
	
	                            /*상각방법에 따른 당월상각액*/
	                            IF CUR_DPCTXM.DPCT_METH = 'STRT' THEN       /*정액법*/
	
	                                /*[보정] 조건월이 12월 일경우 & 당해 1월 취득 포함. 그이외 자산은 제외*/
	                                IF SUBSTR(#STDS_YMTH#,5,2) = '12' AND SUBSTR(#STDS_YMTH#,1,4)||'01' >= SUBSTR(CUR_DPCTXM.ACQS_DATE,1,6) THEN
	                                    /*보정액 (년상각액- 11월 까지상각액)*/
	                                    tDPCT_DIFF       :=  TRUNC(tDPCT_YEAR - CUR_DPCTXM.CRNT_DPCT);
	                                    /*최종 보정금액*/
	                                    tMONT_DPCT       :=  TRUNC(tDPCT_DIFF);
	
	                                ELSE
	                                    tMONT_DPCT   := TRUNC((tACQU_ENDX * CUR_DPCTXM.AMOT_RT01) / 12);
	
	                                END IF;
	
	                            ELSIF CUR_DPCTXM.DPCT_METH = 'DMNS' THEN    /*정률법*/
	                              /*당월 정률법      =  취득가 기말잔액 - 충당금 기말잔액       *  정률   */
	                              tMONT_DPCT   := TRUNC(((tACQU_ENDX - CUR_DPCTXM.DPCT_ENDX) * CUR_DPCTXM.AMOT_RT02) / 12);
	                            END IF;
	
	
	                            /* 상각월수가 마지막 월 일때 OR  비망가액 비교조건 [ 잔존가액<(당월 상각액+비망액) ]*/
	                            /*                              취득가 기말잔액 - 충당금 기말잔액*/
	                            IF CUR_DPCTXM.RMAN_MONT = 0 OR ((tACQU_ENDX - CUR_DPCTXM.DPCT_ENDX) < (tMONT_DPCT+ nMValue)) THEN
	
	                                tMONT_DPCT   := TRUNC((tACQU_ENDX - CUR_DPCTXM.DPCT_ENDX) - nMValue);
	
	                            END IF;
	
	
	                        ELSIF CUR_DPCTXM.DPCT_CMPT = 'DPCT'  THEN       /*미상각잔액*/
	
	                            /*상각방법에 따른 당월상각액*/
	                            IF CUR_DPCTXM.DPCT_METH = 'STRT' THEN       /*정액법*/
	                                /*  당월상각  =    취득가 기말잔액 * 정액상각 / 12(월단위 계산 이라서)  */
	                                /*tMONT_DPCT   := TRUNC((tACQU_ENDX * CUR_DPCTXM.AMOT_RT01) / 12);*/
	
	                                /*조건월이 12월 일경우 & 당해 1월 취득 포함. 그이외 자산은 제외*/
	                                IF SUBSTR(#STDS_YMTH#,5,2) = '12' AND SUBSTR(#STDS_YMTH#,1,4)||'01' >= SUBSTR(CUR_DPCTXM.ACQS_DATE,1,6) THEN
	                                    /*보정액 (년상각액- 11월 까지상각액)*/
	                                    tDPCT_DIFF       :=  TRUNC(tDPCT_YEAR - CUR_DPCTXM.CRNT_DPCT);
	                                    /*최종 보정금액*/
	                                    tMONT_DPCT       :=  TRUNC(tDPCT_DIFF);
	
	                                ELSE
	                                    tMONT_DPCT   := TRUNC((tACQU_ENDX * CUR_DPCTXM.AMOT_RT01) / 12);
	
	                                END IF;
	
	                                /*비망가액 비교조건*/
	                                nBalance  := (tACQU_ENDX - CUR_DPCTXM.DPCT_ENDX);
	
	                            ELSIF CUR_DPCTXM.DPCT_METH = 'DMNS' THEN    /*정률법*/
	                                /*당월 정률법 =  취득가 기말잔액 -  충당금 기말잔액       *  정률상각  */
	                                tMONT_DPCT   := TRUNC(((tACQU_ENDX - CUR_DPCTXM.DPCT_ENDX) * CUR_DPCTXM.AMOT_RT02) / 12);
	
	                                /* 취득가액의 5%*/
	                                nBalance  := TRUNC(tACQU_ENDX * 0.05);
	
	                            END IF;

	                            /*비망가액 비교조건 [ 잔존가액<(당월 상각액+비망액) ]*/
	                            IF nBalance < (tMONT_DPCT+ nMValue) THEN
	                                tMONT_DPCT   := TRUNC(nBalance - nMValue);
	                            END IF;
	
	                         END IF;
	
	                     END IF;
	
	                ELSE
	                    tMONT_DPCT   := 0;
	
	                 END IF;
	
	             END IF;
	
	             /*당기상각누적액 = 당기상각누적액       + 당월상각액*/
	             tCRNT_DPCT      := CUR_DPCTXM.CRNT_DPCT + tMONT_DPCT;
	
	             /*충당금당기증가 = 당기증가             + 당월상각액*/
	             tDPCT_GROW      := CUR_DPCTXM.DPCT_GROW + tMONT_DPCT;
	
	             /*충당금기말잔액 = 충당금 전기이월   + 충당금당기증가 - 충당금 당기감소 */
	             tDPCT_ENDX      := CUR_DPCTXM.DPTC_BEGN + tDPCT_GROW - CUR_DPCTXM.DPCT_DCRS;
	
	             /*미상각잔액     = 취득가기말잔액 - 충당금기말잔액*/
	             tUNDP_BALE      := tACQU_ENDX     - tDPCT_ENDX;
	
	             UPDATE FS_DPCTXM                /*[감가상각]*/
	                SET  ACQU_ENDX = tACQU_ENDX  /*취득가_기말잔액*/
	                    ,MONT_DPCT = tMONT_DPCT  /*당월상각액*/
	                    ,CRNT_DPCT = tCRNT_DPCT  /*당기상각누적액*/
	                    ,DPCT_GROW = tDPCT_GROW  /*충당금당기증가*/
	                    ,DPCT_ENDX = tDPCT_ENDX  /*충당금_기말잔액*/
	                    ,UNDP_BALE = tUNDP_BALE  /*미상각잔액*/
	                    ,DESC_REMK = SUBSTR(#STDS_YMTH#, 1, 4) || '년 ' || SUBSTR(#STDS_YMTH#, 5, 2) || '월 감가상각'  /*비고(100)*/
	              WHERE STDS_YMTH  = #STDS_YMTH#  /*기준년월*/
	                AND ASST_NUMB  = CUR_DPCTXM.ASST_NUMB  /*자산번호*/
	                ;
	
	        END LOOP;
	
	     
	    END;
		]]>
	</insert>
<!-- 
/*******************************************************************************
     작  성  자 : 김삼영
     작  성  일 : 2013.10.15
     내      용 : 감가상각 시부인 처리
********************************************************************************/
 -->
	<insert id="FSMD0010.PROC00_POST" parameterClass="hashmap" >
		<![CDATA[
		DECLARE
            /* FSMD0010.PROC00_POST 감가상각 시부인 처리 */ 
			sBEFO_MONT      FS_DPCTXM.STDS_YMTH%TYPE;   /*조회월의 전월*/
	        dBASE_ENDT      DATE;                       /*기준년월 종료일자*/
	        nBASE_MCNT      FS_DPCTXM.PRID_DPCT%TYPE;   /*당기 세무 상각월수*/
	        dBEFO_ENDT      DATE;                       /*전년도말 종료일자*/
	
	        nMValue          DECIMAL(15,0);            /*비망가액*/
	        nBalance         DECIMAL(15,0);            /*시부인 취득가액*/
	        nDPAJ_DPCT       DECIMAL(15,0);            /*시부인 당기상각 누적액*/
	        tDPCT_YEAR       DECIMAL(15,0);            /*정액법 년 상각액*/
	        tDPCT_DIFF       DECIMAL(15,0);            /*보정액Tmp*/
	        tACQU_ENDX       FS_DPCTXM.ACQU_ENDX%TYPE; /*취득가 기말잔액*/
	        tMONT_DPCT       FS_DPCTXM.MONT_DPCT%TYPE; /*당월상각액*/
	        B_DPAJ_ENDX      FS_DPCTXM.DPAJ_ENDX%TYPE; /*전월_시부인_전기이월*/
	        B_CRNT_DPCT      FS_DPCTXM.CRNT_DPCT%TYPE; /*전월_당기상각누적액*/
	
	        nDPAJ_LMIT      FS_DPCTXM.DPAJ_LMIT%TYPE;   /*상각범위액*/
	        nDPAJ_AMOT      FS_DPCTXM.DPAJ_AMOT%TYPE;   /*시부인*/
	        nDPAJ_BEGN      FS_DPCTXM.DPAJ_BEGN%TYPE;   /*시부인_전기이월*/
	        nDPAJ_GROW      FS_DPCTXM.DPAJ_GROW%TYPE;   /*시부인_당기증가(부인)*/
	        nDPAJ_DCRS      FS_DPCTXM.DPAJ_DCRS%TYPE;   /*시부인_당기감소(추인)*/
	        nDPAJ_ENDX      FS_DPCTXM.DPAJ_ENDX%TYPE;   /*시부인_기말잔액*/
	
	    BEGIN
	
	        sBEFO_MONT := TO_CHAR(TO_DATE(#STDS_YMTH#, 'YYYYMM') - 1, 'YYYYMM');         /*전월*/
	        dBASE_ENDT := LAST_DAY(TO_DATE(#STDS_YMTH#||'01', 'YYYYMMDD'));              /*기준년월 종료일자*/
	        nBASE_MCNT := TO_NUMBER(SUBSTR(#STDS_YMTH#, 5, 2));                          /*기준년도 상각월수*/
	        dBEFO_ENDT := TO_DATE((SUBSTR(#STDS_YMTH#, 1, 4)-1)||'1231', 'YYYYMMDD');    /*전년도말 종료일자*/
	        nMValue    := 1000;   /*비망액 설정*/
	        nBalance   := 0;      /*시부인 취득가액*/
	        nDPAJ_DPCT := 0;      /*시부인 당기상각 누적액*/
	
	        FOR CUR_DPCTXM IN (
	
	            SELECT
	                    A.ASCL_CODE    /*자산분류코드*/
	                   ,A.ASST_NUMB    /*자산번호*/
	                   ,B.ACQS_DATE    /*자산 취득일*/
	                   ,A.ACQU_ENDX    /*취득가 기말*/
	                   ,A.CRNT_DPCT    /*당기상각누적액*/
	                   ,A.MONT_DPCT    /*당월상각액*/
	                   ,MONTHS_BETWEEN(ADD_MONTHS(TO_DATE(SUBSTR(B.ACQS_DATE, 1, 6) || '01', 'YYYYMMDD') , A.PRID_LEGL * 12), TO_DATE(#STDS_YMTH# || '01', 'YYYYMMDD')) AS RMAN_MONT /* 세무상_상각종료월*/
	                   /*,C.DPCT_CMPT*//*상각완료기준*/
	                   ,B.DPCT_CMPT
	                   ,B.DPCT_METH    /*상각방법*/
	                   ,B.IDLE_YSNO    /*유휴관리*/
	                   ,A.PRID_DPCT    /*내용년수*/
	                   ,A.PRID_LEGL    /*법정(세무)년수*/
	                   ,D.AMOT_RT01    /*정액상각*/
	                   ,D.AMOT_RT02    /*정률상각*/
	                   ,NVL(A.DPAJ_BEGN,0) AS DPAJ_BEGN   	  /*시부인_전기이월*/
	                   ,NVL(A.DPAJ_GROW,0) AS DPAJ_GROW   	  /*시부인_당기증가_부인*/
	                   ,NVL(E.B_DPAJ_ENDX, 0) AS B_DPAJ_ENDX  /*전월_시부인 기말잔액*/
	                   ,NVL(E.B_CRNT_DPCT, 0) AS B_CRNT_DPCT  /*전월_당기상각누적액*/
	                   ,NVL(E.B_ACQU_ENDX, 0) AS B_ACQU_ENDX  /*전월_취득가기말잔액*/
	                   ,NVL(E.B_DPAJ_GROW, 0) AS B_DPAJ_GROW  /*전월_시부인_당기증가_부인*/
	              FROM FS_DPCTXM A INNER JOIN FS_ASSTXM B
	                                       ON A.ASST_NUMB = B.ASST_NUMB
	                               INNER JOIN VI_ASSETCLASS C
	                                        ON B.CLSF_CODE = C.SMAL_CODE
	                               /*LEFT OUTER JOIN FS_AMRATE D ON SUBSTR(A.STDS_YMTH,1,4) = D.STDS_YEAR AND A.PRID_LEGL=D.PRID_DPCT*/
	                               /*세무년수 상각기준액*/
	                                LEFT OUTER JOIN(
	                                        SELECT
	                                           STDS_YEAR, PRID_DPCT, AMOT_RT01, AMOT_RT02
	                                        FROM FS_AMRATE
	                                        WHERE STDS_YEAR = (SELECT MAX(STDS_YEAR) FROM FS_AMRATE
	                                                            WHERE STDS_YEAR <= SUBSTR(#STDS_YMTH#,1,4))
	                                    ) D ON A.PRID_LEGL=D.PRID_DPCT
	
	                              LEFT OUTER JOIN (
	                                            /* 전년도 시부인 기초금액 설정*/
	                                            SELECT
	                                                 STDS_YMTH                  /*전월*/
	                                                ,ASST_NUMB                  /*자산번호*/
	                                                ,ACQU_ENDX AS B_ACQU_ENDX   /*전월_취득가 기말잔액*/
	                                                ,DPAJ_ENDX AS B_DPAJ_ENDX   /*전월_시부인_기말잔액*/
	                                                ,CRNT_DPCT AS B_CRNT_DPCT   /*전월_당기상각누적액*/
	                                                ,DPAJ_GROW AS B_DPAJ_GROW   /*전월_시부인_당기증가_부인*/
	                                            FROM FS_DPCTXM
	                                            WHERE STDS_YMTH = sBEFO_MONT
	                                            ) E
	                                          ON A.ASST_NUMB = E.ASST_NUMB
	             WHERE A.STDS_YMTH = #STDS_YMTH#
	               AND A.PRID_LEGL > 0              /*1) 세무년수가 0년 초과*/
	               AND A.PRID_DPCT <> A.PRID_LEGL   /*2) 내용년수와 세무년수가 다른 경우*/
	
	        )
	
	        LOOP
	
	            /*취득가 기말잔액 (전월기준)  */
	             tACQU_ENDX      := CUR_DPCTXM.ACQU_ENDX;         /*CUR_DPCTXM.ACQU_ENDX;*/
	
	            /*정액법 년 상각액 구하기 (취득가-잔존가치(사용안함))/세무년수*/
	            tDPCT_YEAR       :=  TRUNC(tACQU_ENDX * CUR_DPCTXM.AMOT_RT01);
	
	            /*무형자산 비망가액=0*/
	            IF CUR_DPCTXM.ASCL_CODE = '80' THEN
	                nMValue := 0;
	            END IF;
	
	           /* 기업년수의 당월 감가상각액이 0원일 경우 계산 안함*/
	           IF CUR_DPCTXM.MONT_DPCT = 0 THEN
	                tMONT_DPCT   := 0;
	           ELSE
	                /*상각완료기준에 따른 구분*/
	                IF CUR_DPCTXM.DPCT_CMPT = 'PRID' THEN           /*내용년수*/
	
	                    /*상각방법에 따른 당월상각액*/
	                    IF CUR_DPCTXM.DPCT_METH = 'STRT' THEN       /*정액법*/
	
	                      /*당월 정액법 =  취득가 기말잔액 * 정액상각     [원본]*/
	                      /*tMONT_DPCT   := TRUNC(tACQU_ENDX * CUR_DPCTXM.AMOT_RT01 / 12);*/
	                      /*nBalance     := TRUNC(tACQU_ENDX);*/
	
	                        /*[보정] 조건월이 12월 일경우 & 당해 1월 취득 포함. 그이외 자산은 제외*/
	                        IF SUBSTR(#STDS_YMTH#,5,2) = '12' AND SUBSTR(#STDS_YMTH#,1,4)||'01' >= SUBSTR(CUR_DPCTXM.ACQS_DATE,1,6) THEN
	
	                            /*보정액 (년상각액- 11월 까지상각액)*/
	                            tDPCT_DIFF       :=  TRUNC(tDPCT_YEAR - CUR_DPCTXM.B_DPAJ_GROW);
	                            /*최종 보정금액*/
	                            tMONT_DPCT       :=  TRUNC(tDPCT_DIFF);
	
	                        ELSE
	                            tMONT_DPCT   := TRUNC((tACQU_ENDX * CUR_DPCTXM.AMOT_RT01) / 12);
	
	                        END IF;
	
	                        nBalance     := TRUNC(tACQU_ENDX);
	
	                    ELSIF CUR_DPCTXM.DPCT_METH = 'DMNS' THEN    /*정률법*/
	                      /*당월 정률법      =  취득가 기말잔액 - 당기상각누적액     * 정률
	                         tMONT_DPCT := TRUNC((tACQU_ENDX - CUR_DPCTXM.CRNT_DPCT) * CUR_DPCTXM.AMOT_RT02 / 12);
	                  		      취득가는 현재월 기준(감가상각시 계산됨). 당기상각누적액은 현 공식으로 구할수 없음 전월의 취득가 기말잔액, 전월 상각누적액으로 처리함
	                      */
	                        /* 당월 정률   =                         세무년수 상각누계액 = 전기(전월) 기업 상각누계액 -  전기(전월)시부인 기말잔액(누적액)*/
	                        /*                 취득가 기말잔액 -        세무년수 상각누계액                   * 세무년수 정율 / 12[월 계산]*/
	                        tMONT_DPCT   := TRUNC((tACQU_ENDX - (CUR_DPCTXM.B_CRNT_DPCT - CUR_DPCTXM.B_DPAJ_ENDX)) * CUR_DPCTXM.AMOT_RT02 / 12);
	
	                        nBalance     := TRUNC(tACQU_ENDX - (CUR_DPCTXM.B_CRNT_DPCT - CUR_DPCTXM.B_DPAJ_ENDX));
	
	                    END IF;
	
	                    /* 상각월수가 마지막 월 일때 OR  비망가액 조건*/
	                    IF CUR_DPCTXM.RMAN_MONT = 0 OR (nBalance <(tMONT_DPCT + nMValue)) THEN
	                        tMONT_DPCT   := TRUNC(nBalance - nMValue);
	
	                    END IF;
	
	                ELSIF CUR_DPCTXM.DPCT_CMPT = 'DPCT'  THEN       /*미상각잔액*/
	
	                    /*상각방법에 따른 당월상각액*/
	                    IF CUR_DPCTXM.DPCT_METH = 'STRT' THEN       /*정액법*/
	                        /*  당월상각  =    취득가 기말잔액 * 정액상각 / 12(월단위 계산 이라서)  */
	                        tMONT_DPCT   := TRUNC(tACQU_ENDX * CUR_DPCTXM.AMOT_RT01 / 12);
	                        nBalance     := TRUNC(tACQU_ENDX);
	
	                    ELSIF CUR_DPCTXM.DPCT_METH = 'DMNS' THEN    /*정률법*/
	                        /* 당월 정률법 =  취득가 기말잔액 -  당기상각누적액 *정률상각 
	                         tMONT_DPCT   := TRUNC(tACQU_ENDX - CUR_DPCTXM.CRNT_DPCT) * CUR_DPCTXM.AMOT_RT02 / 12);
	                        */
	                        /* 당월 정률   =                        세무년수 상각누계액 = 전기(전월) 기업 상각누계액 -  전기(전월)시부인 기말잔액(누적액)*/
	                        /*                   (전월_취득가 기말잔액 - 세무년수 상각누계액) * 세무년수정율 / 12[월 계산이므로 나누기]*/
	                        tMONT_DPCT   := TRUNC((tACQU_ENDX - (CUR_DPCTXM.B_CRNT_DPCT - CUR_DPCTXM.B_DPAJ_ENDX)) * CUR_DPCTXM.AMOT_RT02 / 12);
	
	                        /*nBalance     := TRUNC(tACQU_ENDX - (CUR_DPCTXM.B_CRNT_DPCT - CUR_DPCTXM.B_DPAJ_ENDX));*/
	
	                        /* 취득가액의 5%*/
	                        nBalance  := TRUNC(tACQU_ENDX * 0.05);
	
	                    END IF;
	
	                    /*비망가액 비교조건 [ 잔존가액<(상각누계+비망액) ]*/
	                    IF nBalance < (tMONT_DPCT + nMValue) THEN
	                        tMONT_DPCT   := TRUNC(nBalance - nMValue);
	                    END IF;
	
	                 END IF;
	
	
	            END IF;
	
	            /* 세무년수 상각 누계액*/
	            /*nDPAJ_DPCT := TRUNC(CUR_DPCTXM.B_CRNT_DPCT - CUR_DPCTXM.B_DPAJ_ENDX);*/
	
	            /* 당월 시부인액 = 기업년수_당월감가상각액  - 법정년수_당월감가상각액 */
	            nDPAJ_AMOT := CUR_DPCTXM.MONT_DPCT - tMONT_DPCT;
	
	           /*시부인_당기증감액 = 시부인 당기증가액   + 당기시부인액*/
	            nDPAJ_GROW := CUR_DPCTXM.DPAJ_GROW + nDPAJ_AMOT;
	
	           /*시부인상각범위누계액 nDPAJ_LMIT := 유휴구분 추가후 의미 없어짐*/
	
	            /*시부인_기말잔액 = 전기이월 + 시부인_당기증감액*/
	            nDPAJ_ENDX := CUR_DPCTXM.DPAJ_BEGN + nDPAJ_GROW;
	
	            /*시부인_전기이월) nDPAJ_BEGN  = 상단 기초작업시 이미 계산 되어짐. 업데이트 필요 없음*/
	
	
	            UPDATE FS_DPCTXM              	     /*[감가상각]*/
	               SET  /*DPAJ_LMIT = nDPAJ_LMIT */  /*상각범위누계액*/
	                    /*,DPAJ_BEGN = nDPAJ_BEGN*/  /*시부인_전기이월*/
	
	                    DPAJ_AMOT = nDPAJ_AMOT  /*시부인액(당월)*/
	                   ,DPAJ_GROW = nDPAJ_GROW  /*시부인_당기증감*/
	                   ,DPAJ_ENDX = nDPAJ_ENDX  /*시부인_기말잔액*/
	                   ,UPDT_DATE = SYSDATE /*수정일시*/
	                   ,UPDT_USID = #UPDT_USID# /*수정자*/
	             WHERE STDS_YMTH  = #STDS_YMTH#             /*기준년월*/
	               AND ASST_NUMB  = CUR_DPCTXM.ASST_NUMB    /*자산번호*/
	            ;
	
	        END LOOP;
	
	    END;
		]]>
	</insert>
<!-- 
/*******************************************************************************
     작  성  자 : 신민규
     작  성  일 : 2016. 07. 26
     내      용 : 감가상각 취소
********************************************************************************/	
 -->
	<insert id="FSMD0010.CANC00" parameterClass="hashmap" >
		<![CDATA[
		DECLARE
            /* FSMD0010.CANC00.감가상각 취소 */ 
			CNT             DECIMAL(15,0);            /*상각여부*/
	
	    BEGIN
	
	        /*********************************************************+
	        |  1.취소하려는 년월 이후에 감가상각 데이터가 존재 여부   |
	        +*********************************************************/
	        SELECT COUNT(STDS_YMTH) INTO CNT FROM FS_DPCTXM WHERE STDS_YMTH > #STDS_YMTH#;
	
	        IF (CNT > 0) THEN
	           RAISE_APPLICATION_ERROR(-20000, SUBSTR(#STDS_YMTH#, 1, 4) || '년 ' || SUBSTR(#STDS_YMTH#, 5, 2) || '월 이후의 감가상각 자료가 존재합니다.!\n\n감가상각 취소가 불가 합니다!');
	        END IF;
	
	
	        /************************************************************+
	        |  2.취소하려는 년월의 감가상각이 전표처리가 되었는지 여부   |
	        +*************************************************************/
	        SELECT COUNT(STDS_YMTH) INTO CNT FROM FS_SLIPXM WHERE STDS_YMTH = #STDS_YMTH#;
	
	        IF (CNT > 0) THEN
	           RAISE_APPLICATION_ERROR(-20000, SUBSTR(#STDS_YMTH#, 1, 4) || '년 ' || SUBSTR(#STDS_YMTH#, 5, 2) || '월은 이미 전표자료가 존재합니다.!\n\n감가상각 취소가 불가 합니다!');
	        END IF;
	
	        DELETE FROM FS_DPCTXM           /*[감가상각]*/
	         WHERE STDS_YMTH = #STDS_YMTH#   /*기준년월*/
	           ;
	    END;
		]]>
	</insert>

<!-- 
/*******************************************************************************
     작  성  자 : 신민규
     작  성  일 : 2016. 07. 26
     내      용 : 감가상각명세서 출력물 조회 처리
********************************************************************************/	
 -->
	<select id="FSMD0010.SEARCH01" parameterClass="hashmap" resultClass = "hashmap">
		<![CDATA[
			SELECT   /* FSMD0010.SEARCH01.감가상각명세서 출력물 조회 처리 */ 
	               A.STDS_YMTH     /*기준년월*/
	              ,A.ASCL_CODE     /*자산분류코드*/
	              ,C.ASCL_NAME     /*자산분류명*/
	              ,C.SMAL_NAME     /*소분류명*/
	              ,A.ASST_NUMB     /*자산번호*/
	              ,B.ASST_NAME     /*자산명*/
	              ,B.ACQS_DATE     /*취득일*/
	              ,C.DPCT_MTNM     /*상각방법명*/
	              ,A.PRID_DPCT     /*내용년수*/
	              ,A.PRID_LEGL     /*법정년수*/
	              ,D.AMOT_RT01     /*법정년수상각율*/
	
	              ,A.ACQU_ENDX    AS COL_05    /*[기말현재액]취득가_기말잔액*/
	              ,A.DPCT_ENDX    AS COL_06    /*[감가상각누계액]충당금_기말잔액*/
	              ,A.UNDP_BALE    AS COL_07    /*[미상각잔액 5-6]미상각잔액*/
	              ,A.DPTC_BEGN    AS COL_08    /*[전기말누계]충당금_전기이월*/
	              ,A.DPCT_GROW    AS COL_09    /*[당기상각비]충당금_당기증가*/
	              ,A.DPCT_ENDX    AS COL_10    /*[당기말누계 8+9]충당금_기말잔액*/
	
	              ,0  AS COL_11                   /*[전기말부인누계]*/
	              ,NVL(E.ACQU_GROW,0) AS COL_12   /*[당기지출액]*/
	              ,NVL(E.ACQU_GROW,0) AS COL_13   /*[합계 11+12]*/
				  
				  
	              /*  PARAM 
	              LEFT JOIN시 당해년도 데이타만 가져오므로 CASE 구문 사용 X
	              ,CASE WHEN SUBSTR(iSTDS_YMTH,1,4) = SUBSTR(B.ACQS_DATE,1,4) THEN
	                    NVL(E.ACQU_GROW,0) AS ACQU_GROW
	               ELSE
	                    0
	               END  AS COL_12   --[당기지출액]
	              ,CASE WHEN SUBSTR(iSTDS_YMTH,1,4) = SUBSTR(B.ACQS_DATE,1,4) THEN
	                    NVL(E.ACQU_GROW,0) AS ACQU_GROW
	               ELSE
	                    0
	               END  AS COL_13   --[합계 11+12]
	               */
	
	              ,A.ACQU_ENDX    AS COL_14    /*[취득가액 7+10+13]취득가_기말잔액*/
	              ,D.AMOT_RT01    AS COL_15    /*[일반상각률.특별상각률]법정년수상각율*/
	
	              /*세무 VS 법정 년수 차이에 따른 법정년수 상각액 처리*/
	              ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                  A.DPAJ_GROW
	              ELSE
	                  A.DPCT_GROW
	              END AS COL_16   /*[일반상각액]*/
	              ,0  AS COL_17   /*[특별상각액]*/
	              ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                  A.DPAJ_GROW
	              ELSE
	                  A.DPCT_GROW
	              END AS COL_18   /*[계 16+17]*/
	              ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                  A.DPAJ_GROW
	              ELSE
	                  A.DPCT_GROW
	              END AS COL_19   /*[당기상각시인범위액 18, 단 18<= 14-8-11+25-전기28]*/
	
	             ,A.DPCT_GROW     AS COL_20    /*[회사계상상각액 9+12]충당금_당기증가*/
	              ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                  A.DPCT_GROW - A.DPAJ_GROW
	              ELSE
	                  A.DPCT_GROW - A.DPCT_GROW
	              END AS COL_21   /*[차감액 20-19]*/
	              ,0  AS COL_22   /*[최저한세적용에다른특별상각부인액]*/
	
	              ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                  A.DPCT_GROW - A.DPAJ_GROW
	              ELSE
	                  A.DPCT_GROW - A.DPCT_GROW
	              END AS COL_23   /*[상각부인액 21+22]*/
	              ,0  AS COL_24   /*[기왕부인액중당기손금추인액 25, 단 25<= 21]*/
	
	              ,A.DPAJ_BEGN    AS COL_25   /*[전기말부인액누계 전기 26]*/
	              ,A.DPAJ_ENDX    AS COL_26   /*[당기말부인액누계 25+23 - 24]*/
	
	              ,0  AS COL_27   /*[당기의제상각액 21-24]*/
	              ,0  AS COL_28   /*[의제상각의누계 전기28+27]*/
	              ,0  AS COL_29   /*[기준상각률]*/
	              ,0  AS COL_30   /*[종전상각비]*/
	              ,0  AS COL_31   /*[종전감가상각비 한도 30-(20-(26-25))]*/
	              ,0  AS COL_32   /*[추가손금산입대상액]*/
	              ,0  AS COL_33   /*[동종자산 한도계산후 추가손금산입액]*/
	              ,0  AS COL_34   /*[기획재정부령으로정하는기준내용연수]*/
	              ,0  AS COL_35   /*[기준감가상각비한도]*/
	              ,0  AS COL_36   /*[추가손금산입액]*/
	              ,0  AS COL_37   /*[추가손금산입후당기말부인액누계 26-33-36]*/
	
	          FROM FS_DPCTXM A INNER JOIN FS_ASSTXM B
	                                  ON A.ASST_NUMB = B.ASST_NUMB
	                          INNER JOIN VI_ASSETCLASS C
	                                  ON B.CLSF_CODE = C.SMAL_CODE
	                         /*세무년수 상각기준액*/
	                          LEFT OUTER JOIN(
	                                  SELECT
	                                     STDS_YEAR, PRID_DPCT, AMOT_RT01, AMOT_RT02
	                                  FROM FS_AMRATE
	                                  WHERE STDS_YEAR = (SELECT MAX(STDS_YEAR) FROM FS_AMRATE
	                                                      WHERE STDS_YEAR <= SUBSTR(#STDS_YMTH#,1,4))
	                              ) D ON A.PRID_LEGL=D.PRID_DPCT
	                          LEFT OUTER JOIN (       /*당기자본적지출액(5.기말현재액: 자본적지출금액 포함되어있음)*/
	                                SELECT  A.ASST_NUMB    /*자산번호*/
	                                   ,SUM(DECODE(TO_NUMBER(B.REF4_FILD),  1, A.CHNG_AMOT, 0)) AS ACQU_GROW /* 취득가 당기증가*/
	                                   ,SUM(DECODE(TO_NUMBER(B.REF4_FILD), -1, A.CHNG_AMOT, 0)) AS ACQU_DCRS /* 취득가 당기감소*/
	                                FROM FS_ASCHXM A INNER JOIN TM_CODEXD B
	                                                       ON A.ASCH_GUBN = B.COMD_CODE
	                                                      AND B.COMM_CODE = 'ASCH_GUBN' AND B.COMD_CODE ='CAPI' /*자본적지출만*/
	                                                      /*AND (B.REF1_FILD = 'AUTO' OR B.REF1_FILD = 'ASCH' OR B.REF1_FILD = 'SPLT')*/ /* 이동인것은 빼준다.*/
	                                WHERE A.CHNG_DATE LIKE SUBSTR(#STDS_YMTH#, 1,4) || '%'
	                                GROUP BY A.ASST_NUMB
	                                ) E
	                             ON A.ASST_NUMB = E.ASST_NUMB
	          WHERE A.STDS_YMTH = #STDS_YMTH#                     /*기준년월*/
	              AND A.ASCL_CODE = NVL(#ASCL_CODE#, C.ASCL_CODE)   /*자산분류*/
	              AND A.CLSF_CODE = NVL(#CLSF_CODE#, B.CLSF_CODE)   /*품목분류*/
	              AND B.ACQS_DATE = NVL(#ACQS_DATE#, B.ACQS_DATE)   /*취득일자*/
	              AND A.UNDP_BALE > 1000      /*상 각자산만 해당*/
	          ORDER BY A.ASCL_CODE, B.ACQS_DATE, B.ASST_NAME
		]]>
	</select>
<!-- 
/*******************************************************************************
     작  성  자 : 신민규
     작  성  일 : 2016. 07. 26
     내      용 : 감가상각명세서 출력물 조회 처리
********************************************************************************/
 -->
	<select id="FSMD0010.SEARCH02" parameterClass="hashmap" resultClass = "hashmap">
		<![CDATA[
			SELECT  /* FSMD0010.SEARCH02.감가상각명세서 출력물 조회 처리 */ 
	             A.ASCL_CODE
	            ,A.ASCL_NAME
	            ,'' AS ASST_NAME
	            ,'' AS ACQS_DATE
	            ,MAX(A.PRID_DPCT) AS PRID_DPCT
	            ,MAX(A.PRID_LEGL) AS PRID_LEGL
	            ,MAX(A.AMOT_RT01) AS AMOT_RT01
	            ,NVL(SUM(A.COL_05),0) AS COL_05
	            ,NVL(SUM(A.COL_06),0) AS COL_06
	            ,NVL(SUM(A.COL_07),0) AS COL_07
	            ,NVL(SUM(A.COL_08),0) AS COL_08
	            ,NVL(SUM(A.COL_09),0) AS COL_09
	            ,NVL(SUM(A.COL_10),0) AS COL_10
	            ,NVL(SUM(A.COL_11),0) AS COL_11
	            ,NVL(SUM(A.COL_12),0) AS COL_12
	            ,NVL(SUM(A.COL_13),0) AS COL_13
	            ,NVL(SUM(A.COL_14),0) AS COL_14
	            ,MAX(A.COL_15)        AS COL_15
	            ,NVL(SUM(A.COL_16),0) AS COL_16
	            ,NVL(SUM(A.COL_17),0) AS COL_17
	            ,NVL(SUM(A.COL_18),0) AS COL_18
	            ,NVL(SUM(A.COL_19),0) AS COL_19
	            ,NVL(SUM(A.COL_20),0) AS COL_20
	            ,NVL(SUM(A.COL_21),0) AS COL_21
	            ,NVL(SUM(A.COL_22),0) AS COL_22
	            ,NVL(SUM(A.COL_23),0) AS COL_23
	            ,NVL(SUM(A.COL_24),0) AS COL_24
	            ,NVL(SUM(A.COL_25),0) AS COL_25
	            ,NVL(SUM(A.COL_26),0) AS COL_26
	            ,NVL(SUM(A.COL_27),0) AS COL_27
	            ,NVL(SUM(A.COL_28),0) AS COL_28
	            ,NVL(SUM(A.COL_29),0) AS COL_29
	            ,NVL(SUM(A.COL_30),0) AS COL_30
	            ,NVL(SUM(A.COL_31),0) AS COL_31
	            ,NVL(SUM(A.COL_32),0) AS COL_32
	            ,NVL(SUM(A.COL_33),0) AS COL_33
	            ,NVL(SUM(A.COL_34),0) AS COL_34
	            ,NVL(SUM(A.COL_35),0) AS COL_35
	            ,NVL(SUM(A.COL_36),0) AS COL_36
	            ,NVL(SUM(A.COL_37),0) AS COL_37
	
	        FROM(
	
	            SELECT
	                   A.ASCL_CODE     /*자산분류코드*/
	                  ,C.ASCL_NAME     /*자산분류명*/
	                  ,C.DPCT_MTNM     /*상각방법명*/
	                  ,A.PRID_DPCT     /*내용년수*/
	                  ,A.PRID_LEGL     /*법정년수*/
	                  ,D.AMOT_RT01     /*법정년수상각율*/
	
	                  ,A.ACQU_ENDX    AS COL_05    /*[기말현재액]취득가_기말잔액*/
	                  ,A.DPCT_ENDX    AS COL_06    /*[감가상각누계액]충당금_기말잔액*/
	                  ,A.UNDP_BALE    AS COL_07    /*[미상각잔액 5-6]미상각잔액*/
	                  ,A.DPTC_BEGN    AS COL_08    /*[전기말누계]충당금_전기이월*/
	                  ,A.DPCT_GROW    AS COL_09    /*[당기상각비]충당금_당기증가*/
	                  ,A.DPCT_ENDX    AS COL_10    /*[당기말누계 8+9]충당금_기말잔액*/
	
	                  ,0  AS COL_11                   /*[전기말부인누계]*/
	                  /*LEFT JOIN시 당해년도 데이타만 가져오므로 CASE 구문 사용 X */
	                  ,NVL(E.ACQU_GROW,0) AS COL_12   /*[당기지출액]*/
	                  ,NVL(E.ACQU_GROW,0) AS COL_13   /*[합계 11+12]*/
	
	                  ,A.ACQU_ENDX    AS COL_14    /*[취득가액 7+10+13]취득가_기말잔액*/
	                  ,D.AMOT_RT01    AS COL_15    /*[일반상각률.특별상각률]법정년수상각율*/
	
	                  /*세무 VS 법정 년수 차이에 따른 법정년수 상각액 처리*/
	                  ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                      A.DPAJ_GROW
	                  ELSE
	                      A.DPCT_GROW
	                  END AS COL_16   /*[일반상각액]*/
	                  ,0  AS COL_17   /*[특별상각액]*/
	                  ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                      A.DPAJ_GROW
	                  ELSE
	                      A.DPCT_GROW
	                  END AS COL_18   /*[계 16+17]*/
	                  ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                      A.DPAJ_GROW
	                  ELSE
	                      A.DPCT_GROW
	                  END AS COL_19   /*[당기상각시인범위액 18, 단 18<= 14-8-11+25-전기28]*/
	
	                 ,A.DPCT_GROW     AS COL_20    /*[회사계상상각액 9+12]충당금_당기증가*/
	                  ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                      A.DPCT_GROW - A.DPAJ_GROW
	                  ELSE
	                      A.DPCT_GROW - A.DPCT_GROW
	                  END AS COL_21   /*[차감액 20-19]*/
	                  ,0  AS COL_22   /*[최저한세적용에다른특별상각부인액]*/
	
	                  ,CASE WHEN A.PRID_DPCT <> A.PRID_LEGL THEN
	                      A.DPCT_GROW - A.DPAJ_GROW
	                  ELSE
	                      A.DPCT_GROW - A.DPCT_GROW
	                  END AS COL_23   /*[상각부인액 21+22]*/
	                  ,0  AS COL_24   /*[기왕부인액중당기손금추인액 25, 단 25<= 21]*/
	
	                  ,A.DPAJ_BEGN    AS COL_25   /*[전기말부인액누계 전기 26]*/
	                  ,A.DPAJ_ENDX    AS COL_26   /*[당기말부인액누계 25+23 - 24]*/
	
	                  ,0  AS COL_27   /*[당기의제상각액 21-24]*/
	                  ,0  AS COL_28   /*[의제상각의누계 전기28+27]*/
	                  ,0  AS COL_29   /*[기준상각률]*/
	                  ,0  AS COL_30   /*[종전상각비]*/
	                  ,0  AS COL_31   /*[종전감가상각비 한도 30-(20-(26-25))]*/
	                  ,0  AS COL_32   /*[추가손금산입대상액]*/
	                  ,0  AS COL_33   /*[동종자산 한도계산후 추가손금산입액]*/
	                  ,0  AS COL_34   /*[기획재정부령으로정하는기준내용연수]*/
	                  ,0  AS COL_35   /*[기준감가상각비한도]*/
	                  ,0  AS COL_36   /*[추가손금산입액]*/
	                  ,0  AS COL_37   /*[추가손금산입후당기말부인액누계 26-33-36]*/
	
	              FROM FS_DPCTXM A INNER JOIN FS_ASSTXM B
	                                      ON A.ASST_NUMB = B.ASST_NUMB
	                              INNER JOIN VI_ASSETCLASS C
	                                      ON B.CLSF_CODE = C.SMAL_CODE
	                             /*세무년수 상각기준액*/
	                              LEFT OUTER JOIN(
	                                      SELECT
	                                       		  STDS_YEAR, PRID_DPCT, AMOT_RT01, AMOT_RT02
	                                       FROM FS_AMRATE
	                                      WHERE STDS_YEAR = (SELECT MAX(STDS_YEAR) FROM FS_AMRATE
	                                                          WHERE STDS_YEAR <= SUBSTR(#STDS_YMTH#,1,4))
	                                  ) D ON A.PRID_LEGL=D.PRID_DPCT
	                              LEFT OUTER JOIN (       /*당기자본적지출액(5.기말현재액: 자본적지출금액 포함되어있음)*/
	                                    SELECT  A.ASST_NUMB    /*자산번호*/
		                                       ,SUM(DECODE(TO_NUMBER(B.REF4_FILD),  1, A.CHNG_AMOT, 0)) AS ACQU_GROW /* 취득가 당기증가*/
		                                       ,SUM(DECODE(TO_NUMBER(B.REF4_FILD), -1, A.CHNG_AMOT, 0)) AS ACQU_DCRS /* 취득가 당기감소*/
	                                      FROM FS_ASCHXM A INNER JOIN TM_CODEXD B
	                                                               ON A.ASCH_GUBN = B.COMD_CODE
	                                                              AND B.COMM_CODE = 'ASCH_GUBN' AND B.COMD_CODE ='CAPI' /*자본적지출만*/
	                                                          /*AND (B.REF1_FILD = 'AUTO' OR B.REF1_FILD = 'ASCH' OR B.REF1_FILD = 'SPLT')*/ /* 이동인것은 빼준다.*/
	                                    WHERE A.CHNG_DATE LIKE SUBSTR(#STDS_YMTH#, 1,4) || '%'
	                                    GROUP BY A.ASST_NUMB
	                                    ) E
	                                 ON A.ASST_NUMB = E.ASST_NUMB
	              WHERE A.STDS_YMTH = #STDS_YMTH#                     /*기준년월*/
	                AND A.ASCL_CODE = NVL(#ASCL_CODE#, C.ASCL_CODE)   /*자산분류*/
	                AND A.CLSF_CODE = NVL(#CLSF_CODE#, B.CLSF_CODE)   /*품목분류*/
	                AND B.ACQS_DATE = NVL(#ACQS_DATE#, B.ACQS_DATE)   /*취득일자*/
	                AND A.UNDP_BALE > 1000      /*상 각자산만 해당*/
	
	        ) A
	        GROUP BY A.ASCL_CODE, A.ASCL_NAME
	        ORDER BY A.ASCL_CODE, A.ASCL_NAME
		]]>
	</select>
</sqlMap>
