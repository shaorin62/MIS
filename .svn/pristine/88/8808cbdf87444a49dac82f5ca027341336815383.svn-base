<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="MACA0090">

<!--  
 *   프로그램명 : 전표처리
 *   작 성 일 : 2016.11.22(표준화 완료)
 *   작 성 자 : 최제현
 *   비   고 :
 *   Copyright (c) 2013 Inbus Co.,Ltd All Rights reserved. 
 -->

	<!-- 
		작  성  자 :  최제현
		작  성  일 : 2016.11.22(표준화 완료)
		내      용  : 세금계산서조회
		파라미터  : YEAR_MNTH : 년월, BUSI_FLAG : 위수탁 수수료구분, MEDX_FLAG : 매체구분,
		CUST_CODE:광고주코드, MEDX_CODE:매체사코드
	-->
	<select id="MACA0090.SEARCH00" parameterClass="hashmap" resultClass="hashmap">
	<![CDATA[ 
SELECT /*MACA0090.SEARCH00 		세금계산서조회 */
				  '0' CHEK_FILD									/* 선택 */
				 , TO_CHAR(SYSDATE, 'YYYYMMDD') AS POST_DATE		/* 전기일 */
                 , A.TAXY_MONT              /* 세금계산서년월 */
                 , A.TAXX_NUMB              /* 세금계산서번호 */
                 , DECODE(C.BIZR_NUMB,null,C.RERN_NUMB,C.BIZR_NUMB) AS CUTX_CUNM /* 공급자받는자 사업자 번호 */
                 , A.CUST_CODE              /* 광고주코드 */
                 , A.CUST_NAME              /* 광고주명 */
                 , DECODE(D.BIZR_NUMB,null,D.RERN_NUMB,D.BIZR_NUMB) AS METX_CUNM  /* 공급자 사업자 번호 */
                 , A.MEDX_CODE              /* 매체사코드 */
                 , A.MEDX_CDNM              /* 매체사명 */
                 , A.TAXX_AMTX              /* 청구금액 */
                 , A.TAXX_VATX              /* 부가세액 */
                 , A.SUMM_AMTX              /* 합계금액 */
                 , A.DEND_DATE              /* 청구일자 */
                 , A.PRNT_DATE              /* 발행일자 */
                 , A.SACH_NUMB              /* 매출전표번호 */
                 , A.BIZR_NUMB              /* 광고주사업자번호 */
                 , A.MEMO_FILD              /* 비고 */
                 , A.MEDX_FLAG              /* 매체구분 */
                 , A.OWNR_NAME              /* 광고주대표자명 */
                 , A.ADDR_DESC              /* 주소 */
                 , A.DTL1_ADDR              /* 주소1 */
                 , A.DTL2_ADDR              /* 주소2 */
                 , A.MOWN_NAME              /* 매체사대표명 */
                 , A.MADD_DESC              /* 매체사주소 */
                 , A.MDT1_ADDR              /* 매체사주소1 */
                 , A.MDT2_ADDR              /* 매체사주소2 */
                 , SUBSTR(A.DTIX_TYPE,1,2)  DTIX_TYPE             /* 세금계산서종류 */
                 , A.BUSI_FLAG              /* 위수탁 수수료 구분 */
                 , A.TAXX_DMND              /* 영수구분 */
                 , SF_GET_CUSTEMAILTAX(A.CUST_CODE) AS ELTR_MLAD           	 /*담당자 EMAIL주소*/
                 , F.OFFI_NAME AS CCUS_NAME /*수탁자 상호*/
                 , F.BSNS_NUMB AS CBIZ_NUMB /*수탁자 사업자번호*/
                 , F.OWNR_NAME AS COWN_NAME /*수탁자 대표자성명 */
                 , F.ADDR_DESC AS CADD_DESC /*수탁자 주소*/
                 , G.CUST_SEQX
                 , H.MEDF_SEQX
                 , I.MEDX_SEQX
                 , A.TAXY_NUMB
              FROM MD_SATXXH A              /* [매체세금계산서 헤더테이블] */
              LEFT JOIN TA_CUSTXM C ON A.CUST_CODE = C.CUST_CODE
              LEFT JOIN TA_CUSTXM D ON A.MEDX_CODE = D.CUST_CODE
              LEFT JOIN TM_OFFICE F ON F.ACCT_GUBN = '100' AND F.OFFI_GUBN ='1'
              LEFT JOIN MD_SEQXXM G ON A.TAXY_MONT = G.TAXY_MONT AND A.CUST_CODE = G.CUST_CODE 
              LEFT JOIN MD_SEQXXM H ON A.TAXY_MONT = H.TAXY_MONT AND A.MEDX_FLAG = H.MEDX_FLAG 
              LEFT JOIN MD_SEQXXM I ON A.TAXY_MONT = I.TAXY_MONT AND A.MEDX_CODE = I.MEDX_CODE 
              WHERE A.TAXY_MONT = #YEAR_MNTH#
              AND A.BUSI_FLAG= #BUSI_FLAG#
              AND A.SACH_NUMB IS NULL
              AND A.INPT_GUBN IS NULL
	]]>
			<isNotEmpty prepend="AND" property="CUST_CODE">
				A.CUST_CODE = #CUST_CODE# 		/* 광고주코드 */
			</isNotEmpty>	
			<isNotEmpty prepend="AND" property="CUST_NAME">
				C.CUST_NAME LIKE '%'||#CUST_NAME#|| '%'		/* 광고주명 */
			</isNotEmpty>	
		<isNotEmpty property="MEDX_FLAG">
			<isEqual prepend="AND" property="MEDX_FLAG" compareValue="A00A">
					 (A.MEDX_FLAG <![CDATA[  <= 'A003' ]]>	OR A.MEDX_FLAG='A00A')		/* 매체구분 */
			</isEqual>
			<isNotEqual prepend="AND" property="MEDX_FLAG" compareValue="A00A">
					 A.MEDX_FLAG= #MEDX_FLAG# 							/* 매체구분 */
			</isNotEqual>
		</isNotEmpty>
	<![CDATA[ 
	ORDER BY G.CUST_SEQX,H.MEDF_SEQX,I.MEDX_SEQX,A.TAXY_MONT,A.TAXX_NUMB
	]]>
	</select>
	
	<!-- 
		작  성  자 :  최제현
		작  성  일 : 2016.11.24(표준화 완료)
		내      용  : 등록된 전표 조회(위수탁)
		파라미터  : YEAR_MNTH : 년월, BUSI_FLAG : 위수탁 수수료구분, MEDX_FLAG : 매체구분,
		CUST_CODE:광고주코드, MEDX_CODE:매체사코드
	-->
	<select id="MACA0090.SEARCH01" parameterClass="hashmap" resultClass="hashmap">
	<![CDATA[ 
SELECT /*MACA0090.SEARCH01 		등록된 전표 조회 */
				  '0' CHEK_FILD									/* 선택 */
				,A.SACH_NUMB						/* 전표번호 */
				,B.SLIP_DATE							/* 전표날짜 */
				,SUM(A.SUMM_AMTX) AS CSUM_FILD  /* 합계 */
				FROM MD_SATXXH A
				LEFT JOIN TA_SLIPXM B ON A.SACH_NUMB = B.SLIP_NUMB
	            WHERE SUBSTR(B.SLIP_DATE,1,6) = #YEAR_MNTH#
	            AND A.BUSI_FLAG= #BUSI_FLAG#
	            AND A.SACH_NUMB IS NOT NULL
	]]>
			<isNotEmpty prepend="AND" property="CUST_CODE">
				A.CUST_CODE = #CUST_CODE# 		/* 광고주코드 */
			</isNotEmpty>	
			<isNotEmpty prepend="AND" property="CUST_NAME">
				D.CUST_NAME LIKE '%'||#CUST_NAME#|| '%'		/* 광고주명 */
			</isNotEmpty>	
		<isNotEmpty property="MEDX_FLAG">
			<isEqual prepend="AND" property="MEDX_FLAG" compareValue="A00A">
					 (A.MEDX_FLAG <![CDATA[  <= 'A003' ]]>	OR A.MEDX_FLAG='A00A')				/* 매체구분 */
			</isEqual>
			<isNotEqual prepend="AND" property="MEDX_FLAG" compareValue="A00A">
					 A.MEDX_FLAG= #MEDX_FLAG# 							/* 매체구분 */
			</isNotEqual>
		</isNotEmpty>
	<![CDATA[ 	
	GROUP BY A.SACH_NUMB,B.SLIP_DATE
	ORDER BY A.SACH_NUMB
	]]>
	</select>
	
	
	
	<!-- 
		작  성  자 :  최제현
		작  성  일 : 2016.11.22(표준화 완료)
		내      용  : 수수료 발송 세금계산서조회
		파라미터  : YEAR_MNTH : 년월, BUSI_FLAG : 위수탁 수수료구분, MEDX_FLAG : 매체구분,
		CUST_CODE:광고주코드, MEDX_CODE:매체사코드
	-->
	<select id="MACA0090.SEARCH02" parameterClass="hashmap" resultClass="hashmap">
	<![CDATA[ 
SELECT /*MACA0050.SEARCH03 		발송 세금계산서조회 */
                  '0' CHEK_FILD                /*체크박스*/
                 , A.TAXY_MONT              /* 세금계산서년월 */
                 , A.TAXX_NUMB              /* 세금계산서번호 */
                 , DECODE(C.BIZR_NUMB,null,C.RERN_NUMB,C.BIZR_NUMB) AS CUTX_CUNM /* 광고주 사업자 번호 */
                 , A.CUST_CODE              /* 광고주코드 */
                 , A.CUST_NAME              /* 광고주명 */
                 , DECODE(D.BIZR_NUMB,null,D.RERN_NUMB,D.BIZR_NUMB) AS METX_CUNM  /* 공급자 받는자 사업자 번호 */
                 , A.MEDX_CODE              /* 매체사코드 */
                 , A.MEDX_CDNM              /* 공급받는자 */
                 , A.TAXX_AMTX              /* 청구금액 */
                 , A.TAXX_VATX              /* 부가세액 */
                 , A.SUMM_AMTX              /* 합계금액 */
                 , A.DEND_DATE              /* 청구일자 */
                 , A.PRNT_DATE              /* 발행일자 */
                 , A.SACH_NUMB              /* 매출전표번호 */
                 , A.BIZR_NUMB              /* 광고주사업자번호 */
                 , A.MEMO_FILD              /* 비고 */
                 , A.MEDX_FLAG              /* 매체구분 */
                 , A.OWNR_NAME              /* 광고주대표자명 */
                 , A.ADDR_DESC              /* 주소 */
                 , A.DTL1_ADDR              /* 주소1 */
                 , A.DTL2_ADDR              /* 주소2 */
                 , A.MOWN_NAME              /* 매체사대표명 */
                 , A.MADD_DESC              /* 매체사주소 */
                 , A.MDT1_ADDR              /* 매체사주소1 */
                 , A.MDT2_ADDR              /* 매체사주소2 */
                 , SUBSTR(A.DTIX_TYPE,1,2)  DTIX_TYPE              /* 세금계산서종류 */
                 , A.BUSI_FLAG              /* 위수탁 수수료 구분 */
                 , A.TAXX_DMND              /* 영수구분 */
                 , SF_GET_CUSTEMAILTAX(A.CUST_CODE) AS ELTR_MLAD           	 /*담당자 EMAIL주소*/
                 , F.OFFI_NAME AS CCUS_NAME /*수탁자 상호*/
                 , F.BSNS_NUMB AS CBIZ_NUMB /*수탁자 사업자번호*/
                 , F.OWNR_NAME AS COWN_NAME /*수탁자 대표자성명 */
                 , F.ADDR_DESC AS CADD_DESC /*수탁자 주소*/
                 , G.CUST_SEQX
                 , H.MEDF_SEQX
                 , I.MEDX_SEQX
                 , A.TAXY_NUMB
              FROM MD_SATXXH A              /* [매체세금계산서 헤더테이블] */
              LEFT JOIN TA_CUSTXM C ON A.CUST_CODE = C.CUST_CODE
              LEFT JOIN TA_CUSTXM D ON A.MEDX_CODE = D.CUST_CODE
              LEFT JOIN TM_OFFICE F ON F.ACCT_GUBN = '100' AND F.OFFI_GUBN ='1'
              LEFT JOIN MD_SEQXXM G ON A.TAXY_MONT = G.TAXY_MONT AND A.CUST_CODE = G.CUST_CODE 
              LEFT JOIN MD_SEQXXM H ON A.TAXY_MONT = H.TAXY_MONT AND A.MEDX_FLAG = H.MEDX_FLAG 
              LEFT JOIN MD_SEQXXM I ON A.TAXY_MONT = I.TAXY_MONT AND A.MEDX_CODE = I.MEDX_CODE 
              WHERE A.TAXY_MONT = #YEAR_MNTH#
              AND A.BUSI_FLAG= 'A' 
              AND A.SACH_NUMB IS NULL
              AND A.INPT_GUBN IS NULL
	]]>
			<isNotEmpty prepend="AND" property="MEDX_CODE">
				A.MEDX_CODE LIKE '%' || #MEDX_CODE# || '%'		/* 매체사코드 */
			</isNotEmpty>	
			<isNotEmpty prepend="AND" property="CUST_NAME">
				C.CUST_NAME LIKE '%'||#CUST_NAME#|| '%'		/* 광고주명 */
			</isNotEmpty>	
			<isNotEmpty property="MEDX_FLAG">
				<isEqual prepend="AND" property="MEDX_FLAG" compareValue="A00A">
						 (A.MEDX_FLAG = 'A00A' OR A.MEDX_FLAG <![CDATA[  <= 'A003' ]]> )			/* 매체구분 */
				</isEqual>
				<isNotEqual prepend="AND" property="MEDX_FLAG" compareValue="A00A">
						 A.MEDX_FLAG= #MEDX_FLAG# 							/* 매체구분 */
				</isNotEqual>
		</isNotEmpty>
	<![CDATA[ 
	ORDER BY G.CUST_SEQX,H.MEDF_SEQX,I.MEDX_SEQX,A.TAXY_MONT,A.TAXX_NUMB
	]]>
	</select>
	
	<!-- 
		작  성  자 :  최제현
		작  성  일 : 2016.11.24(표준화 완료)
		내      용  : 등록된 전표 조회(수수료)
		파라미터  : YEAR_MNTH : 년월, BUSI_FLAG : 위수탁 수수료구분, MEDX_FLAG : 매체구분,
		CUST_CODE:광고주코드, MEDX_CODE:매체사코드
	-->
	<select id="MACA0090.SEARCH03" parameterClass="hashmap" resultClass="hashmap">
	<![CDATA[ 
SELECT /*MACA0090.SEARCH01 		등록된 전표 조회 */
				  '0' CHEK_FILD									/* 선택 */
				 ,A.SACH_NUMB						/* 전표번호 */
				,B.SLIP_DATE							/* 전표날짜 */
				,SUM(A.SUMM_AMTX) AS CSUM_FILD  /* 차변합계 */
				FROM MD_SATXXH A
				LEFT JOIN TA_SLIPXM B ON A.SACH_NUMB = B.SLIP_NUMB
	            WHERE SUBSTR(B.SLIP_DATE,1,6) = #YEAR_MNTH#
	            AND A.BUSI_FLAG= #BUSI_FLAG#
	            AND A.SACH_NUMB IS NOT NULL
	]]>
			<isNotEmpty prepend="AND" property="CUST_CODE">
				A.CUST_CODE = #CUST_CODE# 		/* 광고주코드 */
			</isNotEmpty>	
			<isNotEmpty prepend="AND" property="CUST_NAME">
				D.CUST_NAME LIKE '%'||#CUST_NAME#|| '%'		/* 광고주명 */
			</isNotEmpty>	
		<isNotEmpty property="MEDX_FLAG">
			<isEqual prepend="AND" property="MEDX_FLAG" compareValue="A00A">
					 (A.MEDX_FLAG <![CDATA[  <= 'A003' ]]>	OR A.MEDX_FLAG='A00A')				/* 매체구분 */
			</isEqual>
			<isNotEqual prepend="AND" property="MEDX_FLAG" compareValue="A00A">
					 A.MEDX_FLAG= #MEDX_FLAG# 							/* 매체구분 */
			</isNotEqual>
		</isNotEmpty>
	<![CDATA[ 	
	GROUP BY A.SACH_NUMB,B.SLIP_DATE
	ORDER BY A.SACH_NUMB
	]]>
	</select>
	
	<!-- 
		작  성  자 :  최제현
		작  성  일 : 2016.11.20(표준화 완료)
		내      용  : 광고주목록 조회
		파라미터  : 
	-->
	<select id="MACA0090.SEARCH04" parameterClass="hashmap" resultClass="hashmap">
	<![CDATA[ 
		SELECT                                         /* MDMA0030.SEARCH01 광고주목록 가져오기 */
                A.CUST_CODE								/* 광고주코드 */
                , A.CUST_NAME                                 /* 거래처명 */
                , A.CUST_NAME AS CLIENT_NAME    /* 거래처명 */
                , ' ' AS USEX_CODE                          /* NULL */
                FROM TA_CUSTXM A 
                LEFT JOIN TA_CUSTXD B ON A.CUST_CODE = B.CUST_CODE
                WHERE 1=1
                AND B.CUCL_CODE = 'FA260110'
	]]>
	</select>
	
	
	<!-- 
		작  성  자 :  최제현
		작  성  일 : 2016.11.22(표준화 완료)
		내      용  : 새로운 전표번호채번
		파라미터  :
	-->
	<select id="MACA0090.getNEW_SEQX_IDXX" parameterClass="hashmap" resultClass="String">
	<![CDATA[ 
			SELECT 
			NVL(MAX(SEQX_IDXX),0)+1 
			FROM MD_VOCHXM
			WHERE 1=1
	]]>
	</select>
	
	<!-- 
		작  성  자 :  최제현
		작  성  일 : 2016.11.23(표준화 완료)
		내      용  : 전표번호채번
		파라미터  :
	-->
	<select id="MACA0090.getSEQX_IDXX" parameterClass="hashmap" resultClass="String">
	<![CDATA[ 
			SELECT 
			MAX(SEQX_IDXX)
			FROM MD_VOCHXM
			WHERE 1=1
			AND SACH_NUMB = #SACH_NUMB#
	]]>
	</select>
	
	
	
	<!-- 
/*******************************************************************************
     작  성  자 : 최제현
     작  성  일 : 2016. 11. 22
     내      용 : 매체 위수탁 전표처리 
********************************************************************************/
 -->
	<insert id="MACA0090.SAVE00" parameterClass="hashmap" >
		<![CDATA[
		DECLARE
	       /*MACA0090.SAVE00. 매체 위수탁 전표처리*/
			CURSOR CUR_MD_SATXXH (
	             P_TAXY_MONT  IN MD_SATXXH.TAXY_MONT%TYPE   /*계산서년월*/
	            ,P_TAXX_NUMB  IN MD_SATXXH.TAXX_NUMB%TYPE   /*계산서번호*/
	        ) IS
                    SELECT
	        		A.CUST_CODE
	        		,A.MEDX_FLAG
                    ,A.MEDX_CODE
                    ,A.SACH_NUMB
                    ,'100' AS ACCT_GUBN
                    ,#DEPT_CODE# AS DEPT_CODE 
                    ,TRIM(#EMPL_CODE#) AS EMPL_CODE			/* 사원번호 */
                    ,CASE WHEN A.MEDX_FLAG IN ('A001','A002','A003','A00A') THEN #DEPT_CODE# 
                    WHEN TRIM(E.DEPT_NAME) IS NULL THEN #DEPT_CODE# 
                    ELSE TRIM(B.DEPT_CODE) END AS RDEP_CODE
                    ,A.MEMO_FILD
                    ,A.MEMO_FILD AS MATT_NAME
                    ,NVL(A.TAXX_AMTX,0) AS TAXX_AMTX
                    ,NVL(TRUNC(A.TAXX_VATX),0) AS TAXX_VATX
                    ,NVL(A.TAXX_AMTX,0)+NVL(TRUNC(A.TAXX_VATX),0) AS SUMM_AMTX
                    ,CASE WHEN NVL(D.CUTY_CODE,' ') = 'TS100010' THEN '1112310' ELSE '1112320' END  AS DEBT_CODE   /* 차변계정 */
                    ,CASE WHEN NVL(D.CUTY_CODE,' ') = 'TS100010' THEN '3151100' ELSE '3151200' END  AS ACCT_CODE   /* 대변계정 */
                    FROM MD_SATXXH A
                    LEFT JOIN MD_SATXXD B ON A.TAXY_MONT = B.TAXY_MONT AND A.TAXX_NUMB = B.TAXX_NUMB 
                    AND B.TAXX_IDXX='1'
                    LEFT JOIN TA_CUSTXM C ON B.MEDX_CODE = C.CUST_CODE
                    LEFT JOIN TA_CUSTXM D ON A.CUST_CODE = D.CUST_CODE
                    LEFT JOIN TM_DEPTXM E ON TRIM(B.DEPT_CODE) = E.DEPT_CODE
                    WHERE 1=1
              AND A.BUSI_FLAG= 'B'
	       	  AND A.TAXY_MONT = P_TAXY_MONT
			  AND A.TAXX_NUMB = P_TAXX_NUMB
	        ;
	
	        rMD_SATXXH      CUR_MD_SATXXH%ROWTYPE;          /*[세금계산서 정보]*/
	
	        sSLIP_DATE      TA_SLIPXM.SLIP_DATE%TYPE;   /*발의일자*/
	        sEMPL_NUMB      TA_SLIPXM.EMPL_NUMB%TYPE;   /*입력자*/
	        sDEPT_CODE      TA_SLIPXM.DEPT_CODE%TYPE;   /*입력부서*/
	        sACCT_GUBN      TA_SLIPXM.ACCT_GUBN%TYPE;   /*사업장*/
	        sTITL_NAME      TA_SLIPXM.TITL_NAME%TYPE;   /*대표적요*/
	        nSLIP_LINE      TA_SLIPNT.SLIP_LINE%TYPE;   /*전표순번*/
	        nCURS_SEQN      TA_SLIPNT.SLIP_LINE%TYPE;   /*커서SEQ*/
			sSLIP_NUMB      TA_SLIPXM.SLIP_NUMB%TYPE;   /*전표번호*/
	
	    BEGIN
	
        /*======================================================================================
            STEP 1. 전표 생성 여부 체크
        ======================================================================================*/
	        BEGIN
	            OPEN CUR_MD_SATXXH( #TAXY_MONT#     /*계산서년월*/
	                               ,#TAXX_NUMB#     			  /*계산서번호*/
	                               );
	            FETCH CUR_MD_SATXXH INTO rMD_SATXXH;
	            
	
        /*======================================================================================
            STEP 2. 전표 생성
        ======================================================================================*/
	        /* 발의일자 :  자산등록일*/
	        sSLIP_DATE := #SLIP_DATE#;
	        /* 대표적요 구성 */
	        sTITL_NAME := rMD_SATXXH.MATT_NAME;
	         
	      /* PARAM ======================================================================================
	                       2-0. 매체 위수탁 전표 > HEADER 추가
	     ======================================================================================*/
	      
		    BEGIN
		        
			PKG_FAMIFSLIP.SP_MASTER_SAVE(#SYST_LNCD#,     	/* ●시스템언어코드*/
										 #UPDT_USID#,      						/* ●수정작업자*/
										 '10',      									/* ●회계단위 */
										 #ACCT_GUBN#,      						/* ●회계구분_사업장 */
										 sSLIP_DATE,       						/* ●전표일자(회계일자) */ 
										 #SLIP_GUBN#,      						/* ●전표유형구분 */
										 sTITL_NAME,       						/* ●제목 */
										 rMD_SATXXH.EMPL_CODE,      							/* ●사원번호  */
										 rMD_SATXXH.DEPT_CODE,	   			/* ●부서코드 */ 						 
										 #SOUS_LNKY#,              				/* ●출처연결키 */
										 NULL,
										 NULL,
										 NULL,
										 NULL,
										 NULL,
										 sSLIP_NUMB);      /* ●전표번호(생성된 전표번호 반환) */
	
		    END;
	        
        /*------------------------------------------------------------------------------------------------------------------------
            2-1.매체 위수탁 전표 > LINE 추가[차>대>차변 순서대로 SLIP_LINE저장요망]
        --------------------------------------------------------------------------------------------------------------------------*/
	            nSLIP_LINE := 0; 
	            
        /*==============================================================================================
            2-1-1. 매체 위수탁 전표 > LINE 추가 > (차변)
        ==============================================================================================*/
	        IF rMD_SATXXH.TAXX_AMTX > 0 THEN
	            
	            /*nSLIP_LINE := SLIP_LINE;*/        /*JAVA 에서 받아옴 nSLIP_LINE + 1;*/
	            nSLIP_LINE := nSLIP_LINE + 1;
	
	            BEGIN 
	            
	            PKG_FAMIFSLIP.SP_LINE_SAVE(
	                                        #SYST_LNCD#,
	                                        #UPDT_USID#,
	                                        sSLIP_NUMB,
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '10',
	                                        #ACCT_GUBN#,
	                                        rMD_SATXXH.DEBT_CODE,
	                                        rMD_SATXXH.DEPT_CODE,
	                                        '',
	                                        'D',
	                                        'KRW',
	                                        1,
	                                        rMD_SATXXH.SUMM_AMTX,
	                                        rMD_SATXXH.SUMM_AMTX,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        sTITL_NAME,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '');
	                                        
 	                END;	  
 	                
	 	      /*-------------------------------------------------------------------------------------------------------------------------
			       2-1-2. 전표라인 관리항목 세트 저장 (차변)
			   -------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.CUST_CODE      		/* ◎관리항목값1 */
					      ,NULL      /* ◎관리항목코드2 */
					      ,NULL      /* ◎관리항목값2 */
					      ,NULL      /* ◎관리항목코드3 */
					      ,NULL      /* ◎관리항목값3 */
					      ,NULL      /* ◎관리항목코드4 */
					      ,NULL      /* ◎관리항목값4 */
					      ,NULL      /* ◎관리항목코드5 */
					      ,NULL      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);

 	                END;                                      
	            
	          END IF;
	          
	              
	        /*==============================================================================================
	            2-2-1. 매체 위수탁 전표 > LINE 추가 > (대변)
	        ===============================================================================================*/
		        IF rMD_SATXXH.SUMM_AMTX > 0 THEN		        
		            nSLIP_LINE := nSLIP_LINE + 1;
		            
	                 BEGIN
	
	                 PKG_FAMIFSLIP.SP_LINE_SAVE(
	                                        #SYST_LNCD#,
	                                        #UPDT_USID#,
	                                        sSLIP_NUMB,
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        #ACCT_UNIT#,
	                                        #ACCT_GUBN#,	                                        
	                                        rMD_SATXXH.ACCT_CODE,
	                                        rMD_SATXXH.RDEP_CODE,
	                                        '',
	                                        'C',
	                                        'KRW',
	                                        1,
	                                        rMD_SATXXH.SUMM_AMTX,
	                                        rMD_SATXXH.SUMM_AMTX,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        sTITL_NAME,
	                                        '',  /*cic 임시 증빙종류인데 부가세 라인 생성시 필요함 */
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                       lpad(nSLIP_LINE , '4', '0'),
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '');
	 	                END;
	 	                
	 	                
		         /*-----------------------------------------------------------------------------------------------------------------------
			       2-2-2. 전표라인 관리항목 세트 저장 (대변)
			    --------------------------------------------------------------------------------------------------------------------------*/
	
		            	BEGIN 
			   
			            PKG_FAMIFSLIP.SP_LINERF_SAVE(
						       #SYST_LNCD# 			/* ●시스템언어코드*/
							  ,#UPDT_USID#   		/* ●수정작업자*/
						      ,sSLIP_NUMB      		/* ●전표번호 */
						      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
						      ,'0002'      /* ◎관리항목코드1 */
						      ,rMD_SATXXH.MEDX_CODE      		/* ◎관리항목값1 */
						      ,NULL      /* ◎관리항목코드2 */
						      ,NULL      /* ◎관리항목값2 */
						      ,NULL      /* ◎관리항목코드3 */
						      ,NULL      /* ◎관리항목값3 */
						      ,NULL      /* ◎관리항목코드4 */
						      ,NULL      /* ◎관리항목값4 */
						      ,NULL      /* ◎관리항목코드5 */
						      ,NULL      /* ◎관리항목값5 */
						      ,NULL      /* ◎관리항목코드6 */
						      ,NULL      /* ◎관리항목값6 */
						      ,NULL      /* ◎관리항목코드7 */
						      ,NULL      /* ◎관리항목값7 */
						      ,NULL      /* ◎관리항목코드8 */
						      ,NULL      /* ◎관리항목값8 */
						      ,NULL      /* ◎관리항목코드9 */
						      ,NULL      /* ◎관리항목값9 */
			      		);
	
	 	                END;
		       
		
		
		       END IF;
	        
	      
	       /*=============================================================
		       2-1-6. FINISH 
		    ===============================================================*/
			  IF rMD_SATXXH.TAXX_AMTX > 0 THEN
			     
				   BEGIN
				    
			         PKG_FAMIFSLIP.SP_FINISH(
					        #SYST_LNCD# /* ●시스템언어코드*/
					       ,#UPDT_USID#   /* ●수정작업자*/
						   ,sSLIP_NUMB   /* ●전표번호 */
					    );
					    
				 
	               END;
		       
		       END IF;
	       
	       /*======================================================================================
	                STEP 3. 위수탁 전표번호 업데이트
								 및 전표 테이블에 저장 
            ======================================================================================*/
            
           				UPDATE MD_SATXXH 						
							SET SACH_NUMB = sSLIP_NUMB 
							WHERE TAXY_MONT = #TAXY_MONT#
							AND TAXX_NUMB = #TAXX_NUMB#
						;
						UPDATE TA_SLIPXM 						
							SET SOUS_LNKY = sSLIP_NUMB 
							WHERE SLIP_NUMB = sSLIP_NUMB
						;
					
				CLOSE CUR_MD_SATXXH;
	
		        END;
	    END;
		]]>
	</insert>
	
	<!-- 
/*******************************************************************************
     작  성  자 : 최제현
     작  성  일 : 2016. 11. 22
     내      용 : 매체 수수료 전표처리 
********************************************************************************/
 -->
	<insert id="MACA0090.SAVE01" parameterClass="hashmap" >
		<![CDATA[
		DECLARE
	       /*MACA0090.SAVE01. 매체 수수료 전표처리*/
			CURSOR CUR_MD_SATXXH (
	             P_TAXY_MONT  IN MD_SATXXH.TAXY_MONT%TYPE   /*계산서년월*/
	            ,P_TAXX_NUMB  IN MD_SATXXH.TAXX_NUMB%TYPE   /*계산서번호*/
	        ) IS
	        	SELECT
                    A.MEDX_CODE
                    ,A.MEDX_FLAG
                    ,A.SACH_NUMB
                    ,'100' AS ACCT_GUBN
                    ,#DEPT_CODE# AS DEPT_CODE 
                    ,TRIM(#EMPL_CODE#) AS EMPL_CODE			/* 사원번호 */
                    ,CASE WHEN A.MEDX_FLAG IN ('A001','A002','A003','A00A') THEN #DEPT_CODE# 
                    WHEN TRIM(E.DEPT_NAME) IS NULL THEN #DEPT_CODE# 
                    ELSE TRIM(B.DEPT_CODE) END AS RDEP_CODE
                    ,A.MEMO_FILD
                    ,A.MEMO_FILD AS MATT_NAME
                    ,NVL(A.TAXX_AMTX,0) AS TAXX_AMTX
                    ,NVL(TRUNC(A.TAXX_VATX),0) AS TAXX_VATX
                    ,NVL(A.TAXX_AMTX,0)+NVL(TRUNC(A.TAXX_VATX),0) AS SUMM_AMTX
                    ,CASE WHEN NVL(D.CUTY_CODE,' ') = 'TS100010' THEN '1111611' ELSE '1111612' END  AS DEBT_CODE   /* 차변계정 */
                    ,CASE WHEN NVL(D.CUTY_CODE,' ') = 'TS100010' THEN '5110010' ELSE '5110020' END  AS ACCT_CODE   /* 대변계정 */
                    ,'2221100'	ACC2_CODE /* 대변계정 */
                    ,CASE WHEN NVL(SUBSTR(A.DTIX_TYPE,1,2),' ') IN ('01','02') THEN 'FA180010' ELSE 'FA180020' END AS DTIX_TYPE
					,CASE WHEN NVL(SUBSTR(A.DTIX_TYPE,3,2),' ') IN ('02','05') THEN 'FA210020' ELSE 'FA210010' END AS DTIY_TYPE
					,DECODE(C.BIZR_NUMB,null,C.RERN_NUMB,C.BIZR_NUMB) AS METX_CUNM
                    FROM MD_SATXXH A
                    LEFT JOIN MD_SATXXD B ON A.TAXY_MONT = B.TAXY_MONT AND A.TAXX_NUMB = B.TAXX_NUMB 
                    AND B.TAXX_IDXX='1'
                    LEFT JOIN TA_CUSTXM C ON A.MEDX_CODE = C.CUST_CODE
                    LEFT JOIN TA_CUSTXM D ON A.CUST_CODE = D.CUST_CODE
                    LEFT JOIN TM_DEPTXM E ON TRIM(B.DEPT_CODE) = E.DEPT_CODE
                    WHERE 1=1
              AND A.BUSI_FLAG= 'A'
	       	  AND A.TAXY_MONT = P_TAXY_MONT
			  AND A.TAXX_NUMB = P_TAXX_NUMB
	        ;
	
	        rMD_SATXXH      CUR_MD_SATXXH%ROWTYPE;          /*[세금계산서 정보]*/
	
	        sSLIP_DATE      TA_SLIPXM.SLIP_DATE%TYPE;   /*발의일자*/
	        sEMPL_NUMB      TA_SLIPXM.EMPL_NUMB%TYPE;   /*입력자*/
	        sDEPT_CODE      TA_SLIPXM.DEPT_CODE%TYPE;   /*입력부서*/
	        sACCT_GUBN      TA_SLIPXM.ACCT_GUBN%TYPE;   /*사업장*/
	        sTITL_NAME      TA_SLIPXM.TITL_NAME%TYPE;   /*대표적요*/
	        nSLIP_LINE      TA_SLIPNT.SLIP_LINE%TYPE;   /*전표순번*/
	
	        nCURS_SEQN      TA_SLIPNT.SLIP_LINE%TYPE;   /*커서SEQ*/
	        
			sSLIP_NUMB      TA_SLIPXM.SLIP_NUMB%TYPE;   /*전표번호*/
	
	    BEGIN
	
        /*======================================================================================
            STEP 1. 전표 생성 여부 체크
        ======================================================================================*/
	        BEGIN
	            OPEN CUR_MD_SATXXH( #TAXY_MONT#     /*계산서년월*/
	                               ,#TAXX_NUMB#     			  /*계산서번호*/
	                               );
	            FETCH CUR_MD_SATXXH INTO rMD_SATXXH;
	           
        /*======================================================================================
            STEP 2. 전표 생성
        ======================================================================================*/
	
	        /* 발의일자 :  자산등록일*/
	        sSLIP_DATE := #SLIP_DATE#;

	        /* 대표적요 구성 */
	        sTITL_NAME := rMD_SATXXH.MATT_NAME;
			
	         
         /* PARAM ======================================================================================
           2-0. 매체 위수탁 전표 > HEADER 추가
     	==============================================================================================*/
	      
		    BEGIN
		        
			PKG_FAMIFSLIP.SP_MASTER_SAVE(#SYST_LNCD#,     	/* ●시스템언어코드*/
										 #UPDT_USID#,      						/* ●수정작업자*/
										 '10',      									/* ●회계단위 */
										 #ACCT_GUBN#,      						/* ●회계구분_사업장 */
										 sSLIP_DATE,       						/* ●전표일자(회계일자) */ 
										 #SLIP_GUBN#,      						/* ●전표유형구분 */
										 sTITL_NAME,       						/* ●제목 */
										 rMD_SATXXH.EMPL_CODE,      							/* ●사원번호  */
										 rMD_SATXXH.DEPT_CODE,	   			/* ●부서코드 */ 						 
										 #SOUS_LNKY#,              				/* ●출처연결키 */
										 NULL,
										 NULL,
										 NULL,
										 NULL,
										 NULL,
										 sSLIP_NUMB);      /* ●전표번호(생성된 전표번호 반환) */

	        END;
	        
	        /*--------------------------------------------------------------
	            2-1.매체 위수탁 전표 > LINE 추가[차>대>차변 순서대로 SLIP_LINE저장요망]
	        --------------------------------------------------------------*/
	            nSLIP_LINE := 0; 
	            
            /*======================================================================================
	            2-1-1. 매체 위수탁 전표 > LINE 추가 > (차변)
	        ======================================================================================*/
	        IF rMD_SATXXH.TAXX_AMTX > 0 THEN
	            /*nSLIP_LINE := SLIP_LINE;*/        /*JAVA 에서 받아옴 nSLIP_LINE + 1;*/
	            nSLIP_LINE := nSLIP_LINE + 1;
	
	            BEGIN 
	            
	            PKG_FAMIFSLIP.SP_LINE_SAVE(
	                                        #SYST_LNCD#,
	                                        #UPDT_USID#,
	                                        sSLIP_NUMB,
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '10',
	                                        #ACCT_GUBN#,
	                                        rMD_SATXXH.DEBT_CODE,
	                                        rMD_SATXXH.RDEP_CODE,
	                                        '',
	                                        'D',
	                                        'KRW',
	                                        1,
	                                        rMD_SATXXH.SUMM_AMTX,
	                                        rMD_SATXXH.SUMM_AMTX,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        sTITL_NAME,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '');
	                                        
 	                END;	    
 	                
 	        /*----------------------------------------------------------------------------------------------------------------------------
		       2-1-2. 전표라인 관리항목 세트 저장(차변)
		    ----------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.MEDX_CODE      		/* ◎관리항목값1 */
					      ,NULL      /* ◎관리항목코드2 */
					      ,NULL      /* ◎관리항목값2 */
					      ,NULL      /* ◎관리항목코드3 */
					      ,NULL      /* ◎관리항목값3 */
					      ,NULL      /* ◎관리항목코드4 */
					      ,NULL      /* ◎관리항목값4 */
					      ,NULL      /* ◎관리항목코드5 */
					      ,NULL      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);
		      		
 	                END;                                   
	            
	          END IF;
	          
	              
	        /*=================================================================================================
	            2-2-1. 매체 위수탁 전표 > LINE 추가 > (대변: 대행료수입)
	        ===================================================================================================*/
	        	IF rMD_SATXXH.SUMM_AMTX > 0 THEN		        
	            	nSLIP_LINE := nSLIP_LINE + 1;
	            
	                 BEGIN
	
	                 PKG_FAMIFSLIP.SP_LINE_SAVE(
	                                        #SYST_LNCD#,
	                                        #UPDT_USID#,
	                                        sSLIP_NUMB,
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        #ACCT_UNIT#,
	                                        #ACCT_GUBN#,	                                        
	                                        rMD_SATXXH.ACCT_CODE,
	                                        rMD_SATXXH.RDEP_CODE,
	                                        '',
	                                        'C',
	                                        'KRW',
	                                        1,
	                                        rMD_SATXXH.TAXX_AMTX,
	                                        rMD_SATXXH.TAXX_AMTX,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        sTITL_NAME,
	                                        '',  /*cic 임시 증빙종류인데 부가세 라인 생성시 필요함 */
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                       lpad(nSLIP_LINE , '4', '0'),
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '');
	                                        
 	                END;
 	                
 	                
	         /*----------------------------------------------------------------------------------------------------------------------------
		       2-2-2. 전표라인 관리항목 세트 저장
		    ----------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.MEDX_CODE      		/* ◎관리항목값1 */
					      ,NULL      /* ◎관리항목코드2 */
					      ,NULL      /* ◎관리항목값2 */
					      ,NULL      /* ◎관리항목코드3 */
					      ,NULL      /* ◎관리항목값3 */
					      ,NULL      /* ◎관리항목코드4 */
					      ,NULL      /* ◎관리항목값4 */
					      ,NULL      /* ◎관리항목코드5 */
					      ,NULL      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);
		      		
 	                END;
	       
			END IF;
	       
	        
	       
	    
         /*=================================================================================================
            2-3-1. 자산등록 전표 > LINE 추가 > 매출세액(대변: 매출세액)
        =================================================================================================*/
	        IF rMD_SATXXH.TAXX_VATX > 0 THEN
	            nSLIP_LINE := nSLIP_LINE + 1;
	            sTITL_NAME := sTITL_NAME || 'VAT';
	            
	              BEGIN
	              
	              PKG_FAMIFSLIP.SP_LINE_SAVE(
	                                        #SYST_LNCD#,
	                                        #UPDT_USID#,
	                                        sSLIP_NUMB,
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        #ACCT_UNIT#,
	                                        #ACCT_GUBN#,
	                                        '3221100',
	                                        rMD_SATXXH.RDEP_CODE,
	                                        '',
	                                        'C',
	                                        'KRW',
	                                        1,
	                                        rMD_SATXXH.TAXX_VATX,
	                                        rMD_SATXXH.TAXX_VATX,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        sTITL_NAME,
	                                        rMD_SATXXH.DTIX_TYPE,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '');
	                                        
	                                       
 	                END;	    
 	                
 	           /*--------------------------------------------------------------------------------------------------------------------------
		       2-3-2. 전표라인 관리항목 세트 저장
		    --------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.MEDX_CODE      		/* ◎관리항목값1 */
					      ,'0056'      /* ◎관리항목코드2 */
					      ,rMD_SATXXH.ACCT_CODE      /* ◎관리항목값2 */
					      ,'0011'      /* ◎관리항목코드3 */
					      ,rMD_SATXXH.METX_CUNM      /* ◎관리항목값3 */
					      ,'0049'      /* ◎관리항목코드4 */
					      ,rMD_SATXXH.TAXX_AMTX      /* ◎관리항목값4 */
					      ,'0067'      /* ◎관리항목코드5 */
					      ,'A'      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);
		      		
 	                END;   
 	                                         
	
	       END IF;
	       
	       /*=============================================================
		       2-4-1. 부가세 저장
		    ===============================================================*/
		   IF rMD_SATXXH.TAXX_VATX > 0 THEN
		     
		            BEGIN 
		       
		            PKG_FAMIFSLIP.SP_LINEVAT_SAVE(
								          #SYST_LNCD#,   /* ●시스템언어코드*/
						                  #UPDT_USID#,   /* ●수정작업자*/
						                  sSLIP_NUMB,    /* ●전표번호 */
						                  lpad(nSLIP_LINE , '4', '0'),    /* ●전표라인번호 */
						      			  '',            /* ◎카드번호 */
						      			  '',            /* ◎카드승인번호 */
						                  sSLIP_DATE,   /* ●전송일(계산서발행일/카드승인일) */
						                  'FA200020',    /* ●매입매출구분[VATX_GUBN] */
						                  rMD_SATXXH.DTIY_TYPE,    /* ●부가세종류[VATX_TYPE] */
						                  '',   /* ◎부가세유형[PURC_GUBN] */
						                  '',         /* ◎불공제구분[BULG_GUBN] */
									      1,         /* ◎전자발행여부(1.Yes,0.No) */
									      rMD_SATXXH.MEDX_CODE,        /* ●거래처코드 */
									      rMD_SATXXH.MATT_NAME,          /* ●품목명 */
									      rMD_SATXXH.TAXX_AMTX,      /* ●공급가액 */
									      rMD_SATXXH.TAXX_VATX,      /* ●부가세액 */
									      rMD_SATXXH.TAXX_AMTX + rMD_SATXXH.TAXX_VATX,     /* ●합계금액 */
									      rMD_SATXXH.MEMO_FILD,          /* ●적요 */
									      0,             /* ◎타사이트발행여부(1.Yes,0.No) */
									      '',            /* ◎미사용여분인수1 */
									      ''             /* ◎미사용여분인수2 */		                                
		                               );
        
	       
	                
 	                END;
	       
	       END IF;     
	       
	      
	        
	      
	       /*=============================================================
		       2-5-1. FINISH 
		    ===============================================================*/
		  IF rMD_SATXXH.TAXX_AMTX > 0 THEN
		     
				   BEGIN
				    
			         PKG_FAMIFSLIP.SP_FINISH(
					        #SYST_LNCD# /* ●시스템언어코드*/
					       ,#UPDT_USID#   /* ●수정작업자*/
						   ,sSLIP_NUMB   /* ●전표번호 */
					    );

 	               END;
	       
	       END IF;
	       
	      /*======================================================================================
	                STEP 3. 수수료 전표번호 업데이트
								 및 전표 테이블에 저장 
            ======================================================================================*/
            
           				 UPDATE MD_SATXXH 						
						SET SACH_NUMB = sSLIP_NUMB 
						WHERE TAXY_MONT = #TAXY_MONT#
						AND TAXX_NUMB = #TAXX_NUMB#
					;
						UPDATE TA_SLIPXM 						
						SET SOUS_LNKY = sSLIP_NUMB 
						WHERE SLIP_NUMB = sSLIP_NUMB
					;

			CLOSE CUR_MD_SATXXH;
	
	        END;
	    END;
		]]>
	</insert>
	
	<!-- 
/*******************************************************************************
     작  성  자 : 최제현
     작  성  일 : 2016. 11. 22
     내      용 : 매체 위수탁 전표합산처리 
********************************************************************************/
 -->
	<insert id="MACA0090.SAVE10" parameterClass="hashmap" >
		<![CDATA[
		DECLARE
	       /*MACA0090.SAVE10. 매체 위수탁 전표합산처리*/
			CURSOR CUR_MD_SATXXH (
	             P_TAXY_MONT  IN MD_SATXXH.TAXY_MONT%TYPE   /*계산서년월*/
	            $FIRST_CURSOR$   /*계산서번호*/
	        ) IS
	        	SELECT
	        		ROW_NUMBER() OVER (ORDER BY TO_NUMBER(G.CUST_SEQX),TO_NUMBER(H.MEDF_SEQX),TO_NUMBER(I.MEDX_SEQX),TO_NUMBER(A.TAXY_MONT),TO_NUMBER(A.TAXX_NUMB))  SEQX_NUMB
	        		,A.CUST_CODE
	        		,A.MEDX_FLAG
                    ,A.MEDX_CODE
                    ,A.SACH_NUMB
                    ,'100' AS ACCT_GUBN
                    ,#DEPT_CODE# AS DEPT_CODE 
                    ,TRIM(#EMPL_CODE#) AS EMPL_CODE			/* 사원번호 */
                    ,CASE WHEN A.MEDX_FLAG IN ('A001','A002','A003','A00A') THEN #DEPT_CODE# 
                    WHEN TRIM(E.DEPT_NAME) IS NULL THEN #DEPT_CODE# 
                    ELSE TRIM(B.DEPT_CODE) END AS RDEP_CODE
                    ,A.MEMO_FILD
                    ,A.MEMO_FILD AS MATT_NAME
                    ,NVL(A.TAXX_AMTX,0) AS TAXX_AMTX
                    ,NVL(TRUNC(A.TAXX_VATX),0) AS TAXX_VATX
                    ,NVL(A.TAXX_AMTX,0)+NVL(TRUNC(A.TAXX_VATX),0) AS SUMM_AMTX
                    ,(SELECT SUM(SUMM_AMTX) FROM MD_SATXXH 
                    WHERE TAXY_MONT = P_TAXY_MONT AND TAXX_NUMB IN ($SECOND_CURSOR$) AND CUST_CODE=A.CUST_CODE) AS SUM_SUMM_AMTX
                    ,ROW_NUMBER() OVER (PARTITION BY TO_NUMBER(A.CUST_CODE) ORDER BY TO_NUMBER(G.CUST_SEQX),TO_NUMBER(H.MEDF_SEQX),TO_NUMBER(I.MEDX_SEQX),TO_NUMBER(A.TAXY_MONT),TO_NUMBER(A.TAXX_NUMB))
                     AS SUM_SEQX_NUMB
                    ,CASE WHEN NVL(D.CUTY_CODE,' ') = 'TS100010' THEN '1112310' ELSE '1112320' END  AS DEBT_CODE   /* 차변계정 */
                    ,CASE WHEN NVL(D.CUTY_CODE,' ') = 'TS100010' THEN '3151100' ELSE '3151200' END  AS ACCT_CODE   /* 대변계정 */
                    FROM MD_SATXXH A
                   LEFT JOIN MD_SATXXD B ON A.TAXY_MONT = B.TAXY_MONT AND A.TAXX_NUMB = B.TAXX_NUMB 
                    AND B.TAXX_IDXX='1'
                    LEFT JOIN TA_CUSTXM C ON B.MEDX_CODE = C.CUST_CODE
                    LEFT JOIN TA_CUSTXM D ON A.CUST_CODE = D.CUST_CODE
                    LEFT JOIN TM_DEPTXM E ON TRIM(B.DEPT_CODE) = E.DEPT_CODE
                    LEFT JOIN MD_SEQXXM G ON A.TAXY_MONT = G.TAXY_MONT AND A.CUST_CODE = G.CUST_CODE 
		            LEFT JOIN MD_SEQXXM H ON A.TAXY_MONT = H.TAXY_MONT AND A.MEDX_FLAG = H.MEDX_FLAG 
		            LEFT JOIN MD_SEQXXM I ON A.TAXY_MONT = I.TAXY_MONT AND A.MEDX_CODE = I.MEDX_CODE 
                    WHERE 1=1
              AND A.BUSI_FLAG= 'B'
	       	  AND A.TAXY_MONT = P_TAXY_MONT
	       	  AND A.TAXX_NUMB IN ($SECOND_CURSOR$)
	       	  ORDER BY SEQX_NUMB
	        ;
	
	        rMD_SATXXH      CUR_MD_SATXXH%ROWTYPE;          /*[세금계산서 정보]*/
	
	        sSLIP_DATE      TA_SLIPXM.SLIP_DATE%TYPE;   /*발의일자*/
	        sEMPL_NUMB      TA_SLIPXM.EMPL_NUMB%TYPE;   /*입력자*/
	        sDEPT_CODE      TA_SLIPXM.DEPT_CODE%TYPE;   /*입력부서*/
	        sACCT_GUBN      TA_SLIPXM.ACCT_GUBN%TYPE;   /*사업장*/
	        sTITL_NAME      TA_SLIPXM.TITL_NAME%TYPE;   /*대표적요*/
	        nSLIP_LINE      TA_SLIPNT.SLIP_LINE%TYPE;   /*전표순번*/
	
	        nCURS_SEQN      TA_SLIPNT.SLIP_LINE%TYPE;   /*커서SEQ*/
	        
			sSLIP_NUMB      TA_SLIPXM.SLIP_NUMB%TYPE;   /*전표번호*/
	
	    BEGIN
	
        /*======================================================================================
            STEP 1. 전표 생성 여부 체크
        ======================================================================================*/
	        BEGIN
	            OPEN CUR_MD_SATXXH( #TAXY_MONT#     /*계산서년월*/
	                               $THIRD_CURSOR$     			  /*계산서번호*/
	                               );
	      	/***********루프시작**********************************************************************/
	            LOOP
	            FETCH CUR_MD_SATXXH INTO rMD_SATXXH;
	         /* FETCH될 ROW가 없으면 빠져나감 */
	            EXIT WHEN CUR_MD_SATXXH%NOTFOUND;

	
        /*======================================================================================
            STEP 2. 전표 생성
        ======================================================================================*/
	
	        /* 발의일자 :  자산등록일*/
	        sSLIP_DATE := #SLIP_DATE#;
	
	        /* 대표적요 구성 */
	        sTITL_NAME :=  rMD_SATXXH.MATT_NAME;
	         
	       /* PARAM ======================================================================================
	            2-0. 매체 위수탁 전표 > HEADER 추가
	      ==============================================================================================*/
		/* 헤더는 합산시 1번만 저장. */
		IF  rMD_SATXXH.SEQX_NUMB = 1 THEN 
	            nSLIP_LINE := 0;
	           /* IF nSLIP_LINE = 0 THEN  */
			
		    BEGIN
			PKG_FAMIFSLIP.SP_MASTER_SAVE(#SYST_LNCD#,     	/* ●시스템언어코드*/
									 #UPDT_USID#,      						/* ●수정작업자*/
									 '10',      									/* ●회계단위 */
									 #ACCT_GUBN#,      						/* ●회계구분_사업장 */
									 sSLIP_DATE,       						/* ●전표일자(회계일자) */ 
									 #SLIP_GUBN#,      						/* ●전표유형구분 */
									 sTITL_NAME,       						/* ●제목 */
									 rMD_SATXXH.EMPL_CODE,      							/* ●사원번호  */
									 rMD_SATXXH.DEPT_CODE,	   			/* ●부서코드 */ 						 
									 #SOUS_LNKY#,              				/* ●출처연결키 */
									 NULL,
									 NULL,
									 NULL,
									 NULL,
									 NULL,
									 sSLIP_NUMB);      /* ●전표번호(생성된 전표번호 반환) */
	    	END;
	   END IF; 
   			/*--------------------------------------------------------------
	            2-1.매체 위수탁 전표 > LINE 추가[차>대>차변 순서대로 SLIP_LINE저장요망]
	        --------------------------------------------------------------*/
   			
            /*======================================================================================
	            2-1-1. 매체 위수탁 전표 > LINE 추가 > (차변)
	        ======================================================================================*/

	        IF rMD_SATXXH.SUM_SEQX_NUMB = 1 THEN 
	            /*nSLIP_LINE := SLIP_LINE;*/        /*JAVA 에서 받아옴 nSLIP_LINE + 1;*/
	            nSLIP_LINE := nSLIP_LINE + 1;
	
	            BEGIN 
	            
	            PKG_FAMIFSLIP.SP_LINE_SAVE(
	                                        #SYST_LNCD#,
	                                        #UPDT_USID#,
	                                        sSLIP_NUMB,
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '10',
	                                        #ACCT_GUBN#,
	                                        rMD_SATXXH.DEBT_CODE,
	                                        rMD_SATXXH.DEPT_CODE,
	                                        '',
	                                        'D',
	                                        'KRW',
	                                        1,
	                                        rMD_SATXXH.SUM_SUMM_AMTX,
	                                        rMD_SATXXH.SUM_SUMM_AMTX,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        sTITL_NAME,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '');
	                                        
 	                END;	 

 	                
 	        /*----------------------------------------------------------------------------------------------------------------------------
		       2-1-2. 전표라인 관리항목 세트 저장(차변)
		    ----------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.CUST_CODE      		/* ◎관리항목값1 */
					      ,NULL      /* ◎관리항목코드2 */
					      ,NULL      /* ◎관리항목값2 */
					      ,NULL      /* ◎관리항목코드3 */
					      ,NULL      /* ◎관리항목값3 */
					      ,NULL      /* ◎관리항목코드4 */
					      ,NULL      /* ◎관리항목값4 */
					      ,NULL      /* ◎관리항목코드5 */
					      ,NULL      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);

 	                END;                                       
	            
	          END IF;

	        /*=============================================================
	            2-2-1. 매체 위수탁 전표 > LINE 추가 > (대변)
	        ===============================================================*/
	        IF rMD_SATXXH.SUMM_AMTX > 0 THEN		        
	            nSLIP_LINE := nSLIP_LINE + 1;
	            
                 BEGIN

                 PKG_FAMIFSLIP.SP_LINE_SAVE(
                                        #SYST_LNCD#,
                                        #UPDT_USID#,
                                        sSLIP_NUMB,
                                        lpad(nSLIP_LINE , '4', '0'),
                                        #ACCT_UNIT#,
                                        #ACCT_GUBN#,	                                        
                                        rMD_SATXXH.ACCT_CODE,
                                        rMD_SATXXH.RDEP_CODE,
                                        '',
                                        'C',
                                        'KRW',
                                        1,
                                        rMD_SATXXH.SUMM_AMTX,
                                        rMD_SATXXH.SUMM_AMTX,
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        sTITL_NAME,
                                        '',  /*cic 임시 증빙종류인데 부가세 라인 생성시 필요함 */
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                       lpad(nSLIP_LINE , '4', '0'),
                                        '',
                                        '',
                                        '',
                                        '',
                                        '');

 	                END;
 	                
 	                
	         /*----------------------------------------------------------------------------------------------------------------------------
		       2-2-2. 전표라인 관리항목 세트 저장(대변)
		    ----------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.MEDX_CODE      		/* ◎관리항목값1 */
					      ,NULL      /* ◎관리항목코드2 */
					      ,NULL      /* ◎관리항목값2 */
					      ,NULL      /* ◎관리항목코드3 */
					      ,NULL      /* ◎관리항목값3 */
					      ,NULL      /* ◎관리항목코드4 */
					      ,NULL      /* ◎관리항목값4 */
					      ,NULL      /* ◎관리항목코드5 */
					      ,NULL      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);

 	                END;
	       END IF;
        /************LOOP의 끝, CURSOR 종료*******************************************************************/
        END LOOP;	
		CLOSE CUR_MD_SATXXH;
		END;
	      
	       /*=============================================================
		       2-3-1. FINISH 
		    ===============================================================*/
		  IF rMD_SATXXH.TAXX_AMTX > 0 THEN
		     
				   BEGIN
				    
			         PKG_FAMIFSLIP.SP_FINISH(
					        #SYST_LNCD# /* ●시스템언어코드*/
					       ,#UPDT_USID#   /* ●수정작업자*/
						   ,sSLIP_NUMB   /* ●전표번호 */
					    );
					    
				 
 	               END;
	       
	       END IF;
	       
	       /*======================================================================================
	                STEP 3. 위수탁 전표번호 업데이트
								 및 전표 테이블에 저장 
            ======================================================================================*/
            
           				 UPDATE MD_SATXXH 						
							SET SACH_NUMB = sSLIP_NUMB 
							WHERE TAXY_MONT = #TAXY_MONT#
							AND TAXX_NUMB IN ($UPDATESATX$)
					;
						UPDATE TA_SLIPXM 						
							SET SOUS_LNKY = sSLIP_NUMB 
							WHERE SLIP_NUMB = sSLIP_NUMB
					;
	        
					
	    END;
		]]>
	</insert>
	
	<!-- 
/*******************************************************************************
     작  성  자 : 최제현
     작  성  일 : 2016. 11. 22
     내      용 : 매체 수수료 전표합산처리 
********************************************************************************/
 -->
	<insert id="MACA0090.SAVE11" parameterClass="hashmap" >
		<![CDATA[
		DECLARE
	       /*MACA0090.SAVE01. 매체 수수료 전표처리*/
			CURSOR CUR_MD_SATXXH (
	             P_TAXY_MONT  IN MD_SATXXH.TAXY_MONT%TYPE   /*계산서년월*/
	            $FIRST_CURSOR$   /*계산서번호*/
	        ) IS
	        	SELECT
	        	    ROW_NUMBER() OVER (ORDER BY TO_NUMBER(G.CUST_SEQX),TO_NUMBER(H.MEDF_SEQX),TO_NUMBER(I.MEDX_SEQX),TO_NUMBER(A.TAXY_MONT),TO_NUMBER(A.TAXX_NUMB))  SEQX_NUMB
                    ,A.CUST_CODE
                    ,A.MEDX_CODE
                    ,A.MEDX_FLAG
                    ,A.SACH_NUMB
                    ,'100' AS ACCT_GUBN
                    ,#DEPT_CODE# AS DEPT_CODE 
                    ,TRIM(#EMPL_CODE#) AS EMPL_CODE			/* 사원번호 */
                    ,CASE WHEN A.MEDX_FLAG IN ('A001','A002','A003','A00A') THEN #DEPT_CODE# 
                    WHEN TRIM(E.DEPT_NAME) IS NULL THEN #DEPT_CODE# 
                    ELSE TRIM(B.DEPT_CODE) END AS RDEP_CODE
                    ,A.MEMO_FILD
                    ,A.MEMO_FILD AS MATT_NAME
                    ,NVL(A.TAXX_AMTX,0) AS TAXX_AMTX
                    ,NVL(TRUNC(A.TAXX_VATX),0) AS TAXX_VATX
					,NVL(A.TAXX_AMTX,0)+NVL(TRUNC(A.TAXX_VATX),0) AS SUMM_AMTX
                    ,CASE WHEN NVL(D.CUTY_CODE,' ') = 'TS100010' THEN '1111611' ELSE '1111612' END  AS DEBT_CODE   /* 차변계정 */
                    ,CASE WHEN NVL(D.CUTY_CODE,' ') = 'TS100010' THEN '5110010' ELSE '5110020' END  AS ACCT_CODE   /* 대변계정 */
                    ,'2221100'	ACC2_CODE /* 대변계정 */
                    ,CASE WHEN NVL(SUBSTR(A.DTIX_TYPE,1,2),' ') IN ('01','02') THEN 'FA180010' ELSE 'FA180020' END AS DTIX_TYPE
					,CASE WHEN NVL(SUBSTR(A.DTIX_TYPE,3,2),' ') IN ('02','05') THEN 'FA210020' ELSE 'FA210010' END AS DTIY_TYPE
					,DECODE(C.BIZR_NUMB,null,C.RERN_NUMB,C.BIZR_NUMB) AS METX_CUNM
                    FROM MD_SATXXH A
                    LEFT JOIN MD_SATXXD B ON A.TAXY_MONT = B.TAXY_MONT AND A.TAXX_NUMB = B.TAXX_NUMB 
                    AND B.TAXX_IDXX='1'
                    LEFT JOIN TA_CUSTXM C ON A.MEDX_CODE = C.CUST_CODE
                    LEFT JOIN TA_CUSTXM D ON A.CUST_CODE = D.CUST_CODE
                    LEFT JOIN TM_DEPTXM E ON TRIM(B.DEPT_CODE) = E.DEPT_CODE
                    LEFT JOIN MD_SEQXXM G ON A.TAXY_MONT = G.TAXY_MONT AND A.CUST_CODE = G.CUST_CODE 
		            LEFT JOIN MD_SEQXXM H ON A.TAXY_MONT = H.TAXY_MONT AND A.MEDX_FLAG = H.MEDX_FLAG 
		            LEFT JOIN MD_SEQXXM I ON A.TAXY_MONT = I.TAXY_MONT AND A.MEDX_CODE = I.MEDX_CODE 
                    WHERE 1=1
              AND A.BUSI_FLAG= 'A'
	       	  AND A.TAXY_MONT = P_TAXY_MONT
			  AND A.TAXX_NUMB IN ($SECOND_CURSOR$)
			  ORDER BY SEQX_NUMB
	        ;
	
	        rMD_SATXXH      CUR_MD_SATXXH%ROWTYPE;          /*[세금계산서 정보]*/
	
	        sSLIP_DATE      TA_SLIPXM.SLIP_DATE%TYPE;   /*발의일자*/
	        sEMPL_NUMB      TA_SLIPXM.EMPL_NUMB%TYPE;   /*입력자*/
	        sDEPT_CODE      TA_SLIPXM.DEPT_CODE%TYPE;   /*입력부서*/
	        sACCT_GUBN      TA_SLIPXM.ACCT_GUBN%TYPE;   /*사업장*/
	        sTITL_NAME      TA_SLIPXM.TITL_NAME%TYPE;   /*대표적요*/
	        nSLIP_LINE      TA_SLIPNT.SLIP_LINE%TYPE;   /*전표순번*/
	
	        nCURS_SEQN      TA_SLIPNT.SLIP_LINE%TYPE;   /*커서SEQ*/
	        
			sSLIP_NUMB      TA_SLIPXM.SLIP_NUMB%TYPE;   /*전표번호*/
		
		
	    BEGIN
	    
	
        /*======================================================================================
            STEP 1. 전표 생성 여부 체크
        ======================================================================================*/
	        BEGIN

	            OPEN CUR_MD_SATXXH( #TAXY_MONT#     /*계산서년월*/
	                               $THIRD_CURSOR$     			  /*계산서번호*/
	                               );
	     /*********루프시작**************************************************************************/
	        LOOP
	            FETCH CUR_MD_SATXXH INTO rMD_SATXXH;
	            /* FETCH할 ROW가 없으면 루프종료 */
	            EXIT WHEN CUR_MD_SATXXH%NOTFOUND;
	            
	
        /*======================================================================================
            STEP 2. 전표 생성
        ======================================================================================*/
	
	        /* 발의일자 :  자산등록일*/
	        sSLIP_DATE := #SLIP_DATE#;

	        /* 대표적요 구성 */
	        sTITL_NAME := rMD_SATXXH.MATT_NAME;

	    /* PARAM ======================================================================================
	            2-0. 매체 위수탁 전표 > HEADER 추가
	      ======================================================================================*/
     /* 헤더는 한 번만 실행. */
     IF  rMD_SATXXH.SEQX_NUMB = 1 THEN 
	     
            nSLIP_LINE := 0; 
		    
		    BEGIN
		        
			PKG_FAMIFSLIP.SP_MASTER_SAVE(#SYST_LNCD#,     	/* ●시스템언어코드*/
										 #UPDT_USID#,      						/* ●수정작업자*/
										 '10',      									/* ●회계단위 */
										 #ACCT_GUBN#,      						/* ●회계구분_사업장 */
										 sSLIP_DATE,       						/* ●전표일자(회계일자) */ 
										 #SLIP_GUBN#,      						/* ●전표유형구분 */
										 sTITL_NAME,       						/* ●제목 */
										 rMD_SATXXH.EMPL_CODE,      							/* ●사원번호  */
										 rMD_SATXXH.DEPT_CODE,	   			/* ●부서코드 */ 						 
										 #SOUS_LNKY#,              				/* ●출처연결키 */
										 NULL,
										 NULL,
										 NULL,
										 NULL,
										 NULL,
										 sSLIP_NUMB);      /* ●전표번호(생성된 전표번호 반환) */

	        END;
	    END IF;
		    /*--------------------------------------------------------------
	            2-1.매체 위수탁 전표 > LINE 추가[차>대>차변 순서대로 SLIP_LINE저장요망]
	        --------------------------------------------------------------*/
            /*======================================================================================
	            2-1-1. 매체 위수탁 전표 > LINE 추가 > (차변)
	        ======================================================================================*/
	        IF rMD_SATXXH.TAXX_AMTX > 0 THEN 
	            /*nSLIP_LINE := SLIP_LINE;*/        /*JAVA 에서 받아옴 nSLIP_LINE + 1;*/
	            nSLIP_LINE := nSLIP_LINE + 1;
	
	            BEGIN 
	            
	            PKG_FAMIFSLIP.SP_LINE_SAVE(
	                                        #SYST_LNCD#,
	                                        #UPDT_USID#,
	                                        sSLIP_NUMB,
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '10',
	                                        #ACCT_GUBN#,
	                                        rMD_SATXXH.DEBT_CODE,
	                                        rMD_SATXXH.RDEP_CODE,
	                                        '',
	                                        'D',
	                                        'KRW',
	                                        1,
	                                        rMD_SATXXH.SUMM_AMTX,
	                                        rMD_SATXXH.SUMM_AMTX,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        sTITL_NAME,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '');
	                                        
 	                END;	    
 	                
 	         /*----------------------------------------------------------------------------------------------------------------------------
		       2-1-2. 전표라인 관리항목 세트 저장(차변)
		    ----------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.MEDX_CODE      		/* ◎관리항목값1 */
					      ,NULL      /* ◎관리항목코드2 */
					      ,NULL      /* ◎관리항목값2 */
					      ,NULL      /* ◎관리항목코드3 */
					      ,NULL      /* ◎관리항목값3 */
					      ,NULL      /* ◎관리항목코드4 */
					      ,NULL      /* ◎관리항목값4 */
					      ,NULL      /* ◎관리항목코드5 */
					      ,NULL      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);
		      		
 	                END;                                   
	            
	          END IF;
	          
	              
	        /*=======================================================================================
	            2-2-1. 매체 위수탁 전표 > LINE 추가 > (대변)
	        ========================================================================================*/
	        IF rMD_SATXXH.SUMM_AMTX > 0 THEN		        
	            nSLIP_LINE := nSLIP_LINE + 1;
	            
                 BEGIN

                 PKG_FAMIFSLIP.SP_LINE_SAVE(
                                        #SYST_LNCD#,
                                        #UPDT_USID#,
                                        sSLIP_NUMB,
                                        lpad(nSLIP_LINE , '4', '0'),
                                        #ACCT_UNIT#,
                                        #ACCT_GUBN#,	                                        
                                        rMD_SATXXH.ACCT_CODE,
                                        rMD_SATXXH.RDEP_CODE,
                                        '',
                                        'C',
                                        'KRW',
                                        1,
                                        rMD_SATXXH.TAXX_AMTX,
                                        rMD_SATXXH.TAXX_AMTX,
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                        sTITL_NAME,
                                        '',  /*cic 임시 증빙종류인데 부가세 라인 생성시 필요함 */
                                        '',
                                        '',
                                        '',
                                        '',
                                        '',
                                       lpad(nSLIP_LINE , '4', '0'),
                                        '',
                                        '',
                                        '',
                                        '',
                                        '');
	                                        
 	                END;
 	                
 	                
	         /*----------------------------------------------------------------------------------------------------------------------------
		       2-2-2. 전표라인 관리항목 세트 저장
		    ----------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.MEDX_CODE      		/* ◎관리항목값1 */
					      ,NULL      /* ◎관리항목코드2 */
					      ,NULL      /* ◎관리항목값2 */
					      ,NULL      /* ◎관리항목코드3 */
					      ,NULL      /* ◎관리항목값3 */
					      ,NULL      /* ◎관리항목코드4 */
					      ,NULL      /* ◎관리항목값4 */
					      ,NULL      /* ◎관리항목코드5 */
					      ,NULL      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);
		      		
 	                END;
	       
			END IF;
	       
	        
	       
	    
         /*=============================================================
            2-3-1. 자산등록 전표 > LINE 추가 > 매출세액(대변)
        ===============================================================*/
	        IF rMD_SATXXH.TAXX_VATX > 0 THEN
	            nSLIP_LINE := nSLIP_LINE + 1;
	            sTITL_NAME := sTITL_NAME || 'VAT';
	            
	              BEGIN
	              
	              PKG_FAMIFSLIP.SP_LINE_SAVE(
	                                        #SYST_LNCD#,
	                                        #UPDT_USID#,
	                                        sSLIP_NUMB,
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        #ACCT_UNIT#,
	                                        #ACCT_GUBN#,
	                                        '3221100',
	                                        rMD_SATXXH.RDEP_CODE,
	                                        '',
	                                        'C',
	                                        'KRW',
	                                        1,
	                                        rMD_SATXXH.TAXX_VATX,
	                                        rMD_SATXXH.TAXX_VATX,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        sTITL_NAME,
	                                        rMD_SATXXH.DTIX_TYPE,
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        lpad(nSLIP_LINE , '4', '0'),
	                                        '',
	                                        '',
	                                        '',
	                                        '',
	                                        '');
	                                        
	                                       
 	                END;	    
 	                
 	         /*----------------------------------------------------------------------------------------------------------------------------
		       2-3-2. 전표라인 관리항목 세트 저장(대변)
		    ----------------------------------------------------------------------------------------------------------------------------*/

	            	BEGIN 
		   
		            PKG_FAMIFSLIP.SP_LINERF_SAVE(
					       #SYST_LNCD# 			/* ●시스템언어코드*/
						  ,#UPDT_USID#   		/* ●수정작업자*/
					      ,sSLIP_NUMB      		/* ●전표번호 */
					      ,lpad(nSLIP_LINE , '4', '0')     		/* ●전표라인번호 */
					      ,'0002'      /* ◎관리항목코드1 */
					      ,rMD_SATXXH.MEDX_CODE      		/* ◎관리항목값1 */
					      ,'0056'      /* ◎관리항목코드2 */
					      ,rMD_SATXXH.ACCT_CODE      /* ◎관리항목값2 */
					      ,'0011'      /* ◎관리항목코드3 */
					      ,rMD_SATXXH.METX_CUNM      /* ◎관리항목값3 */
					      ,'0049'      /* ◎관리항목코드4 */
					      ,rMD_SATXXH.TAXX_AMTX      /* ◎관리항목값4 */
					      ,'0067'      /* ◎관리항목코드5 */
					      ,'A'      /* ◎관리항목값5 */
					      ,NULL      /* ◎관리항목코드6 */
					      ,NULL      /* ◎관리항목값6 */
					      ,NULL      /* ◎관리항목코드7 */
					      ,NULL      /* ◎관리항목값7 */
					      ,NULL      /* ◎관리항목코드8 */
					      ,NULL      /* ◎관리항목값8 */
					      ,NULL      /* ◎관리항목코드9 */
					      ,NULL      /* ◎관리항목값9 */
		      		);
		      		
 	                END;   
 	                                         
	
	       END IF;
	       
	       /*=============================================================
		       2-1-4. 부가세 
		    ===============================================================*/
		   IF rMD_SATXXH.TAXX_VATX > 0 THEN
		     
		            BEGIN 
		       
		            PKG_FAMIFSLIP.SP_LINEVAT_SAVE(
								          #SYST_LNCD#,   /* ●시스템언어코드*/
						                  #UPDT_USID#,   /* ●수정작업자*/
						                  sSLIP_NUMB,    /* ●전표번호 */
						                  lpad(nSLIP_LINE , '4', '0'),    /* ●전표라인번호 */
						      			  '',            /* ◎카드번호 */
						      			  '',            /* ◎카드승인번호 */
						                  sSLIP_DATE,   /* ●전송일(계산서발행일/카드승인일) */
						                  'FA200020',    /* ●매입매출구분[VATX_GUBN] */
						                  rMD_SATXXH.DTIY_TYPE,    /* ●부가세종류[VATX_TYPE] */
						                  '',   /* ◎부가세유형[PURC_GUBN] */
						                  '',         /* ◎불공제구분[BULG_GUBN] */
									      1,         /* ◎전자발행여부(1.Yes,0.No) */
									      rMD_SATXXH.MEDX_CODE,        /* ●거래처코드 */
									      rMD_SATXXH.MATT_NAME,          /* ●품목명 */
									      rMD_SATXXH.TAXX_AMTX,      /* ●공급가액 */
									      rMD_SATXXH.TAXX_VATX,      /* ●부가세액 */
									      rMD_SATXXH.TAXX_AMTX + rMD_SATXXH.TAXX_VATX,     /* ●합계금액 */
									      rMD_SATXXH.MEMO_FILD,          /* ●적요 */
									      0,             /* ◎타사이트발행여부(1.Yes,0.No) */
									      '',            /* ◎미사용여분인수1 */
									      ''             /* ◎미사용여분인수2 */		                                
		                               );
 	                END;
	       
	       END IF;     
	       
	      /*****루프종료,CLOSE CURSOR********************************************************************/
	        END LOOP;
	            CLOSE CUR_MD_SATXXH;
		 	
			END;
	      
	       /*=============================================================
		       2-1-6. FINISH 
		    ===============================================================*/
		  IF rMD_SATXXH.TAXX_AMTX > 0 THEN
		     
				   BEGIN
				    
			         PKG_FAMIFSLIP.SP_FINISH(
					        #SYST_LNCD# /* ●시스템언어코드*/
					       ,#UPDT_USID#   /* ●수정작업자*/
						   ,sSLIP_NUMB   /* ●전표번호 */
					    );

 	               END;
	       
	       END IF;
	       
	      /*======================================================================================
	                STEP 3. 수수료 전표번호 업데이트
								 및 전표 테이블에 저장 
            ======================================================================================*/
            
           				 UPDATE MD_SATXXH 						
						SET SACH_NUMB = sSLIP_NUMB 
						WHERE TAXY_MONT = #TAXY_MONT#
						AND TAXX_NUMB IN ($UPDATESATX$)
					;
						UPDATE TA_SLIPXM 						
							SET SOUS_LNKY = sSLIP_NUMB 
							WHERE SLIP_NUMB = sSLIP_NUMB
						;


	    END;

	    
		]]>
	</insert>
	
	
	<!-- 
      작  성  자 : 최제현
    작  성  일 : 2016.11.23
    내      용 : 매체 위수탁 전표 삭제 
    파라미터   :  			  	
   -->
	<delete id="MACA0090.DELETE00" parameterClass="hashmap">
	<![CDATA[		
			 DECLARE
				BEGIN
			         PKG_FAMIFSLIP.SP_DELETE(
					        #SYST_LNCD# 	/* ●시스템언어코드*/
					       ,#UPDT_USID#    	/* ●수정작업자*/
						   ,#SACH_NUMB#   /* ●전표번호 */
						   ,''  						 /* ◎삭제옵션 */
					    );
			  	UPDATE MD_SATXXH   /* MACA0090.DELETE01 세금계산서에 위수탁 전표 번호삭제 */
				SET SACH_NUMB = ''
				WHERE 1=1
				AND SACH_NUMB = #SACH_NUMB#;
		       	
		       	UPDATE MD_ETMDXM
		       	SET TRCH_NUMB = ''
			WHERE TRCH_NUMB = #SACH_NUMB#;
			
				UPDATE MD_CTMDXM
		       	SET TRCH_NUMB = ''
			WHERE TRCH_NUMB = #SACH_NUMB#;
			
				UPDATE MD_PTMDXM
		       	SET TRCH_NUMB = ''
			WHERE TRCH_NUMB = #SACH_NUMB#;
			
				UPDATE MD_ITMDXM
		       	SET TRCH_NUMB = ''
			WHERE TRCH_NUMB = #SACH_NUMB#;
			
				UPDATE MD_ODMDXM
		       	SET TRCH_NUMB = ''
			WHERE TRCH_NUMB = #SACH_NUMB#;
		       	
		       	UPDATE MD_ETMDXM
		       	SET CMCH_NUMB = ''
			WHERE CMCH_NUMB = #SACH_NUMB#;
			
			UPDATE MD_CTMDXM
		       	SET CMCH_NUMB = ''
			WHERE CMCH_NUMB = #SACH_NUMB#;
			
			UPDATE MD_PTMDXM
		       	SET CMCH_NUMB = ''
			WHERE CMCH_NUMB = #SACH_NUMB#;
			
			UPDATE MD_ITMDXM
		       	SET CMCH_NUMB = ''
			WHERE CMCH_NUMB = #SACH_NUMB#;
		       	
		       	UPDATE MD_ODMDXM
		       	SET CMCH_NUMB = ''
			WHERE CMCH_NUMB = #SACH_NUMB#;
		       	END; 	
	]]>		
	</delete>
	
	<!-- 
		작  성  자 : 최제현
		작  성  일 : 2017.01.09(표준화 완료)
		내      용 : 세금계산서에 위수탁 전표 번호삭제
	-->
	<update id="MACA0090.DELETE01" parameterClass="hashmap">
	<![CDATA[
			UPDATE MD_SATXXH   /* MACA0090.DELETE01 세금계산서에 위수탁 전표 번호삭제 */
			SET SACH_NUMB = ''
			WHERE 1=1
			AND SACH_NUMB = #SACH_NUMB#
	]]>
	</update>

	<!-- 
		작  성  자 : 최제현
		작  성  일 : 2016.12.05(표준화 완료)
		내      용 : 개별청약서에 위수탁 전표 번호기입
	-->
	<update id="MACA0090.UPDATE00" parameterClass="hashmap">
		<isEqual property="MEDX_FLAG" compareValue="A00A">
			UPDATE MD_ETMDXM   /* MACA0090.UPDATE00 개별청약서에 위수탁 전표 번호기입 */
		</isEqual>
		<isLessEqual property="MEDX_FLAG" compareValue="A003">
			UPDATE MD_ETMDXM  
		</isLessEqual>
		<isEqual property="MEDX_FLAG" compareValue="A004">
			UPDATE MD_CTMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A005">
			UPDATE MD_PTMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A006">
			UPDATE MD_PTMDXM  
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A007">
			UPDATE MD_ODMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A008">
			UPDATE MD_ITMDXM   
		</isEqual>
	<![CDATA[
			SET TRCH_NUMB = (SELECT SACH_NUMB FROM MD_SATXXH 
			WHERE TAXY_NUMB=#TAXY_NUMB#) 		/*세금계산서번호*/
			WHERE TRTX_NUMB = #TAXY_NUMB#
	]]>
	</update>
	
	<!-- 
		작  성  자 : 최제현
		작  성  일 : 2016.12.05(표준화 완료)
		내      용 : 개별청약서에 수수료 전표 번호기입
	-->
	<update id="MACA0090.UPDATE01" parameterClass="hashmap">
		<isEqual property="MEDX_FLAG" compareValue="A00A">
			UPDATE MD_COMIXM   /* MACA0090.UPDATE01 개별청약서에 수수료 전표 번호기입 */
		</isEqual>
		<isLessEqual property="MEDX_FLAG" compareValue="A003">
			UPDATE MD_COMIXM  
		</isLessEqual>
		<isEqual property="MEDX_FLAG" compareValue="A004">
			UPDATE MD_CTMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A005">
			UPDATE MD_PTMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A006">
			UPDATE MD_PTMDXM  
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A007">
			UPDATE MD_ODMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A008">
			UPDATE MD_ITMDXM   
		</isEqual>
	<![CDATA[
			SET CMCH_NUMB = (SELECT SACH_NUMB FROM MD_SATXXH 
			WHERE TAXY_NUMB=#TAXY_NUMB#) 			/*세금계산서번호*/	
			WHERE CMTX_NUMB =#TAXY_NUMB#
	]]>
	</update>
	
	<!-- 
		작  성  자 : 최제현
		작  성  일 : 2016.12.05(표준화 완료)
		내      용 : 개별청약서에 위수탁 전표 번호삭제
	-->
	<update id="MACA0090.UPDATE02" parameterClass="hashmap">
		<isEqual property="MEDX_FLAG" compareValue="A00A">
			UPDATE MD_ETMDXM   /* MACA0090.UPDATE02 개별청약서에 위수탁 전표 번호삭제 */
		</isEqual>
		<isLessEqual property="MEDX_FLAG" compareValue="A003">
			UPDATE MD_ETMDXM  
		</isLessEqual>
		<isEqual property="MEDX_FLAG" compareValue="A004">
			UPDATE MD_CTMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A005">
			UPDATE MD_PTMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A006">
			UPDATE MD_PTMDXM  
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A007">
			UPDATE MD_ODMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A008">
			UPDATE MD_ITMDXM   
		</isEqual>
	<![CDATA[
			SET TRCH_NUMB = ''
			WHERE TRCH_NUMB = #SACH_NUMB#
	]]>
	</update>
	
	<!-- 
		작  성  자 : 최제현
		작  성  일 : 2016.12.05(표준화 완료)
		내      용 : 개별청약서에 전표 번호삭제
	-->
	<update id="MACA0090.UPDATE03" parameterClass="hashmap">
		<isEqual property="MEDX_FLAG" compareValue="A00A">
			UPDATE MD_COMIXM   /* MACA0090.UPDATE03 개별청약서에 수수료 전표 번호삭제 */
		</isEqual>
		<isLessEqual property="MEDX_FLAG" compareValue="A003">
			UPDATE MD_COMIXM  
		</isLessEqual>
		<isEqual property="MEDX_FLAG" compareValue="A004">
			UPDATE MD_CTMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A005">
			UPDATE MD_PTMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A006">
			UPDATE MD_PTMDXM  
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A007">
			UPDATE MD_ODMDXM   
		</isEqual>
		<isEqual property="MEDX_FLAG" compareValue="A008">
			UPDATE MD_ITMDXM   
		</isEqual>
	<![CDATA[
			SET CMCH_NUMB = ''
			WHERE CMCH_NUMB = #SACH_NUMB#
	]]>
	</update>
	
</sqlMap>